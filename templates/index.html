<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Blast</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”Š</text></svg>">
    <script>
        (function(){var t=localStorage.getItem("vb_theme");if(t)document.documentElement.setAttribute("data-theme",t);})();
    </script>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-logo-wrap">
            <div class="splash-icon">
                <div class="splash-rings">
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                </div>
                <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="g1" x1="0" y1="0" x2="64" y2="64">
                            <stop offset="0%" stop-color="#06B6D4"/>
                            <stop offset="100%" stop-color="#3B82F6"/>
                        </linearGradient>
                    </defs>
                    <rect x="2" y="2" width="60" height="60" rx="18" fill="url(#g1)"/>
                    <path d="M20 24v16l14 9V15l-14 9z" fill="#fff" opacity="0.95"/>
                    <path d="M38 25a10 10 0 010 14" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                    <path d="M42 21a16 16 0 010 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.55"/>
                    <path d="M46 17a22 22 0 010 30" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.25"/>
                </svg>
            </div>
            <div class="splash-title">Voice Blast</div>
            <div class="splash-subtitle">Voicemail Drop System</div>
            <div class="splash-bar">
                <div class="splash-bar-fill"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <div class="video-bg">
            <video autoplay muted loop playsinline preload="metadata" id="bgVideo">
                <source src="/static/videos/bg-loop-new.mp4" type="video/mp4">
            </video>
            <div class="video-overlay"></div>
        </div>
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        <div class="bg-glow bg-glow-3"></div>

        <!-- Header (Full Width) -->
        <div class="header">
            <div class="header-inner">
                <div class="header-logo">
                    <div class="header-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="g2" x1="0" y1="0" x2="64" y2="64">
                                    <stop offset="0%" stop-color="#06B6D4"/>
                                    <stop offset="100%" stop-color="#3B82F6"/>
                                </linearGradient>
                            </defs>
                            <rect x="2" y="2" width="60" height="60" rx="18" fill="url(#g2)"/>
                            <path d="M20 24v16l14 9V15l-14 9z" fill="#fff" opacity="0.95"/>
                            <path d="M38 25a10 10 0 010 14" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                            <path d="M42 21a16 16 0 010 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.55"/>
                        </svg>
                    </div>
                    <div class="header-text">
                        <h1>Voice Blast</h1>
                        <div class="header-tagline">Voicemail Drop System</div>
                    </div>
                </div>
                <div class="header-right">
                    <span class="header-status-dot"></span>
                    <span class="header-version">v1.0</span>
                    <button type="button" class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="container">

            <!-- Status Bar -->
            <div class="status-bar stagger-1" id="campaignStatus">
                <span class="dot dot-inactive"></span> No active campaign
            </div>

            <!-- Test Call -->
            <div class="card stagger-2">
                <div class="card-title">
                    <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                    Quick Test
                </div>
                <label>Enter a number to place a test call</label>
                <div class="test-call-row">
                    <input type="text" id="testNumber" class="input-phone" placeholder="+15551234567" maxlength="16">
                    <button type="button" class="btn btn-test" id="testCallBtn">Call</button>
                </div>
                <div id="testResult"></div>
            </div>

            <!-- Campaign Form -->
            <form id="campaignForm">
                <div class="form-grid stagger-3">
                    <!-- Phone Numbers -->
                    <div class="card card-accent">
                        <div class="card-title">
                            <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                            Phone Numbers
                        </div>
                        <label>Upload CSV file</label>
                        <input type="file" name="csv_file" id="csvFile" accept=".csv,.txt">
                        <label>Or paste numbers (one per line)</label>
                        <textarea name="numbers" id="numbersInput" rows="4" placeholder="+15551234567&#10;+15559876543"></textarea>
                    </div>

                    <!-- Audio -->
                    <div class="card card-accent">
                        <div class="card-title">
                            <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
                            Voicemail Audio
                        </div>
                        <label>Upload MP3/WAV</label>
                        <input type="file" name="audio_file" id="audioFile" accept=".mp3,.wav">
                        <label>Or provide public audio URL</label>
                        <input type="text" name="audio_url" id="audioUrl" placeholder="https://example.com/voicemail.mp3">
                    </div>
                </div>

                <!-- Transfer Number -->
                <div class="card stagger-4">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 014-4h12"/></svg>
                        Transfer Number
                    </div>
                    <label>If a human answers, transfer the call to</label>
                    <div class="transfer-row">
                        <div class="transfer-input-wrap">
                            <input type="text" name="transfer_number" id="transferNumber" class="input-phone" placeholder="+15551112222" maxlength="16" required>
                        </div>
                        <button type="button" class="btn-save-transfer" id="saveTransferBtn">Save for future</button>
                    </div>
                    <div class="saved-indicator" id="savedIndicator">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        Saved &mdash; auto-fills next time
                    </div>
                </div>

                <!-- Dial Mode -->
                <div class="card stagger-5">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
                        Dial Mode
                    </div>
                    <label>Choose how calls are placed</label>
                    <div class="dial-mode-toggle">
                        <button type="button" class="dial-mode-btn active" data-mode="sequential" id="modeSeq">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                            Sequential
                        </button>
                        <button type="button" class="dial-mode-btn" data-mode="simultaneous" id="modeSimul">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            Simultaneous
                        </button>
                    </div>
                    <input type="hidden" name="dial_mode" id="dialModeInput" value="sequential">
                    <div class="batch-size-wrap" id="batchSizeWrap" style="display:none;">
                        <label>Calls per batch</label>
                        <div class="batch-size-row">
                            <input type="number" name="batch_size" id="batchSize" class="input-batch" value="5" min="2" max="50">
                            <span class="batch-hint">2â€“50 calls fired at once per batch</span>
                        </div>
                    </div>
                    <div class="dial-mode-desc" id="dialModeDesc">Calls are placed one at a time, each waiting 2 seconds before the next.</div>
                </div>

                <!-- Buttons -->
                <div class="button-group stagger-6">
                    <button type="submit" class="btn btn-start" id="startBtn">Start Campaign</button>
                    <button type="button" class="btn btn-stop" id="stopBtn" disabled>Stop Campaign</button>
                </div>
            </form>

            <!-- Call Log -->
            <div class="log-section stagger-7">
                <div class="log-header">
                    <h2>
                        <svg class="log-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Call Log
                    </h2>
                    <div class="log-header-actions">
                        <span id="callCount" class="call-count">0 calls</span>
                        <button type="button" class="btn-clear-logs" id="clearLogsBtn" title="Clear all call logs">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="table-wrap">
                    <table id="callTable">
                        <thead>
                            <tr>
                                <th>Destination</th>
                                <th>Caller ID</th>
                                <th>Status</th>
                                <th>Ring</th>
                                <th>Machine?</th>
                                <th>Transferred</th>
                                <th>Voicemail</th>
                            </tr>
                        </thead>
                        <tbody id="callBody">
                            <tr><td colspan="7" class="empty-row">No calls yet</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="download-section">
                    <div class="download-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download Report
                    </div>
                    <div class="download-filters">
                        <div class="download-preset-row">
                            <button type="button" class="download-preset active" data-range="all">All Time</button>
                            <button type="button" class="download-preset" data-range="today">Today</button>
                            <button type="button" class="download-preset" data-range="week">This Week</button>
                            <button type="button" class="download-preset" data-range="month">This Month</button>
                            <button type="button" class="download-preset" data-range="custom">Custom</button>
                        </div>
                        <div class="download-custom-row" id="customDateRow" style="display:none;">
                            <div class="date-field">
                                <label>From</label>
                                <input type="datetime-local" id="reportStart" class="input-date">
                            </div>
                            <div class="date-field">
                                <label>To</label>
                                <input type="datetime-local" id="reportEnd" class="input-date">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-download" id="downloadReportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            function apiFetch(url, opts) {
                var defaults = { credentials: "include", headers: {} };
                var merged = Object.assign({}, defaults, opts || {});
                if (!merged.body || !(merged.body instanceof FormData)) {
                    merged.headers["X-Requested-With"] = "XMLHttpRequest";
                } else {
                    var h = new Headers(merged.headers || {});
                    h.set("X-Requested-With", "XMLHttpRequest");
                    merged.headers = h;
                }
                return fetch(url, merged).then(function(r) {
                    if (r.status === 401) {
                        window.location.href = "/login";
                        throw new Error("auth");
                    }
                    return r;
                });
            }

            // ---- Splash Screen ----
            setTimeout(function() {
                document.getElementById("splash").classList.add("hide");
                document.getElementById("app").classList.add("show");
            }, 2900);

            // ---- Theme Toggle ----
            var themeToggle = document.getElementById("themeToggle");
            function getCurrentTheme() {
                return document.documentElement.getAttribute("data-theme") || "dark";
            }
            themeToggle.addEventListener("click", function() {
                var next = getCurrentTheme() === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("vb_theme", next);
            });

            // ---- 3D Tilt Effect on Cards ----
            (function() {
                var tiltEls = document.querySelectorAll(".card, .log-section");
                var maxTilt = 4;
                tiltEls.forEach(function(el) {
                    el.addEventListener("mouseenter", function() {
                        el.classList.add("tilt-3d");
                    });
                    el.addEventListener("mousemove", function(e) {
                        var rect = el.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        var y = e.clientY - rect.top;
                        var midX = rect.width / 2;
                        var midY = rect.height / 2;
                        var rotY = ((x - midX) / midX) * maxTilt;
                        var rotX = -((y - midY) / midY) * maxTilt;
                        el.style.transform = "perspective(800px) rotateX(" + rotX + "deg) rotateY(" + rotY + "deg) translateZ(8px)";
                    });
                    el.addEventListener("mouseleave", function() {
                        el.classList.remove("tilt-3d");
                        el.style.transform = "";
                    });
                });
            })();

            // ---- Ripple Effect ----
            document.addEventListener("click", function(e) {
                var btn = e.target.closest(".btn, .btn-save-transfer, .btn-clear-logs");
                if (!btn || btn.disabled) return;
                var rect = btn.getBoundingClientRect();
                var ripple = document.createElement("span");
                ripple.className = "ripple";
                var size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + "px";
                ripple.style.left = (e.clientX - rect.left - size / 2) + "px";
                ripple.style.top = (e.clientY - rect.top - size / 2) + "px";
                btn.style.position = "relative";
                btn.style.overflow = "hidden";
                btn.appendChild(ripple);
                setTimeout(function() { ripple.remove(); }, 500);
            });

            // ---- Elements ----
            var form = document.getElementById("campaignForm");
            var startBtn = document.getElementById("startBtn");
            var stopBtn = document.getElementById("stopBtn");
            var callBody = document.getElementById("callBody");
            var callCount = document.getElementById("callCount");
            var campaignStatus = document.getElementById("campaignStatus");
            var testCallBtn = document.getElementById("testCallBtn");
            var testNumber = document.getElementById("testNumber");
            var testResult = document.getElementById("testResult");
            var transferNumber = document.getElementById("transferNumber");
            var saveTransferBtn = document.getElementById("saveTransferBtn");
            var savedIndicator = document.getElementById("savedIndicator");
            var clearLogsBtn = document.getElementById("clearLogsBtn");

            // ---- Load Saved Transfer Number ----
            var saved = localStorage.getItem("vb_transfer_number");
            if (saved) {
                transferNumber.value = saved;
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
            }

            // ---- Save Transfer Number ----
            saveTransferBtn.addEventListener("click", function() {
                var num = transferNumber.value.trim();
                if (!num) return;
                localStorage.setItem("vb_transfer_number", num);
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
                saveTransferBtn.style.borderColor = "var(--success)";
                saveTransferBtn.style.color = "var(--success)";
                setTimeout(function() {
                    saveTransferBtn.style.borderColor = "";
                    saveTransferBtn.style.color = "";
                }, 1500);
            });

            // ---- Dial Mode Toggle ----
            var modeSeq = document.getElementById("modeSeq");
            var modeSimul = document.getElementById("modeSimul");
            var dialModeInput = document.getElementById("dialModeInput");
            var batchSizeWrap = document.getElementById("batchSizeWrap");
            var dialModeDesc = document.getElementById("dialModeDesc");

            function setDialMode(mode) {
                dialModeInput.value = mode;
                modeSeq.classList.toggle("active", mode === "sequential");
                modeSimul.classList.toggle("active", mode === "simultaneous");
                if (mode === "simultaneous") {
                    batchSizeWrap.style.display = "";
                    dialModeDesc.textContent = "Multiple calls are fired at the same time in batches for faster dialing.";
                } else {
                    batchSizeWrap.style.display = "none";
                    dialModeDesc.textContent = "Calls are placed one at a time, each waiting 2 seconds before the next.";
                }
            }

            modeSeq.addEventListener("click", function() { setDialMode("sequential"); });
            modeSimul.addEventListener("click", function() { setDialMode("simultaneous"); });

            // ---- Download Report ----
            var downloadBtn = document.getElementById("downloadReportBtn");
            var customDateRow = document.getElementById("customDateRow");
            var reportStart = document.getElementById("reportStart");
            var reportEnd = document.getElementById("reportEnd");
            var presetBtns = document.querySelectorAll(".download-preset");
            var selectedRange = "all";

            presetBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    presetBtns.forEach(function(b) { b.classList.remove("active"); });
                    btn.classList.add("active");
                    selectedRange = btn.getAttribute("data-range");
                    customDateRow.style.display = selectedRange === "custom" ? "" : "none";
                });
            });

            function getDateRange() {
                var now = new Date();
                var start = "", end = "";
                if (selectedRange === "today") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "week") {
                    var d = new Date(now);
                    d.setDate(d.getDate() - d.getDay());
                    start = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "month") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-01T00:00:00";
                } else if (selectedRange === "custom") {
                    start = reportStart.value ? reportStart.value + ":00" : "";
                    end = reportEnd.value ? reportEnd.value + ":59" : "";
                }
                return { start: start, end: end };
            }

            downloadBtn.addEventListener("click", function() {
                var range = getDateRange();
                var params = new URLSearchParams();
                if (range.start) params.set("start", range.start);
                if (range.end) params.set("end", range.end);
                var url = "/download_report" + (params.toString() ? "?" + params.toString() : "");
                window.location.href = url;
            });

            // ---- Clear Call Logs ----
            clearLogsBtn.addEventListener("click", function() {
                if (!confirm("Clear all call logs?")) return;
                clearLogsBtn.disabled = true;
                apiFetch("/clear_logs", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        clearLogsBtn.disabled = false;
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        callBody.innerHTML = '<tr><td colspan="7" class="empty-row">No calls yet</td></tr>';
                        callCount.textContent = "0 calls";
                    })
                    .catch(function(e) {
                        clearLogsBtn.disabled = false;
                        if (e.message !== "auth") alert("Failed to clear logs");
                    });
            });

            // ---- Test Call ----
            testCallBtn.addEventListener("click", function() {
                var number = testNumber.value.trim();
                if (!number) { alert("Enter a phone number"); return; }

                testCallBtn.disabled = true;
                testCallBtn.textContent = "Calling...";
                testResult.textContent = "";

                var formData = new FormData();
                formData.append("test_number", number);

                apiFetch("/test_call", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        testCallBtn.disabled = false;
                        testCallBtn.textContent = "Call";
                        if (data.error) {
                            testResult.innerHTML = '<span style="color: var(--danger);">' + data.error + '</span>';
                        } else {
                            testResult.innerHTML = '<span style="color: var(--success);">' + data.message + '</span>';
                            pollStatus();
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        testCallBtn.disabled = false;
                        testCallBtn.textContent = "Call";
                        testResult.innerHTML = '<span style="color: var(--danger);">Request failed</span>';
                    });
            });

            // ---- Start Campaign ----
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                var formData = new FormData(form);
                startBtn.disabled = true;
                startBtn.textContent = "Starting...";

                apiFetch("/start", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                            startBtn.disabled = false;
                            startBtn.textContent = "Start Campaign";
                        } else {
                            stopBtn.disabled = false;
                            startBtn.textContent = "Campaign Running...";
                            pollStatus();
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        alert("Failed to start campaign");
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Stop Campaign ----
            stopBtn.addEventListener("click", function() {
                apiFetch("/stop", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function() {
                        stopBtn.disabled = true;
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Status Helpers ----
            function getStatusClass(status) {
                switch(status) {
                    case "transferred":
                    case "voicemail_complete": return "status-success";
                    case "voicemail_playing":
                    case "test_call_ringing":
                    case "ringing":
                    case "answered":
                    case "human_detected": return "status-active";
                    case "machine_detected": return "status-warning";
                    case "hangup": return "status-neutral";
                    case "initiated": return "status-pending";
                    case "no_answer":
                    case "transfer_failed":
                    case "human_no_transfer": return "status-error";
                    default: return "";
                }
            }

            function formatStatus(s) {
                if (s === "initiated") return "Dialing...";
                if (s === "test_call_ringing") return "Ringing";
                if (s === "human_no_transfer") return "Human (No Transfer #)";
                if (s === "transfer_failed") return "Transfer Failed";
                return s.replace(/_/g, " ").replace(/\b\w/g, function(l) { return l.toUpperCase(); });
            }

            function formatRing(secs) {
                if (secs === null || secs === undefined) return "-";
                if (secs < 60) return secs + "s";
                return Math.floor(secs / 60) + "m " + (secs % 60) + "s";
            }

            function maskNumber(n) {
                if (!n || n.length < 5) return n || "-";
                return n;
            }

            // ---- Polling ----
            var pollInterval = 2000;
            var pollTimer = null;
            var isActive = false;

            function pollStatus() {
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var bar = document.getElementById("campaignStatus");
                        var wasActive = isActive;
                        isActive = data.active;

                        if (data.active) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-active"></span> Campaign active &mdash; ' + data.total + ' numbers';
                        } else if (data.stop_requested) {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign stopping...';
                        } else {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-inactive"></span> No active campaign';
                            if (data.calls && data.calls.length > 0) {
                                startBtn.disabled = false;
                                startBtn.textContent = "Start Campaign";
                                stopBtn.disabled = true;
                            }
                        }

                        var hasLiveCalls = false;
                        var count = data.calls ? data.calls.length : 0;
                        callCount.textContent = count + " call" + (count !== 1 ? "s" : "");

                        if (data.calls && data.calls.length > 0) {
                            var html = "";
                            data.calls.forEach(function(c) {
                                var cls = getStatusClass(c.status);
                                var liveStatuses = ["initiated","ringing","test_call_ringing","answered","human_detected","machine_detected","voicemail_playing"];
                                if (liveStatuses.indexOf(c.status) !== -1) hasLiveCalls = true;
                                html += "<tr>";
                                html += '<td class="td-mono">' + maskNumber(c.number) + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.from_number) + "</td>";
                                html += '<td><span class="status-badge ' + cls + '">' + formatStatus(c.status) + "</span></td>";
                                html += "<td>" + formatRing(c.ring_duration) + "</td>";
                                html += "<td>" + (c.machine_detected === null ? "-" : (c.machine_detected ? "Yes" : "No")) + "</td>";
                                html += "<td>" + (c.transferred ? "Yes" : "-") + "</td>";
                                html += "<td>" + (c.voicemail_dropped ? "Yes" : "-") + "</td>";
                                html += "</tr>";
                            });
                            callBody.innerHTML = html;
                        } else if (count === 0) {
                            callBody.innerHTML = '<tr><td colspan="7" class="empty-row">No calls yet</td></tr>';
                        }

                        adjustPollSpeed(data.active || hasLiveCalls);
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                    });
            }

            function adjustPollSpeed(fast) {
                var newInterval = fast ? 1000 : 3000;
                if (newInterval !== pollInterval) {
                    pollInterval = newInterval;
                    clearInterval(pollTimer);
                    pollTimer = setInterval(pollStatus, pollInterval);
                }
            }

            pollTimer = setInterval(pollStatus, pollInterval);
            pollStatus();
        })();
    </script>
</body>
</html>
