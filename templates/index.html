<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Blast</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”Š</text></svg>">
    <script>
        (function(){var t=localStorage.getItem("vb_theme");if(t)document.documentElement.setAttribute("data-theme",t);})();
    </script>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-logo-wrap">
            <div class="splash-icon">
                <div class="splash-rings">
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                </div>
                <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="g1" x1="0" y1="0" x2="64" y2="64">
                            <stop offset="0%" stop-color="#06B6D4"/>
                            <stop offset="100%" stop-color="#3B82F6"/>
                        </linearGradient>
                    </defs>
                    <rect x="2" y="2" width="60" height="60" rx="18" fill="url(#g1)"/>
                    <path d="M20 24v16l14 9V15l-14 9z" fill="#fff" opacity="0.95"/>
                    <path d="M38 25a10 10 0 010 14" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                    <path d="M42 21a16 16 0 010 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.55"/>
                    <path d="M46 17a22 22 0 010 30" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.25"/>
                </svg>
            </div>
            <div class="splash-title">Voice Blast</div>
            <div class="splash-subtitle">Voicemail Drop System</div>
            <div class="splash-bar">
                <div class="splash-bar-fill"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <div class="video-bg">
            <video autoplay muted loop playsinline preload="metadata" id="bgVideo">
                <source src="/static/videos/bg-loop-new.mp4" type="video/mp4">
            </video>
            <div class="video-overlay"></div>
        </div>
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        <div class="bg-glow bg-glow-3"></div>

        <!-- Header (Full Width) -->
        <div class="header">
            <div class="header-inner">
                <div class="header-logo">
                    <div class="header-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="g2" x1="0" y1="0" x2="64" y2="64">
                                    <stop offset="0%" stop-color="#06B6D4"/>
                                    <stop offset="100%" stop-color="#3B82F6"/>
                                </linearGradient>
                            </defs>
                            <rect x="2" y="2" width="60" height="60" rx="18" fill="url(#g2)"/>
                            <path d="M20 24v16l14 9V15l-14 9z" fill="#fff" opacity="0.95"/>
                            <path d="M38 25a10 10 0 010 14" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                            <path d="M42 21a16 16 0 010 22" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.55"/>
                        </svg>
                    </div>
                    <div class="header-text">
                        <h1>Voice Blast</h1>
                        <div class="header-tagline">Voicemail Drop System</div>
                    </div>
                </div>
                <div class="header-right">
                    <span class="header-status-dot"></span>
                    <span class="header-version">v1.0</span>
                    <button type="button" class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="container">

            <!-- Status Bar -->
            <div class="status-bar stagger-1" id="campaignStatus">
                <span class="dot dot-inactive"></span> No active campaign
            </div>

            <!-- Voicemail Settings -->
            <div class="card stagger-2">
                <div class="card-title">
                    <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
                    Voicemail Settings
                </div>
                <label>Voicemail Audio URL</label>
                <div class="vm-settings-row">
                    <input type="text" id="vmUrlInput" class="input-full" placeholder="https://example.com/voicemail.mp3 or .wav">
                    <button type="button" class="btn btn-save-vm" id="saveVmBtn">Save</button>
                </div>
                <div class="vm-preview" id="vmPreview" style="display:none;">
                    <label>Audio Preview</label>
                    <audio id="vmAudioPlayer" controls preload="metadata" style="width:100%;margin-top:4px;"></audio>
                    <div class="vm-duration" id="vmDuration"></div>
                </div>
                <div id="vmSaveResult"></div>
            </div>

            <!-- Test Call -->
            <div class="card stagger-3">
                <div class="card-title">
                    <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                    Test Your Dialer
                </div>
                <label>Enter a phone number to test and a transfer number for human-answered calls.</label>
                <div class="test-call-row">
                    <input type="text" id="testNumber" class="input-phone" placeholder="Number to call: +15551234567" maxlength="16">
                    <input type="text" id="testTransferNumber" class="input-phone" placeholder="Transfer to: +15559876543" maxlength="16">
                    <button type="button" class="btn btn-test" id="testCallBtn">Start Test Call</button>
                </div>
                <div class="test-results-box" id="testResultsBox" style="display:none;">
                    <div class="test-results-title">Test Results</div>
                    <div id="testResult" class="test-result-status">Status: Idle</div>
                </div>
            </div>

            <!-- Campaign Form -->
            <form id="campaignForm">
                <div class="form-grid stagger-4">
                    <!-- Phone Numbers -->
                    <div class="card card-accent">
                        <div class="card-title">
                            <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                            Phone Numbers
                        </div>
                        <label>Upload CSV file</label>
                        <input type="file" name="csv_file" id="csvFile" accept=".csv,.txt">
                        <label>Or paste numbers (one per line)</label>
                        <textarea name="numbers" id="numbersInput" rows="4" placeholder="+15551234567&#10;+15559876543"></textarea>
                    </div>

                    <!-- Audio -->
                    <div class="card card-accent">
                        <div class="card-title">
                            <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
                            Voicemail Audio <span style="font-weight:400;font-size:11px;color:var(--text-secondary);">(optional - uses saved URL if empty)</span>
                        </div>
                        <label>Upload MP3/WAV to override saved voicemail</label>
                        <input type="file" name="audio_file" id="audioFile" accept=".mp3,.wav">
                        <label>Or provide a different public audio URL</label>
                        <input type="text" name="audio_url" id="audioUrl" placeholder="https://example.com/voicemail.mp3">
                    </div>
                </div>

                <!-- Transfer Number -->
                <div class="card stagger-5">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 014-4h12"/></svg>
                        Transfer Number
                    </div>
                    <label>If a human answers, transfer the call to</label>
                    <div class="transfer-row">
                        <div class="transfer-input-wrap">
                            <input type="text" name="transfer_number" id="transferNumber" class="input-phone" placeholder="+15551112222" maxlength="16" required>
                        </div>
                        <button type="button" class="btn-save-transfer" id="saveTransferBtn">Save for future</button>
                    </div>
                    <div class="saved-indicator" id="savedIndicator">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        Saved &mdash; auto-fills next time
                    </div>
                </div>

                <!-- Dial Mode -->
                <div class="card stagger-6">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
                        Dial Mode
                    </div>
                    <label>Choose how calls are placed</label>
                    <div class="dial-mode-toggle">
                        <button type="button" class="dial-mode-btn active" data-mode="sequential" id="modeSeq">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                            Sequential
                        </button>
                        <button type="button" class="dial-mode-btn" data-mode="simultaneous" id="modeSimul">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            Simultaneous
                        </button>
                    </div>
                    <input type="hidden" name="dial_mode" id="dialModeInput" value="sequential">
                    <div class="batch-size-wrap" id="batchSizeWrap" style="display:none;">
                        <label>Calls per batch</label>
                        <div class="batch-size-row">
                            <input type="number" name="batch_size" id="batchSize" class="input-batch" value="5" min="2" max="50">
                            <span class="batch-hint">2â€“50 calls fired at once per batch</span>
                        </div>
                    </div>
                    <div class="dial-mode-desc" id="dialModeDesc">Calls are placed one at a time, each waiting 2 seconds before the next.</div>
                </div>

                <!-- Buttons -->
                <div class="button-group stagger-7">
                    <button type="submit" class="btn btn-start" id="startBtn">Start Campaign</button>
                    <button type="button" class="btn btn-stop" id="stopBtn" disabled>Stop Campaign</button>
                </div>
            </form>

            <!-- Call Log -->
            <div class="log-section stagger-8">
                <div class="log-header">
                    <h2>
                        <svg class="log-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Call Log
                    </h2>
                    <div class="log-header-actions">
                        <span id="callCount" class="call-count">0 calls</span>
                        <button type="button" class="btn-clear-logs" id="clearLogsBtn" title="Clear all call logs">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="filter-row">
                    <label class="filter-label">Filter:</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">All Calls</option>
                        <option value="success">Successful (VM Dropped / Transferred)</option>
                        <option value="failed">Failed / Disconnected</option>
                        <option value="issues">Warnings / Issues</option>
                        <option value="progress">In Progress</option>
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="callTable">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Destination</th>
                                <th>Caller ID</th>
                                <th>Status Description</th>
                                <th>Ring</th>
                                <th>Machine?</th>
                                <th>Transferred</th>
                                <th>Voicemail</th>
                            </tr>
                        </thead>
                        <tbody id="callBody">
                            <tr><td colspan="8" class="empty-row">No calls yet</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="download-section">
                    <div class="download-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download Report
                    </div>
                    <div class="download-filters">
                        <div class="download-preset-row">
                            <button type="button" class="download-preset active" data-range="all">All Time</button>
                            <button type="button" class="download-preset" data-range="today">Today</button>
                            <button type="button" class="download-preset" data-range="week">This Week</button>
                            <button type="button" class="download-preset" data-range="month">This Month</button>
                            <button type="button" class="download-preset" data-range="custom">Custom</button>
                        </div>
                        <div class="download-custom-row" id="customDateRow" style="display:none;">
                            <div class="date-field">
                                <label>From</label>
                                <input type="datetime-local" id="reportStart" class="input-date">
                            </div>
                            <div class="date-field">
                                <label>To</label>
                                <input type="datetime-local" id="reportEnd" class="input-date">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-download" id="downloadReportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            function apiFetch(url, opts) {
                var defaults = { credentials: "include", headers: {} };
                var merged = Object.assign({}, defaults, opts || {});
                if (!merged.body || !(merged.body instanceof FormData)) {
                    merged.headers["X-Requested-With"] = "XMLHttpRequest";
                } else {
                    var h = new Headers(merged.headers || {});
                    h.set("X-Requested-With", "XMLHttpRequest");
                    merged.headers = h;
                }
                return fetch(url, merged).then(function(r) {
                    if (r.status === 401) {
                        window.location.href = "/login";
                        throw new Error("auth");
                    }
                    return r;
                });
            }

            // ---- Splash Screen ----
            setTimeout(function() {
                document.getElementById("splash").classList.add("hide");
                document.getElementById("app").classList.add("show");
            }, 2900);

            // ---- Theme Toggle ----
            var themeToggle = document.getElementById("themeToggle");
            function getCurrentTheme() {
                return document.documentElement.getAttribute("data-theme") || "dark";
            }
            themeToggle.addEventListener("click", function() {
                var next = getCurrentTheme() === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("vb_theme", next);
            });

            // ---- Scroll Reveal + Mouse Glow Effect on Cards ----
            (function() {
                document.documentElement.classList.add("js-scroll-ready");
                var animEls = document.querySelectorAll(".card, .log-section");

                if ("IntersectionObserver" in window) {
                    var observer = new IntersectionObserver(function(entries) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                entry.target.classList.add("scroll-visible");
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.12, rootMargin: "0px 0px -40px 0px" });

                    animEls.forEach(function(el, i) {
                        el.classList.add("scroll-reveal");
                        el.style.transitionDelay = (i * 0.07) + "s";
                        observer.observe(el);
                    });
                }

                animEls.forEach(function(el) {
                    el.addEventListener("mousemove", function(e) {
                        var rect = el.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        var y = e.clientY - rect.top;
                        el.style.setProperty("--glow-x", x + "px");
                        el.style.setProperty("--glow-y", y + "px");
                        el.classList.add("card-glow-active");
                    });
                    el.addEventListener("mouseleave", function() {
                        el.classList.remove("card-glow-active");
                    });
                });

                var videoBg = document.querySelector(".video-bg video");
                var maxShift = 150;
                window.addEventListener("scroll", function() {
                    if (videoBg) {
                        var shift = Math.min(window.pageYOffset * 0.25, maxShift);
                        videoBg.style.transform = "translateY(" + shift + "px) scale(1.1)";
                    }
                }, { passive: true });
            })();

            // ---- Ripple Effect ----
            document.addEventListener("click", function(e) {
                var btn = e.target.closest(".btn, .btn-save-transfer, .btn-clear-logs");
                if (!btn || btn.disabled) return;
                var rect = btn.getBoundingClientRect();
                var ripple = document.createElement("span");
                ripple.className = "ripple";
                var size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + "px";
                ripple.style.left = (e.clientX - rect.left - size / 2) + "px";
                ripple.style.top = (e.clientY - rect.top - size / 2) + "px";
                btn.style.position = "relative";
                btn.style.overflow = "hidden";
                btn.appendChild(ripple);
                setTimeout(function() { ripple.remove(); }, 500);
            });

            // ---- Elements ----
            var form = document.getElementById("campaignForm");
            var startBtn = document.getElementById("startBtn");
            var stopBtn = document.getElementById("stopBtn");
            var callBody = document.getElementById("callBody");
            var callCount = document.getElementById("callCount");
            var statusFilter = document.getElementById("statusFilter");
            statusFilter.addEventListener("change", function() { pollStatus(); });
            var campaignStatus = document.getElementById("campaignStatus");
            var testCallBtn = document.getElementById("testCallBtn");
            var testNumber = document.getElementById("testNumber");
            var testResult = document.getElementById("testResult");
            var testResultsBox = document.getElementById("testResultsBox");
            var transferNumber = document.getElementById("transferNumber");
            var saveTransferBtn = document.getElementById("saveTransferBtn");
            var savedIndicator = document.getElementById("savedIndicator");
            var clearLogsBtn = document.getElementById("clearLogsBtn");

            // ---- Voicemail Settings ----
            var vmUrlInput = document.getElementById("vmUrlInput");
            var saveVmBtn = document.getElementById("saveVmBtn");
            var vmPreview = document.getElementById("vmPreview");
            var vmAudioPlayer = document.getElementById("vmAudioPlayer");
            var vmDuration = document.getElementById("vmDuration");
            var vmSaveResult = document.getElementById("vmSaveResult");

            function loadVmSettings() {
                apiFetch("/api/voicemail_settings")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.voicemail_url) {
                            vmUrlInput.value = data.voicemail_url;
                            showVmPreview(data.voicemail_url);
                        }
                    })
                    .catch(function() {});
            }

            function showVmPreview(url) {
                if (!url) { vmPreview.style.display = "none"; return; }
                vmAudioPlayer.src = url;
                vmPreview.style.display = "";
                vmAudioPlayer.addEventListener("loadedmetadata", function() {
                    var dur = Math.round(vmAudioPlayer.duration);
                    vmDuration.textContent = "Duration: " + dur + " seconds";
                });
                vmAudioPlayer.addEventListener("error", function() {
                    vmDuration.textContent = "Could not load audio preview";
                });
            }

            saveVmBtn.addEventListener("click", function() {
                var url = vmUrlInput.value.trim();
                if (!url) { alert("Enter a voicemail URL"); return; }
                saveVmBtn.disabled = true;
                saveVmBtn.textContent = "Saving...";
                apiFetch("/api/voicemail_settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ voicemail_url: url })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    if (data.error) {
                        vmSaveResult.innerHTML = '<span style="color:var(--danger);">' + data.error + '</span>';
                    } else {
                        vmSaveResult.innerHTML = '<span style="color:var(--success);">Voicemail URL saved</span>';
                        showVmPreview(url);
                        setTimeout(function() { vmSaveResult.textContent = ""; }, 3000);
                    }
                })
                .catch(function(e) {
                    if (e.message === "auth") return;
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    vmSaveResult.innerHTML = '<span style="color:var(--danger);">Failed to save</span>';
                });
            });

            loadVmSettings();

            // ---- Load Saved Transfer Number ----
            var saved = localStorage.getItem("vb_transfer_number");
            if (saved) {
                transferNumber.value = saved;
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
            }

            // ---- Save Transfer Number ----
            saveTransferBtn.addEventListener("click", function() {
                var num = transferNumber.value.trim();
                if (!num) return;
                localStorage.setItem("vb_transfer_number", num);
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
                saveTransferBtn.style.borderColor = "var(--success)";
                saveTransferBtn.style.color = "var(--success)";
                setTimeout(function() {
                    saveTransferBtn.style.borderColor = "";
                    saveTransferBtn.style.color = "";
                }, 1500);
            });

            // ---- Dial Mode Toggle ----
            var modeSeq = document.getElementById("modeSeq");
            var modeSimul = document.getElementById("modeSimul");
            var dialModeInput = document.getElementById("dialModeInput");
            var batchSizeWrap = document.getElementById("batchSizeWrap");
            var dialModeDesc = document.getElementById("dialModeDesc");

            function setDialMode(mode) {
                dialModeInput.value = mode;
                modeSeq.classList.toggle("active", mode === "sequential");
                modeSimul.classList.toggle("active", mode === "simultaneous");
                if (mode === "simultaneous") {
                    batchSizeWrap.style.display = "";
                    dialModeDesc.textContent = "Multiple calls are fired at the same time in batches for faster dialing.";
                } else {
                    batchSizeWrap.style.display = "none";
                    dialModeDesc.textContent = "Calls are placed one at a time, each waiting 2 seconds before the next.";
                }
            }

            modeSeq.addEventListener("click", function() { setDialMode("sequential"); });
            modeSimul.addEventListener("click", function() { setDialMode("simultaneous"); });

            // ---- Download Report ----
            var downloadBtn = document.getElementById("downloadReportBtn");
            var customDateRow = document.getElementById("customDateRow");
            var reportStart = document.getElementById("reportStart");
            var reportEnd = document.getElementById("reportEnd");
            var presetBtns = document.querySelectorAll(".download-preset");
            var selectedRange = "all";

            presetBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    presetBtns.forEach(function(b) { b.classList.remove("active"); });
                    btn.classList.add("active");
                    selectedRange = btn.getAttribute("data-range");
                    customDateRow.style.display = selectedRange === "custom" ? "" : "none";
                });
            });

            function getDateRange() {
                var now = new Date();
                var start = "", end = "";
                if (selectedRange === "today") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "week") {
                    var d = new Date(now);
                    d.setDate(d.getDate() - d.getDay());
                    start = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "month") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-01T00:00:00";
                } else if (selectedRange === "custom") {
                    start = reportStart.value ? reportStart.value + ":00" : "";
                    end = reportEnd.value ? reportEnd.value + ":59" : "";
                }
                return { start: start, end: end };
            }

            downloadBtn.addEventListener("click", function() {
                var range = getDateRange();
                var params = new URLSearchParams();
                if (range.start) params.set("start", range.start);
                if (range.end) params.set("end", range.end);
                var url = "/download_report" + (params.toString() ? "?" + params.toString() : "");
                window.location.href = url;
            });

            // ---- Clear Call Logs ----
            clearLogsBtn.addEventListener("click", function() {
                if (!confirm("Clear all call logs?")) return;
                clearLogsBtn.disabled = true;
                apiFetch("/clear_logs", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        clearLogsBtn.disabled = false;
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        callBody.innerHTML = '<tr><td colspan="8" class="empty-row">No calls yet</td></tr>';
                        callCount.textContent = "0 calls";
                    })
                    .catch(function(e) {
                        clearLogsBtn.disabled = false;
                        if (e.message !== "auth") alert("Failed to clear logs");
                    });
            });

            // ---- Test Call ----
            var _testCallId = null;
            var _testCallNumber = null;
            var _testCallActive = false;

            function updateTestStatus(msg, color) {
                testResult.innerHTML = '<span style="color:' + (color || 'var(--text-secondary)') + ';">' + msg + '</span>';
            }

            function trackTestCallStatus() {
                if (!_testCallActive) return;
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.calls || !_testCallActive) return;
                        var found = null;
                        for (var i = 0; i < data.calls.length; i++) {
                            var c = data.calls[i];
                            if (_testCallId && c.call_id && c.call_id.indexOf(_testCallId.substring(0, 12)) === 0) {
                                found = c;
                                break;
                            }
                            if (!found && c.number === _testCallNumber && c.is_live) {
                                found = c;
                            }
                        }
                        if (!found) return;

                        var desc = found.status_description || found.status;
                        var colorMap = { green: "var(--success)", red: "var(--danger)", yellow: "#F59E0B", blue: "var(--accent)" };
                        var col = colorMap[found.status_color] || "var(--text-secondary)";
                        updateTestStatus(desc, col);

                        var doneStatuses = ["voicemail_complete","transferred","hangup","transfer_failed","human_no_transfer","no_answer"];
                        if (doneStatuses.indexOf(found.status) !== -1) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            if (found.voicemail_dropped) {
                                updateTestStatus("Voicemail dropped! Check your phone to hear the message.", "var(--success)");
                            } else if (found.transferred) {
                                updateTestStatus("Human detected! In a real campaign, this would transfer to your destination number.", "var(--success)");
                            }
                        } else {
                            setTimeout(trackTestCallStatus, 1000);
                        }
                    })
                    .catch(function() {
                        if (_testCallActive) setTimeout(trackTestCallStatus, 2000);
                    });
            }

            testCallBtn.addEventListener("click", function() {
                var number = testNumber.value.trim();
                if (!number) { alert("Enter a phone number"); return; }
                var transferNum = document.getElementById("testTransferNumber").value.trim();
                if (!transferNum) { alert("Enter a transfer number for human-answered calls"); return; }

                testCallBtn.disabled = true;
                testCallBtn.textContent = "Calling...";
                testResultsBox.style.display = "";
                updateTestStatus("Dialing...", "var(--accent)");

                _testCallNumber = number;
                _testCallId = null;
                _testCallActive = true;

                var formData = new FormData();
                formData.append("test_number", number);
                formData.append("transfer_number", transferNum);

                apiFetch("/test_call", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            updateTestStatus(data.error, "var(--danger)");
                        } else {
                            _testCallId = data.call_control_id || null;
                            updateTestStatus("Ringing...", "var(--accent)");
                            pollStatus();
                            setTimeout(trackTestCallStatus, 1500);
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        _testCallActive = false;
                        testCallBtn.disabled = false;
                        testCallBtn.textContent = "Start Test Call";
                        updateTestStatus("Request failed", "var(--danger)");
                    });
            });

            // ---- Start Campaign ----
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                var formData = new FormData(form);
                startBtn.disabled = true;
                startBtn.textContent = "Starting...";

                apiFetch("/start", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                            startBtn.disabled = false;
                            startBtn.textContent = "Start Campaign";
                        } else {
                            stopBtn.disabled = false;
                            startBtn.textContent = "Campaign Running...";
                            pollStatus();
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        alert("Failed to start campaign");
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Stop Campaign ----
            stopBtn.addEventListener("click", function() {
                apiFetch("/stop", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function() {
                        stopBtn.disabled = true;
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Status Helpers ----
            function getStatusClass(status) {
                switch(status) {
                    case "transferred":
                    case "voicemail_complete": return "status-success";
                    case "voicemail_playing":
                    case "test_call_ringing":
                    case "ringing":
                    case "answered":
                    case "human_detected": return "status-active";
                    case "machine_detected": return "status-warning";
                    case "hangup": return "status-neutral";
                    case "initiated": return "status-pending";
                    case "no_answer":
                    case "transfer_failed":
                    case "human_no_transfer": return "status-error";
                    default: return "";
                }
            }

            function formatStatus(s) {
                if (s === "initiated") return "Dialing...";
                if (s === "test_call_ringing") return "Ringing";
                if (s === "human_no_transfer") return "Human (No Transfer #)";
                if (s === "transfer_failed") return "Transfer Failed";
                return s.replace(/_/g, " ").replace(/\b\w/g, function(l) { return l.toUpperCase(); });
            }

            function formatRing(secs) {
                if (secs === null || secs === undefined) return "-";
                if (secs < 60) return secs + "s";
                return Math.floor(secs / 60) + "m " + (secs % 60) + "s";
            }

            function maskNumber(n) {
                if (!n || n.length < 5) return n || "-";
                return n;
            }

            // ---- Polling ----
            var pollInterval = 2000;
            var pollTimer = null;
            var isActive = false;

            function pollStatus() {
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var bar = document.getElementById("campaignStatus");
                        var wasActive = isActive;
                        isActive = data.active;

                        if (data.active && data.transfer_paused) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign paused &mdash; live transfer in progress';
                        } else if (data.active) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-active"></span> Campaign active &mdash; ' + data.total + ' numbers';
                        } else if (data.stop_requested) {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign stopping...';
                        } else {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-inactive"></span> No active campaign';
                            if (data.calls && data.calls.length > 0) {
                                startBtn.disabled = false;
                                startBtn.textContent = "Start Campaign";
                                stopBtn.disabled = true;
                            }
                        }

                        var hasLiveCalls = false;
                        var count = data.calls ? data.calls.length : 0;
                        callCount.textContent = count + " call" + (count !== 1 ? "s" : "");

                        var filterVal = statusFilter.value;

                        if (data.calls && data.calls.length > 0) {
                            var filtered = data.calls.filter(function(c) {
                                if (filterVal === "all") return true;
                                var col = c.status_color || "";
                                if (filterVal === "success") return col === "green";
                                if (filterVal === "failed") return col === "red";
                                if (filterVal === "issues") return col === "yellow";
                                if (filterVal === "progress") return col === "blue";
                                return true;
                            });

                            var liveStatuses = ["initiated","ringing","test_call_ringing","answered","human_detected","machine_detected","voicemail_playing"];

                            var html = "";
                            filtered.forEach(function(c) {
                                if (liveStatuses.indexOf(c.status) !== -1) hasLiveCalls = true;
                                var tsDisplay = "-";
                                if (c.timestamp) {
                                    try {
                                        var d = new Date(c.timestamp);
                                        if (!isNaN(d.getTime())) {
                                            tsDisplay = d.toLocaleDateString(undefined, {month:"short", day:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
                                        }
                                    } catch(e) {}
                                }
                                var descText = c.status_description || formatStatus(c.status);
                                var colorCls = "status-" + (c.status_color || "blue");

                                html += "<tr>";
                                html += '<td class="td-ts">' + tsDisplay + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.number) + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.from_number) + "</td>";
                                html += '<td><span class="status-desc-badge ' + colorCls + '">' + descText + "</span></td>";
                                html += "<td>" + formatRing(c.ring_duration) + "</td>";
                                html += "<td>" + (c.machine_detected === null ? "-" : (c.machine_detected ? "Yes" : "No")) + "</td>";
                                html += "<td>" + (c.transferred ? "Yes" : "-") + "</td>";
                                html += "<td>" + (c.voicemail_dropped ? "Yes" : "-") + "</td>";
                                html += "</tr>";
                            });
                            if (filtered.length > 0) {
                                callBody.innerHTML = html;
                            } else {
                                callBody.innerHTML = '<tr><td colspan="8" class="empty-row">No matching calls</td></tr>';
                            }
                        } else if (count === 0) {
                            callBody.innerHTML = '<tr><td colspan="8" class="empty-row">No calls yet</td></tr>';
                        }

                        adjustPollSpeed(data.active || hasLiveCalls);
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                    });
            }

            function adjustPollSpeed(fast) {
                var newInterval = fast ? 1000 : 3000;
                if (newInterval !== pollInterval) {
                    pollInterval = newInterval;
                    clearInterval(pollTimer);
                    pollTimer = setInterval(pollStatus, pollInterval);
                }
            }

            pollTimer = setInterval(pollStatus, pollInterval);
            pollStatus();
        })();
    </script>

    <!-- FLOATING NOTEPAD -->
    <button class="notepad-fab" id="notepadFab" title="Open Notepad">N</button>
    <div class="notepad-window" id="notepadWindow">
        <div class="notepad-header" id="notepadHeader">
            <div class="notepad-header-left">
                <div class="notepad-header-logo">N</div>
                <span class="notepad-header-title">Notepad</span>
            </div>
            <div class="notepad-header-actions">
                <button id="notepadClear" title="Clear All">&#128465;</button>
                <button id="notepadMin" title="Minimize">&minus;</button>
            </div>
        </div>
        <div class="notepad-toolbar" id="notepadToolbar">
            <button data-cmd="bold" title="Bold"><b>B</b></button>
            <button data-cmd="italic" title="Italic"><i>I</i></button>
            <button data-cmd="underline" title="Underline"><u>U</u></button>
            <button data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
            <div class="sep"></div>
            <select id="npFontSize" title="Font Size">
                <option value="1">Small</option>
                <option value="3" selected>Normal</option>
                <option value="5">Large</option>
                <option value="7">Huge</option>
            </select>
            <div class="sep"></div>
            <input type="color" id="npTextColor" value="#06B6D4" title="Text Color">
            <input type="color" id="npHighlight" value="#FFFF00" title="Highlight Color">
            <button data-cmd="removeFormat" title="Remove Formatting">&#10006;</button>
            <div class="sep"></div>
            <button data-cmd="insertUnorderedList" title="Bullet List">&#8226;</button>
            <button data-cmd="insertOrderedList" title="Numbered List">1.</button>
            <div class="sep"></div>
            <button data-cmd="justifyLeft" title="Align Left">&#8676;</button>
            <button data-cmd="justifyCenter" title="Align Center">&#8596;</button>
            <button data-cmd="justifyRight" title="Align Right">&#8677;</button>
        </div>
        <div class="notepad-body">
            <div class="notepad-editor" id="notepadEditor" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="notepad-footer">
            <span id="notepadCharCount">0 characters</span>
            <button id="notepadDownload" title="Download as text file">Download</button>
        </div>
    </div>

    <script>
    (function(){
        var fab = document.getElementById("notepadFab");
        var win = document.getElementById("notepadWindow");
        var header = document.getElementById("notepadHeader");
        var editor = document.getElementById("notepadEditor");
        var minBtn = document.getElementById("notepadMin");
        var clearBtn = document.getElementById("notepadClear");
        var charCount = document.getElementById("notepadCharCount");
        var downloadBtn = document.getElementById("notepadDownload");
        var fontSel = document.getElementById("npFontSize");
        var colorPick = document.getElementById("npTextColor");
        var hlPick = document.getElementById("npHighlight");
        var storageKey = "vb_notepad_content";
        var posKey = "vb_notepad_pos";
        var defaultBottom = 28, defaultRight = 28;
        var isDragging = false, dragX = 0, dragY = 0;

        var saved = localStorage.getItem(storageKey);
        if (saved) editor.innerHTML = saved;

        function updateCharCount() {
            var t = editor.innerText || "";
            var len = t.replace(/\n$/,"").length;
            charCount.textContent = len + " character" + (len !== 1 ? "s" : "");
        }
        updateCharCount();

        function saveContent() {
            localStorage.setItem(storageKey, editor.innerHTML);
            updateCharCount();
        }

        editor.addEventListener("input", saveContent);

        fab.addEventListener("click", function(){
            fab.classList.add("hidden");
            win.classList.add("open");
            var pos = localStorage.getItem(posKey);
            if (pos) {
                try {
                    var p = JSON.parse(pos);
                    win.style.bottom = "auto";
                    win.style.right = "auto";
                    win.style.left = p.left + "px";
                    win.style.top = p.top + "px";
                } catch(e) {}
            }
            editor.focus();
        });

        function closeNotepad() {
            win.classList.remove("open");
            fab.classList.remove("hidden");
            win.style.bottom = defaultBottom + "px";
            win.style.right = defaultRight + "px";
            win.style.left = "";
            win.style.top = "";
        }

        minBtn.addEventListener("click", closeNotepad);

        clearBtn.addEventListener("click", function(){
            if (confirm("Clear all notes?")) {
                editor.innerHTML = "";
                saveContent();
            }
        });

        header.addEventListener("mousedown", function(e){
            if (e.target.tagName === "BUTTON") return;
            isDragging = true;
            var rect = win.getBoundingClientRect();
            dragX = e.clientX - rect.left;
            dragY = e.clientY - rect.top;
            e.preventDefault();
        });

        document.addEventListener("mousemove", function(e){
            if (!isDragging) return;
            var nx = e.clientX - dragX;
            var ny = e.clientY - dragY;
            nx = Math.max(0, Math.min(nx, window.innerWidth - 100));
            ny = Math.max(0, Math.min(ny, window.innerHeight - 50));
            win.style.left = nx + "px";
            win.style.top = ny + "px";
            win.style.bottom = "auto";
            win.style.right = "auto";
            localStorage.setItem(posKey, JSON.stringify({left: nx, top: ny}));
        });

        document.addEventListener("mouseup", function(){
            isDragging = false;
        });

        header.addEventListener("touchstart", function(e){
            if (e.target.tagName === "BUTTON") return;
            isDragging = true;
            var rect = win.getBoundingClientRect();
            var t = e.touches[0];
            dragX = t.clientX - rect.left;
            dragY = t.clientY - rect.top;
        }, {passive: true});

        document.addEventListener("touchmove", function(e){
            if (!isDragging) return;
            var t = e.touches[0];
            var nx = t.clientX - dragX;
            var ny = t.clientY - dragY;
            nx = Math.max(0, Math.min(nx, window.innerWidth - 100));
            ny = Math.max(0, Math.min(ny, window.innerHeight - 50));
            win.style.left = nx + "px";
            win.style.top = ny + "px";
            win.style.bottom = "auto";
            win.style.right = "auto";
            localStorage.setItem(posKey, JSON.stringify({left: nx, top: ny}));
        }, {passive: true});

        document.addEventListener("touchend", function(){
            isDragging = false;
        });

        var toolbarBtns = document.querySelectorAll(".notepad-toolbar button[data-cmd]");
        toolbarBtns.forEach(function(btn){
            btn.addEventListener("mousedown", function(e){
                e.preventDefault();
            });
            btn.addEventListener("click", function(){
                var cmd = this.getAttribute("data-cmd");
                document.execCommand(cmd, false, null);
                editor.focus();
                saveContent();
            });
        });

        fontSel.addEventListener("change", function(){
            document.execCommand("fontSize", false, this.value);
            editor.focus();
            saveContent();
        });

        colorPick.addEventListener("input", function(){
            document.execCommand("foreColor", false, this.value);
            editor.focus();
            saveContent();
        });

        hlPick.addEventListener("input", function(){
            document.execCommand("hiliteColor", false, this.value);
            editor.focus();
            saveContent();
        });

        downloadBtn.addEventListener("click", function(){
            var text = editor.innerText || "";
            var blob = new Blob([text], {type: "text/plain"});
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "voiceblast-notes.txt";
            a.click();
            URL.revokeObjectURL(a.href);
        });

        document.addEventListener("keydown", function(e){
            if (e.key === "Escape" && win.classList.contains("open")) {
                closeNotepad();
            }
        });
    })();
    </script>
</body>
</html>
