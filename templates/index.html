<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Human</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
    <script>
        (function(){var t=localStorage.getItem("vb_theme");if(t)document.documentElement.setAttribute("data-theme",t);})();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-glow"></div>
        <div class="splash-logo-wrap">
            <div class="splash-icon">
                <div class="splash-ring-outer"></div>
                <div class="splash-ring-inner"></div>
                <div class="splash-text-logo">Open Human</div>
            </div>
            <div class="splash-subtitle">Intelligent Communication at Scale</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <canvas id="bgCanvas"></canvas>
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        <div class="bg-glow bg-glow-3"></div>

        <!-- Header (Full Width) -->
        <div class="header">
            <div class="header-inner">
                <div class="header-logo">
                    <div class="header-text-logo">Open Human</div>
                </div>
                <div class="header-right">
                    <span class="header-status-dot"></span>
                    <span class="header-version">v1.0</span>
                    <button type="button" class="theme-toggle" id="fullscreenToggle" title="Toggle fullscreen">
                        <svg class="icon-expand" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                        <svg class="icon-shrink" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                    </button>
                    <button type="button" class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="app-layout">

        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <button type="button" class="sidebar-btn" data-panel="panelVmSettings" title="Voicemail Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    <span class="sidebar-label">Voicemail Settings</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelTestDialer" title="Test Dialer">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                    <span class="sidebar-label">Test Dialer</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelPhoneNumbers" title="Phone Numbers">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                    <span class="sidebar-label">Phone Numbers</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelVmAudio" title="Voicemail Audio">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    <span class="sidebar-label">Voicemail Audio</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelTransfer" title="Transfer Number">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 014-4h12"/></svg>
                    <span class="sidebar-label">Transfer Number</span>
                </button>
                <div class="sidebar-divider"></div>
                <button type="button" class="sidebar-btn" data-panel="panelAnalytics" title="Call Analytics">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    <span class="sidebar-label">Call Analytics</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelDNC" title="DNC List">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                    <span class="sidebar-label">DNC List</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelSchedule" title="Schedule Campaign">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="sidebar-label">Schedule</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelWebhook" title="Webhook Monitor">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="2" width="12" height="20" rx="2"/><rect x="6" y="2" width="12" height="20" rx="2" fill="none"/><line x1="10" y1="0" x2="14" y2="0" stroke-width="3" stroke-linecap="round" transform="translate(0,2.5)"/><rect x="9" y="12" width="6" height="7" rx="1" fill="currentColor" opacity="0.4"/></svg>
                    <span class="sidebar-label">Health</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelTemplates" title="Campaign Templates">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    <span class="sidebar-label">Templates</span>
                </button>
                <button type="button" class="sidebar-btn" data-panel="panelValidation" title="Number Validation">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span class="sidebar-label">Validate</span>
                </button>
            </nav>
        </aside>

        <div class="container">

            <!-- Status Bar -->
            <div class="status-bar stagger-1" id="campaignStatus">
                <span class="dot dot-inactive"></span> No active campaign
            </div>

            <!-- Expandable Panels -->
            <div class="panel" id="panelVmSettings">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
                        Voicemail Settings
                        <button type="button" class="panel-minimize" data-panel="panelVmSettings" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>Voicemail Audio URL</label>
                    <div class="vm-settings-row">
                        <input type="text" id="vmUrlInput" class="input-full" placeholder="https://example.com/voicemail.mp3 or .wav">
                        <button type="button" class="btn btn-save-vm" id="saveVmBtn">Save</button>
                    </div>
                    <div class="vm-preview" id="vmPreview" style="display:none;">
                        <label>Audio Preview</label>
                        <audio id="vmAudioPlayer" controls preload="metadata"></audio>
                        <div class="vm-duration" id="vmDuration"></div>
                    </div>
                    <div id="vmSaveResult"></div>
                </div>
            </div>

            <div class="panel" id="panelTestDialer">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                        Test Your Dialer
                        <button type="button" class="panel-minimize" data-panel="panelTestDialer" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>Enter a phone number to test and a transfer number for human-answered calls.</label>
                    <div class="test-call-row">
                        <input type="text" id="testNumber" class="input-phone" placeholder="Number to call: +15551234567" maxlength="16">
                        <input type="text" id="testTransferNumber" class="input-phone" placeholder="Transfer to: +15559876543" maxlength="16">
                        <button type="button" class="btn btn-test" id="testCallBtn">Start Test Call</button>
                    </div>
                    <div class="test-results-box" id="testResultsBox" style="display:none;">
                        <div class="test-results-title">Test Results</div>
                        <div id="testResult" class="test-result-status">Status: Idle</div>
                    </div>
                </div>
            </div>

            <!-- Campaign Form -->
            <form id="campaignForm">

            <div class="panel" id="panelPhoneNumbers">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                        Phone Numbers
                        <button type="button" class="panel-minimize" data-panel="panelPhoneNumbers" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>Upload CSV file</label>
                    <input type="file" name="csv_file" id="csvFile" accept=".csv,.txt">
                    <label>Or paste numbers (one per line)</label>
                    <textarea name="numbers" id="numbersInput" rows="4" placeholder="+15551234567&#10;+15559876543"></textarea>
                </div>
            </div>

            <div class="panel" id="panelVmAudio">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
                        Voicemail Audio <span style="font-weight:400;font-size:11px;color:var(--text-secondary);">(optional - uses saved URL if empty)</span>
                        <button type="button" class="panel-minimize" data-panel="panelVmAudio" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>Upload MP3/WAV to override saved voicemail</label>
                    <input type="file" name="audio_file" id="audioFile" accept=".mp3,.wav">
                    <label>Or provide a different public audio URL</label>
                    <input type="text" name="audio_url" id="audioUrl" placeholder="https://example.com/voicemail.mp3">
                </div>
            </div>

                <!-- Transfer Number -->
            <div class="panel" id="panelTransfer">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 014-4h12"/></svg>
                        Transfer Number
                        <button type="button" class="panel-minimize" data-panel="panelTransfer" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>If a human answers, transfer the call to</label>
                    <div class="transfer-row">
                        <div class="transfer-input-wrap">
                            <input type="text" name="transfer_number" id="transferNumber" class="input-phone" placeholder="+15551112222" maxlength="16" required>
                        </div>
                        <button type="button" class="btn-save-transfer" id="saveTransferBtn">Save for future</button>
                    </div>
                    <div class="saved-indicator" id="savedIndicator">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        Saved &mdash; auto-fills next time
                    </div>
                </div>
            </div>

            <!-- Call Analytics Panel -->
            <div class="panel" id="panelAnalytics">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Call Analytics
                        <button type="button" class="panel-minimize" data-panel="panelAnalytics" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div id="analyticsContent">
                        <div class="analytics-stats-grid">
                            <div class="analytics-stat-card">
                                <div class="analytics-stat-value" id="statTotalCalls">0</div>
                                <div class="analytics-stat-label">Total Calls</div>
                            </div>
                            <div class="analytics-stat-card stat-success">
                                <div class="analytics-stat-value" id="statSuccessRate">0%</div>
                                <div class="analytics-stat-label">Success Rate</div>
                            </div>
                            <div class="analytics-stat-card stat-transfer">
                                <div class="analytics-stat-value" id="statTransferRate">0%</div>
                                <div class="analytics-stat-label">Transfer Rate</div>
                            </div>
                            <div class="analytics-stat-card stat-voicemail">
                                <div class="analytics-stat-value" id="statVoicemailRate">0%</div>
                                <div class="analytics-stat-label">Voicemail Rate</div>
                            </div>
                            <div class="analytics-stat-card">
                                <div class="analytics-stat-value" id="statAvgRing">0s</div>
                                <div class="analytics-stat-label">Avg Ring Time</div>
                            </div>
                        </div>
                        <div class="analytics-charts-grid">
                            <div class="analytics-chart-card">
                                <div class="analytics-chart-title">AMD Detection Results</div>
                                <canvas id="chartAMD" height="200"></canvas>
                            </div>
                            <div class="analytics-chart-card">
                                <div class="analytics-chart-title">Best Times to Call</div>
                                <canvas id="chartHourly" height="200"></canvas>
                            </div>
                            <div class="analytics-chart-card">
                                <div class="analytics-chart-title">Daily Call Volume</div>
                                <canvas id="chartDaily" height="200"></canvas>
                            </div>
                            <div class="analytics-chart-card">
                                <div class="analytics-chart-title">Hangup Causes</div>
                                <canvas id="chartHangup" height="200"></canvas>
                            </div>
                        </div>
                        <button type="button" class="btn btn-refresh-analytics" onclick="loadAnalytics()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                            Refresh Analytics
                        </button>
                    </div>
                </div>
            </div>

            <!-- DNC List Panel -->
            <div class="panel" id="panelDNC">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                        Do Not Call List
                        <button type="button" class="panel-minimize" data-panel="panelDNC" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="dnc-add-row">
                        <input type="text" id="dncNumberInput" class="input-phone" placeholder="+15551112222" maxlength="16">
                        <button type="button" class="btn btn-add-dnc" onclick="addDNC()">Add to DNC</button>
                    </div>
                    <div class="dnc-count" id="dncCount">0 numbers blocked</div>
                    <div class="dnc-list-container" id="dncListContainer">
                        <div class="dnc-empty">No numbers on DNC list</div>
                    </div>
                </div>
            </div>

            <!-- Campaign Scheduling Panel -->
            <div class="panel" id="panelSchedule">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Schedule Campaign
                        <button type="button" class="panel-minimize" data-panel="panelSchedule" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="schedule-form">
                        <label>Date & Time (your local time)</label>
                        <input type="datetime-local" id="scheduleTime" class="input-schedule-time">
                        <label>Transfer Number</label>
                        <input type="text" id="scheduleTransfer" class="input-phone" placeholder="+15551112222" maxlength="16">
                        <label>Phone Numbers (one per line)</label>
                        <textarea id="scheduleNumbers" class="input-schedule-numbers" rows="4" placeholder="+15551112222&#10;+15553334444"></textarea>
                        <button type="button" class="btn btn-schedule" onclick="createSchedule()">Schedule Campaign</button>
                    </div>
                    <div class="schedule-list-title">Scheduled Campaigns</div>
                    <div id="scheduleListContainer">
                        <div class="schedule-empty">No scheduled campaigns</div>
                    </div>
                </div>
            </div>

            <!-- Webhook Status Monitor -->
            <div class="panel" id="panelWebhook">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                        Webhook Monitor
                        <button type="button" class="panel-minimize" data-panel="panelWebhook" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="battery-hero" id="webhookBatteryHero">
                        <div class="battery-container">
                            <div class="battery-body">
                                <div class="battery-fill" id="batteryFill">
                                    <div class="battery-wave"></div>
                                    <div class="battery-wave battery-wave-2"></div>
                                </div>
                                <div class="battery-shimmer"></div>
                                <div class="battery-bolt" id="batteryBolt">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none">
                                        <path d="M13 2L4.5 12.5H12L11 22L19.5 11.5H12L13 2Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="battery-percent" id="batteryPercent">0%</div>
                            </div>
                            <div class="battery-tip"></div>
                            <div class="battery-glow" id="batteryGlow"></div>
                        </div>
                        <div class="battery-label" id="batteryLabel">Checking...</div>
                    </div>
                    <div class="webhook-status-grid">
                        <div class="webhook-stat">
                            <div class="webhook-stat-label">Total Received</div>
                            <div class="webhook-stat-value" id="webhookTotal">0</div>
                        </div>
                        <div class="webhook-stat">
                            <div class="webhook-stat-label">Last Received</div>
                            <div class="webhook-stat-value" id="webhookLastTime">Never</div>
                        </div>
                        <div class="webhook-stat">
                            <div class="webhook-stat-label">Last Event</div>
                            <div class="webhook-stat-value" id="webhookLastEvent">-</div>
                        </div>
                    </div>
                    <div class="webhook-section-title">Events by Type</div>
                    <div id="webhookEventTypes" class="webhook-events-grid"></div>
                    <div class="webhook-section-title">Recent Events</div>
                    <div id="webhookRecentEvents" class="webhook-recent-list"></div>
                    <div class="webhook-section-title" id="webhookErrorsTitle" style="display:none;">Errors</div>
                    <div id="webhookErrors" class="webhook-errors-list"></div>
                    <button type="button" class="btn btn-refresh-analytics" onclick="loadWebhookStatus()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                        Refresh Status
                    </button>
                </div>
            </div>

            <!-- Campaign Templates -->
            <div class="panel" id="panelTemplates">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        Campaign Templates
                        <button type="button" class="panel-minimize" data-panel="panelTemplates" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="template-save-section">
                        <label>Save Current Settings as Template</label>
                        <div class="template-save-row">
                            <input type="text" id="templateName" class="input-full" placeholder="My Campaign Template" maxlength="50">
                            <button type="button" class="btn btn-save-template" onclick="saveTemplate()">Save Template</button>
                        </div>
                    </div>
                    <div class="template-list-title">Saved Templates</div>
                    <div id="templateListContainer">
                        <div class="template-empty">No saved templates</div>
                    </div>
                </div>
            </div>

            <!-- Number Validation -->
            <div class="panel" id="panelValidation">
                <div class="card">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Number Validation
                        <button type="button" class="panel-minimize" data-panel="panelValidation" title="Minimize">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <label>Paste phone numbers to validate (one per line)</label>
                    <textarea id="validateNumbersInput" class="input-schedule-numbers" rows="5" placeholder="+15551112222&#10;+15553334444&#10;invalid-number"></textarea>
                    <button type="button" class="btn btn-validate" onclick="validateNumbers()">Validate Numbers</button>
                    <div id="validationResults" style="display:none;">
                        <div class="validation-summary" id="validationSummary"></div>
                        <div id="validationDetails"></div>
                    </div>
                </div>
            </div>

                <!-- Dial Mode -->
                <div class="card stagger-6">
                    <div class="card-title">
                        <svg class="card-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
                        Dial Mode
                    </div>
                    <label>Choose how calls are placed</label>
                    <div class="dial-mode-toggle">
                        <button type="button" class="dial-mode-btn active" data-mode="sequential" id="modeSeq">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                            Sequential
                        </button>
                        <button type="button" class="dial-mode-btn" data-mode="simultaneous" id="modeSimul">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            Simultaneous
                        </button>
                    </div>
                    <input type="hidden" name="dial_mode" id="dialModeInput" value="sequential">
                    <div class="batch-size-wrap" id="dialDelayWrap">
                        <label>Delay between calls</label>
                        <div class="batch-size-row">
                            <input type="number" name="dial_delay" id="dialDelay" class="input-batch" value="2" min="1" max="10">
                            <span class="batch-hint">1â€“10 minutes between each call</span>
                        </div>
                    </div>
                    <div class="batch-size-wrap" id="batchSizeWrap" style="display:none;">
                        <label>Calls per batch</label>
                        <div class="batch-size-row">
                            <input type="number" name="batch_size" id="batchSize" class="input-batch" value="5" min="2" max="50">
                            <span class="batch-hint">2â€“50 calls fired at once per batch</span>
                        </div>
                    </div>
                    <div class="dial-mode-desc" id="dialModeDesc">Calls are placed one at a time with a configurable delay between each call.</div>
                </div>

                <!-- Buttons -->
                <div class="button-group stagger-7">
                    <button type="submit" class="btn btn-start" id="startBtn">Start Campaign</button>
                    <button type="button" class="btn btn-stop" id="stopBtn" disabled>Stop Campaign</button>
                </div>
            </form>

            <!-- Call Log -->
            <div class="log-section stagger-8">
                <div class="log-header">
                    <h2>
                        <svg class="log-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Call Log
                    </h2>
                    <div class="log-header-actions">
                        <span id="callCount" class="call-count">0 calls</span>
                        <button type="button" class="btn-clear-logs" id="clearLogsBtn" title="Clear all call logs">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="filter-row">
                    <label class="filter-label">Filter:</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="all">All Calls</option>
                        <option value="success">Successful (VM Dropped / Transferred)</option>
                        <option value="failed">Failed / Disconnected</option>
                        <option value="issues">Warnings / Issues</option>
                        <option value="progress">In Progress</option>
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="callTable">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Destination</th>
                                <th>Caller ID</th>
                                <th>Status Description</th>
                                <th>Ring</th>
                                <th>Machine?</th>
                                <th>Transferred</th>
                                <th>Voicemail</th>
                                <th>Transcript</th>
                            </tr>
                        </thead>
                        <tbody id="callBody">
                            <tr><td colspan="9" class="empty-row">No calls yet</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="download-section">
                    <div class="download-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download Report
                    </div>
                    <div class="download-filters">
                        <div class="download-preset-row">
                            <button type="button" class="download-preset active" data-range="all">All Time</button>
                            <button type="button" class="download-preset" data-range="today">Today</button>
                            <button type="button" class="download-preset" data-range="week">This Week</button>
                            <button type="button" class="download-preset" data-range="month">This Month</button>
                            <button type="button" class="download-preset" data-range="custom">Custom</button>
                        </div>
                        <div class="download-custom-row" id="customDateRow" style="display:none;">
                            <div class="date-field">
                                <label>From</label>
                                <input type="datetime-local" id="reportStart" class="input-date">
                            </div>
                            <div class="date-field">
                                <label>To</label>
                                <input type="datetime-local" id="reportEnd" class="input-date">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-download" id="downloadReportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download CSV
                    </button>
                </div>
            </div>
        </div>

        </div> <!-- /app-layout -->

        <!-- FOOTER -->
        <footer class="oh-footer">
            <div class="oh-footer-content">
                <div class="oh-footer-section">
                    <div class="oh-footer-logo">
                        <div class="oh-brand-name">Open Human</div>
                        <p class="oh-footer-tagline">Empowering businesses with intelligent communication solutions</p>
                    </div>
                </div>
                <div class="oh-footer-section">
                    <h4>Product</h4>
                    <ul>
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Documentation</a></li>
                        <li><a href="#">API Reference</a></li>
                    </ul>
                </div>
                <div class="oh-footer-section">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Support</a></li>
                    </ul>
                </div>
                <div class="oh-footer-section">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">TCPA Compliance</a></li>
                    </ul>
                </div>
            </div>
            <div class="oh-footer-bottom">
                <div class="oh-footer-copyright">&copy; 2026 Open Human. All rights reserved.</div>
                <div class="oh-footer-socials">
                    <a href="#" aria-label="Twitter">&#120143;</a>
                    <a href="#" aria-label="LinkedIn">in</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        window.apiFetch = function(url, opts) {
                var defaults = { credentials: "include", headers: {} };
                var merged = Object.assign({}, defaults, opts || {});
                if (!merged.body || !(merged.body instanceof FormData)) {
                    merged.headers["X-Requested-With"] = "XMLHttpRequest";
                } else {
                    var h = new Headers(merged.headers || {});
                    h.set("X-Requested-With", "XMLHttpRequest");
                    merged.headers = h;
                }
                return fetch(url, merged).then(function(r) {
                    if (r.status === 401) {
                        window.location.href = "/login";
                        throw new Error("auth");
                    }
                    return r;
                });
            };

            // ---- Splash Screen ----
            setTimeout(function() {
                document.getElementById("splash").classList.add("hide");
                document.getElementById("app").classList.add("show");
            }, 2900);

            // ---- Sidebar Panel Toggle ----
            var sidebarBtns = document.querySelectorAll(".sidebar-btn");
            var minimizeBtns = document.querySelectorAll(".panel-minimize");

            function togglePanel(panelId) {
                var panel = document.getElementById(panelId);
                var btn = document.querySelector('.sidebar-btn[data-panel="' + panelId + '"]');
                if (!panel || !btn) return;

                var isOpen = panel.classList.contains("open");

                if (isOpen) {
                    panel.classList.remove("open");
                    btn.classList.remove("active");
                } else {
                    panel.classList.add("open");
                    btn.classList.add("active");
                    if (panelId === "panelAnalytics" && typeof loadAnalytics === "function") loadAnalytics();
                    if (panelId === "panelDNC" && typeof loadDNC === "function") loadDNC();
                    if (panelId === "panelSchedule" && typeof loadSchedules === "function") loadSchedules();
                    if (panelId === "panelWebhook" && typeof loadWebhookStatus === "function") loadWebhookStatus();
                    if (panelId === "panelTemplates" && typeof loadTemplates === "function") loadTemplates();
                    setTimeout(function() {
                        panel.scrollIntoView({ behavior: "smooth", block: "start" });
                    }, 100);
                }
            }

            sidebarBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    togglePanel(this.getAttribute("data-panel"));
                });
            });

            minimizeBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    togglePanel(this.getAttribute("data-panel"));
                });
            });

            // ---- Theme Toggle ----
            var themeToggle = document.getElementById("themeToggle");
            function getCurrentTheme() {
                return document.documentElement.getAttribute("data-theme") || "dark";
            }
            themeToggle.addEventListener("click", function() {
                var next = getCurrentTheme() === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("vb_theme", next);
            });

            // ---- Fullscreen Toggle ----
            var fsBtn = document.getElementById("fullscreenToggle");
            fsBtn.addEventListener("click", function() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    var el = document.documentElement;
                    if (el.requestFullscreen) el.requestFullscreen();
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                }
            });
            function onFsChange() {
                document.body.classList.toggle("is-fullscreen", !!(document.fullscreenElement || document.webkitFullscreenElement));
            }
            document.addEventListener("fullscreenchange", onFsChange);
            document.addEventListener("webkitfullscreenchange", onFsChange);

            // ---- Scroll Reveal + Mouse Glow Effect on Cards ----
            (function() {
                document.documentElement.classList.add("js-scroll-ready");
                var animEls = document.querySelectorAll(".card, .log-section");

                if ("IntersectionObserver" in window) {
                    var observer = new IntersectionObserver(function(entries) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                entry.target.classList.add("scroll-visible");
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.12, rootMargin: "0px 0px -40px 0px" });

                    animEls.forEach(function(el, i) {
                        el.classList.add("scroll-reveal");
                        el.style.transitionDelay = (i * 0.07) + "s";
                        observer.observe(el);
                    });
                }

                animEls.forEach(function(el) {
                    el.addEventListener("mousemove", function(e) {
                        var rect = el.getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        var y = e.clientY - rect.top;
                        el.style.setProperty("--glow-x", x + "px");
                        el.style.setProperty("--glow-y", y + "px");
                        el.classList.add("card-glow-active");
                    });
                    el.addEventListener("mouseleave", function() {
                        el.classList.remove("card-glow-active");
                    });
                });

            })();

            // ---- Ripple Effect ----
            document.addEventListener("click", function(e) {
                var btn = e.target.closest(".btn, .btn-save-transfer, .btn-clear-logs");
                if (!btn || btn.disabled) return;
                var rect = btn.getBoundingClientRect();
                var ripple = document.createElement("span");
                ripple.className = "ripple";
                var size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + "px";
                ripple.style.left = (e.clientX - rect.left - size / 2) + "px";
                ripple.style.top = (e.clientY - rect.top - size / 2) + "px";
                btn.style.position = "relative";
                btn.style.overflow = "hidden";
                btn.appendChild(ripple);
                setTimeout(function() { ripple.remove(); }, 500);
            });

            // ---- Elements ----
            var form = document.getElementById("campaignForm");
            var startBtn = document.getElementById("startBtn");
            var stopBtn = document.getElementById("stopBtn");
            var callBody = document.getElementById("callBody");
            var callCount = document.getElementById("callCount");
            var statusFilter = document.getElementById("statusFilter");
            statusFilter.addEventListener("change", function() { pollStatus(); });
            var campaignStatus = document.getElementById("campaignStatus");
            var testCallBtn = document.getElementById("testCallBtn");
            var testNumber = document.getElementById("testNumber");
            var testResult = document.getElementById("testResult");
            var testResultsBox = document.getElementById("testResultsBox");
            var transferNumber = document.getElementById("transferNumber");
            var saveTransferBtn = document.getElementById("saveTransferBtn");
            var savedIndicator = document.getElementById("savedIndicator");
            var clearLogsBtn = document.getElementById("clearLogsBtn");

            // ---- Voicemail Settings ----
            var vmUrlInput = document.getElementById("vmUrlInput");
            var saveVmBtn = document.getElementById("saveVmBtn");
            var vmPreview = document.getElementById("vmPreview");
            var vmAudioPlayer = document.getElementById("vmAudioPlayer");
            var vmDuration = document.getElementById("vmDuration");
            var vmSaveResult = document.getElementById("vmSaveResult");

            function loadVmSettings() {
                apiFetch("/api/voicemail_settings")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.voicemail_url) {
                            vmUrlInput.value = data.voicemail_url;
                            showVmPreview(data.voicemail_url);
                        }
                    })
                    .catch(function() {});
            }

            function showVmPreview(url) {
                if (!url) { vmPreview.style.display = "none"; return; }
                vmAudioPlayer.src = url;
                vmPreview.style.display = "";
                vmAudioPlayer.addEventListener("loadedmetadata", function() {
                    var dur = Math.round(vmAudioPlayer.duration);
                    vmDuration.textContent = "Duration: " + dur + " seconds";
                });
                vmAudioPlayer.addEventListener("error", function() {
                    vmDuration.textContent = "Could not load audio preview";
                });
            }

            saveVmBtn.addEventListener("click", function() {
                var url = vmUrlInput.value.trim();
                if (!url) { alert("Enter a voicemail URL"); return; }
                saveVmBtn.disabled = true;
                saveVmBtn.textContent = "Saving...";
                apiFetch("/api/voicemail_settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ voicemail_url: url })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    if (data.error) {
                        vmSaveResult.innerHTML = '<span style="color:var(--danger);">' + data.error + '</span>';
                    } else {
                        vmSaveResult.innerHTML = '<span style="color:var(--success);">Voicemail URL saved</span>';
                        showVmPreview(url);
                        setTimeout(function() { vmSaveResult.textContent = ""; }, 3000);
                    }
                })
                .catch(function(e) {
                    if (e.message === "auth") return;
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    vmSaveResult.innerHTML = '<span style="color:var(--danger);">Failed to save</span>';
                });
            });

            loadVmSettings();

            // ---- Load Saved Transfer Number ----
            var saved = localStorage.getItem("vb_transfer_number");
            if (saved) {
                transferNumber.value = saved;
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
            }

            // ---- Save Transfer Number ----
            saveTransferBtn.addEventListener("click", function() {
                var num = transferNumber.value.trim();
                if (!num) return;
                localStorage.setItem("vb_transfer_number", num);
                savedIndicator.classList.add("show");
                saveTransferBtn.textContent = "Update";
                saveTransferBtn.style.borderColor = "var(--success)";
                saveTransferBtn.style.color = "var(--success)";
                setTimeout(function() {
                    saveTransferBtn.style.borderColor = "";
                    saveTransferBtn.style.color = "";
                }, 1500);
            });

            // ---- Dial Mode Toggle ----
            var modeSeq = document.getElementById("modeSeq");
            var modeSimul = document.getElementById("modeSimul");
            var dialModeInput = document.getElementById("dialModeInput");
            var batchSizeWrap = document.getElementById("batchSizeWrap");
            var dialDelayWrap = document.getElementById("dialDelayWrap");
            var dialModeDesc = document.getElementById("dialModeDesc");

            function setDialMode(mode) {
                dialModeInput.value = mode;
                modeSeq.classList.toggle("active", mode === "sequential");
                modeSimul.classList.toggle("active", mode === "simultaneous");
                if (mode === "simultaneous") {
                    batchSizeWrap.style.display = "";
                    dialDelayWrap.style.display = "none";
                    dialModeDesc.textContent = "Multiple calls are fired at the same time in batches for faster dialing.";
                } else {
                    batchSizeWrap.style.display = "none";
                    dialDelayWrap.style.display = "";
                    dialModeDesc.textContent = "Calls are placed one at a time with a configurable delay between each call.";
                }
            }

            modeSeq.addEventListener("click", function() { setDialMode("sequential"); });
            modeSimul.addEventListener("click", function() { setDialMode("simultaneous"); });

            // ---- Download Report ----
            var downloadBtn = document.getElementById("downloadReportBtn");
            var customDateRow = document.getElementById("customDateRow");
            var reportStart = document.getElementById("reportStart");
            var reportEnd = document.getElementById("reportEnd");
            var presetBtns = document.querySelectorAll(".download-preset");
            var selectedRange = "all";

            presetBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    presetBtns.forEach(function(b) { b.classList.remove("active"); });
                    btn.classList.add("active");
                    selectedRange = btn.getAttribute("data-range");
                    customDateRow.style.display = selectedRange === "custom" ? "" : "none";
                });
            });

            function getDateRange() {
                var now = new Date();
                var start = "", end = "";
                if (selectedRange === "today") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "week") {
                    var d = new Date(now);
                    d.setDate(d.getDate() - d.getDay());
                    start = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "month") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-01T00:00:00";
                } else if (selectedRange === "custom") {
                    start = reportStart.value ? reportStart.value + ":00" : "";
                    end = reportEnd.value ? reportEnd.value + ":59" : "";
                }
                return { start: start, end: end };
            }

            downloadBtn.addEventListener("click", function() {
                var range = getDateRange();
                var params = new URLSearchParams();
                if (range.start) params.set("start", range.start);
                if (range.end) params.set("end", range.end);
                var url = "/download_report" + (params.toString() ? "?" + params.toString() : "");
                window.location.href = url;
            });

            // ---- Clear Call Logs ----
            clearLogsBtn.addEventListener("click", function() {
                if (!confirm("Clear all call logs?")) return;
                clearLogsBtn.disabled = true;
                apiFetch("/clear_logs", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        clearLogsBtn.disabled = false;
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        callBody.innerHTML = '<tr><td colspan="8" class="empty-row">No calls yet</td></tr>';
                        callCount.textContent = "0 calls";
                    })
                    .catch(function(e) {
                        clearLogsBtn.disabled = false;
                        if (e.message !== "auth") alert("Failed to clear logs");
                    });
            });

            // ---- Test Call ----
            var _testCallId = null;
            var _testCallNumber = null;
            var _testCallActive = false;

            function updateTestStatus(msg, color) {
                testResult.innerHTML = '<span style="color:' + (color || 'var(--text-secondary)') + ';">' + msg + '</span>';
            }

            function trackTestCallStatus() {
                if (!_testCallActive) return;
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.calls || !_testCallActive) return;
                        var found = null;
                        for (var i = 0; i < data.calls.length; i++) {
                            var c = data.calls[i];
                            if (_testCallId && c.call_id && c.call_id.indexOf(_testCallId.substring(0, 12)) === 0) {
                                found = c;
                                break;
                            }
                            if (!found && c.number === _testCallNumber && c.is_live) {
                                found = c;
                            }
                        }
                        if (!found) return;

                        var desc = found.status_description || found.status;
                        var colorMap = { green: "var(--success)", red: "var(--danger)", yellow: "#F59E0B", blue: "var(--accent)" };
                        var col = colorMap[found.status_color] || "var(--text-secondary)";
                        updateTestStatus(desc, col);

                        var doneStatuses = ["voicemail_complete","transferred","hangup","transfer_failed","human_no_transfer","no_answer"];
                        if (doneStatuses.indexOf(found.status) !== -1) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            if (found.voicemail_dropped) {
                                updateTestStatus("Voicemail dropped! Check your phone to hear the message.", "var(--success)");
                            } else if (found.transferred) {
                                updateTestStatus("Human detected! In a real campaign, this would transfer to your destination number.", "var(--success)");
                            }
                        } else {
                            setTimeout(trackTestCallStatus, 1000);
                        }
                    })
                    .catch(function() {
                        if (_testCallActive) setTimeout(trackTestCallStatus, 2000);
                    });
            }

            testCallBtn.addEventListener("click", function() {
                var number = testNumber.value.trim();
                if (!number) { alert("Enter a phone number"); return; }
                var transferNum = document.getElementById("testTransferNumber").value.trim();
                if (!transferNum) { alert("Enter a transfer number for human-answered calls"); return; }

                testCallBtn.disabled = true;
                testCallBtn.textContent = "Calling...";
                testResultsBox.style.display = "";
                updateTestStatus("Dialing...", "var(--accent)");

                _testCallNumber = number;
                _testCallId = null;
                _testCallActive = true;

                var formData = new FormData();
                formData.append("test_number", number);
                formData.append("transfer_number", transferNum);

                apiFetch("/test_call", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            updateTestStatus(data.error, "var(--danger)");
                        } else {
                            _testCallId = data.call_control_id || null;
                            updateTestStatus("Ringing...", "var(--accent)");
                            pollStatus();
                            setTimeout(trackTestCallStatus, 1500);
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        _testCallActive = false;
                        testCallBtn.disabled = false;
                        testCallBtn.textContent = "Start Test Call";
                        updateTestStatus("Request failed", "var(--danger)");
                    });
            });

            // ---- Start Campaign ----
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                var formData = new FormData(form);
                startBtn.disabled = true;
                startBtn.textContent = "Starting...";

                apiFetch("/start", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                            startBtn.disabled = false;
                            startBtn.textContent = "Start Campaign";
                        } else {
                            stopBtn.disabled = false;
                            startBtn.textContent = "Campaign Running...";
                            pollStatus();
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        alert("Failed to start campaign");
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Stop Campaign ----
            stopBtn.addEventListener("click", function() {
                apiFetch("/stop", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function() {
                        stopBtn.disabled = true;
                        startBtn.disabled = false;
                        startBtn.textContent = "Start Campaign";
                    });
            });

            // ---- Status Helpers ----
            function getStatusClass(status) {
                switch(status) {
                    case "transferred":
                    case "voicemail_complete": return "status-success";
                    case "voicemail_playing":
                    case "test_call_ringing":
                    case "ringing":
                    case "answered":
                    case "human_detected": return "status-active";
                    case "machine_detected": return "status-warning";
                    case "hangup": return "status-neutral";
                    case "initiated": return "status-pending";
                    case "no_answer":
                    case "transfer_failed":
                    case "human_no_transfer": return "status-error";
                    default: return "";
                }
            }

            function formatStatus(s) {
                if (s === "initiated") return "Dialing...";
                if (s === "test_call_ringing") return "Ringing";
                if (s === "human_no_transfer") return "Human (No Transfer #)";
                if (s === "transfer_failed") return "Transfer Failed";
                return s.replace(/_/g, " ").replace(/\b\w/g, function(l) { return l.toUpperCase(); });
            }

            function formatRing(secs) {
                if (secs === null || secs === undefined) return "-";
                if (secs < 60) return secs + "s";
                return Math.floor(secs / 60) + "m " + (secs % 60) + "s";
            }

            function maskNumber(n) {
                if (!n || n.length < 5) return n || "-";
                return n;
            }

            // ---- Polling ----
            var pollInterval = 2000;
            var pollTimer = null;
            var isActive = false;

            function pollStatus() {
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var bar = document.getElementById("campaignStatus");
                        var wasActive = isActive;
                        isActive = data.active;

                        if (data.active && data.transfer_paused) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign paused &mdash; live transfer in progress';
                        } else if (data.active) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-active"></span> Campaign active &mdash; ' + data.total + ' numbers';
                        } else if (data.stop_requested) {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign stopping...';
                        } else {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-inactive"></span> No active campaign';
                            if (data.calls && data.calls.length > 0) {
                                startBtn.disabled = false;
                                startBtn.textContent = "Start Campaign";
                                stopBtn.disabled = true;
                            }
                        }

                        var hasLiveCalls = false;
                        var count = data.calls ? data.calls.length : 0;
                        callCount.textContent = count + " call" + (count !== 1 ? "s" : "");

                        var filterVal = statusFilter.value;

                        if (data.calls && data.calls.length > 0) {
                            var filtered = data.calls.filter(function(c) {
                                if (filterVal === "all") return true;
                                var col = c.status_color || "";
                                if (filterVal === "success") return col === "green";
                                if (filterVal === "failed") return col === "red";
                                if (filterVal === "issues") return col === "yellow";
                                if (filterVal === "progress") return col === "blue";
                                return true;
                            });

                            var liveStatuses = ["initiated","ringing","test_call_ringing","answered","human_detected","machine_detected","voicemail_playing","transferred","connected"];

                            var html = "";
                            filtered.forEach(function(c, idx) {
                                var isLive = liveStatuses.indexOf(c.status) !== -1;
                                if (isLive) hasLiveCalls = true;
                                var tsDisplay = "-";
                                if (c.timestamp) {
                                    try {
                                        var d = new Date(c.timestamp);
                                        if (!isNaN(d.getTime())) {
                                            tsDisplay = d.toLocaleDateString(undefined, {month:"short", day:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
                                        }
                                    } catch(e) {}
                                }
                                var descText = c.status_description || formatStatus(c.status);
                                var colorCls = "status-" + (c.status_color || "blue");

                                var rowCls = isLive ? "call-row-live" : "";
                                html += '<tr class="' + rowCls + '">';
                                html += '<td class="td-ts">' + tsDisplay + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.number) + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.from_number) + "</td>";
                                html += '<td><span class="status-desc-badge ' + colorCls + '">' + descText;
                                if (isLive) html += ' <span class="live-pulse"></span>';
                                html += "</span></td>";
                                html += "<td>" + formatRing(c.ring_duration) + "</td>";
                                html += "<td>" + (c.machine_detected === null ? "-" : (c.machine_detected ? "Yes" : "No")) + "</td>";
                                html += "<td>" + (c.transferred ? "Yes" : "-") + "</td>";
                                html += "<td>" + (c.voicemail_dropped ? "Yes" : "-") + "</td>";

                                var hasTranscript = c.transcript && c.transcript.length > 0;
                                var trId = "tr_" + idx;
                                if (isLive) {
                                    if (hasTranscript) {
                                        html += '<td><span class="transcript-live-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> LIVE</span></td>';
                                    } else {
                                        html += '<td><span class="transcript-waiting"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/></svg> Listening...</span></td>';
                                    }
                                } else if (hasTranscript) {
                                    html += '<td><button type="button" class="btn-transcript" onclick="toggleTranscript(\'' + trId + '\')">';
                                    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>';
                                    html += ' View</button></td>';
                                } else {
                                    html += "<td>-</td>";
                                }
                                html += '</tr>';

                                if (isLive) {
                                    html += '<tr class="transcript-row transcript-row-live" id="' + trId + '" style="display:table-row;"><td colspan="9"><div class="transcript-box transcript-box-live">';
                                    html += '<div class="transcript-header-live"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> Live Transcription <span class="live-dot"></span></div>';
                                    if (hasTranscript) {
                                        c.transcript.forEach(function(t) {
                                            var speaker = t.track === "outbound" ? "Agent" : "Caller";
                                            var cls = t.track === "outbound" ? "transcript-outbound" : "transcript-inbound";
                                            var safeText = (t.text || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
                                            html += '<div class="transcript-line ' + cls + '"><strong>' + speaker + ':</strong> ' + safeText + '</div>';
                                        });
                                    } else {
                                        html += '<div class="transcript-empty">Waiting for speech...</div>';
                                    }
                                    html += '</div></td></tr>';
                                } else if (hasTranscript) {
                                    html += '<tr class="transcript-row" id="' + trId + '" style="display:none;"><td colspan="9"><div class="transcript-box">';
                                    c.transcript.forEach(function(t) {
                                        var speaker = t.track === "outbound" ? "Agent" : "Caller";
                                        var cls = t.track === "outbound" ? "transcript-outbound" : "transcript-inbound";
                                        var safeText = (t.text || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
                                        html += '<div class="transcript-line ' + cls + '"><strong>' + speaker + ':</strong> ' + safeText + '</div>';
                                    });
                                    html += '</div></td></tr>';
                                }
                            });
                            if (filtered.length > 0) {
                                callBody.innerHTML = html;
                            } else {
                                callBody.innerHTML = '<tr><td colspan="9" class="empty-row">No matching calls</td></tr>';
                            }
                        } else if (count === 0) {
                            callBody.innerHTML = '<tr><td colspan="9" class="empty-row">No calls yet</td></tr>';
                        }

                        adjustPollSpeed(data.active || hasLiveCalls);
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                    });
            }

            window.toggleTranscript = function(id) {
                var row = document.getElementById(id);
                if (row) {
                    row.style.display = row.style.display === "none" ? "table-row" : "none";
                }
            };

            function adjustPollSpeed(fast) {
                var newInterval = fast ? 1000 : 3000;
                if (newInterval !== pollInterval) {
                    pollInterval = newInterval;
                    clearInterval(pollTimer);
                    pollTimer = setInterval(pollStatus, pollInterval);
                }
            }

            pollTimer = setInterval(pollStatus, pollInterval);
            pollStatus();
    </script>

    <!-- POWERED BY BADGE -->
    <div class="oh-powered-badge">
        <span class="oh-powered-text">Powered by</span>
        <span class="oh-powered-brand">Open Human</span>
        <span class="oh-powered-pulse"></span>
    </div>

    <!-- FLOATING NOTEPAD -->
    <button class="notepad-fab" id="notepadFab" title="Open Notepad">N</button>
    <div class="notepad-window" id="notepadWindow">
        <div class="notepad-header" id="notepadHeader">
            <div class="notepad-header-left">
                <div class="notepad-header-logo">N</div>
                <span class="notepad-header-title">Notepad</span>
            </div>
            <div class="notepad-header-actions">
                <button class="notepad-float-toggle active" id="notepadFloatToggle" title="Toggle float/stick">Float</button>
                <button id="notepadClear" title="Clear All">&#128465;</button>
                <button id="notepadMin" title="Minimize">&minus;</button>
            </div>
        </div>
        <div class="notepad-toolbar" id="notepadToolbar">
            <button data-cmd="bold" title="Bold"><b>B</b></button>
            <button data-cmd="italic" title="Italic"><i>I</i></button>
            <button data-cmd="underline" title="Underline"><u>U</u></button>
            <button data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
            <div class="sep"></div>
            <select id="npFontSize" title="Font Size">
                <option value="1">Small</option>
                <option value="3" selected>Normal</option>
                <option value="5">Large</option>
                <option value="7">Huge</option>
            </select>
            <div class="sep"></div>
            <input type="color" id="npTextColor" value="#06B6D4" title="Text Color">
            <input type="color" id="npHighlight" value="#FFFF00" title="Highlight Color">
            <button data-cmd="removeFormat" title="Remove Formatting">&#10006;</button>
            <div class="sep"></div>
            <button data-cmd="insertUnorderedList" title="Bullet List">&#8226;</button>
            <button data-cmd="insertOrderedList" title="Numbered List">1.</button>
            <div class="sep"></div>
            <button data-cmd="justifyLeft" title="Align Left">&#8676;</button>
            <button data-cmd="justifyCenter" title="Align Center">&#8596;</button>
            <button data-cmd="justifyRight" title="Align Right">&#8677;</button>
        </div>
        <div class="notepad-body">
            <div class="notepad-editor" id="notepadEditor" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="notepad-footer">
            <span id="notepadCharCount">0 characters</span>
            <button id="notepadDownload" title="Download as text file">Download</button>
        </div>
    </div>

    <script>
    (function(){
        var fab = document.getElementById("notepadFab");
        var win = document.getElementById("notepadWindow");
        var header = document.getElementById("notepadHeader");
        var editor = document.getElementById("notepadEditor");
        var minBtn = document.getElementById("notepadMin");
        var clearBtn = document.getElementById("notepadClear");
        var charCount = document.getElementById("notepadCharCount");
        var downloadBtn = document.getElementById("notepadDownload");
        var floatToggle = document.getElementById("notepadFloatToggle");
        var fontSel = document.getElementById("npFontSize");
        var colorPick = document.getElementById("npTextColor");
        var hlPick = document.getElementById("npHighlight");
        var storageKey = "vb_notepad_content";
        var posKey = "vb_notepad_pos";
        var floatKey = "vb_notepad_float";
        var defaultBottom = 28, defaultRight = 28;
        var isDragging = false, dragX = 0, dragY = 0;

        var isFloating = localStorage.getItem(floatKey) !== "false";
        var fabSize = 56;
        var fabDragging = false, fabClicked = false;
        var fabX, fabY, fabVX = 0, fabVY = 0;
        var fabDragOffX = 0, fabDragOffY = 0;
        var fabLastMX = 0, fabLastMY = 0, fabLastTime = 0;
        var fabTrailX = [], fabTrailY = [], fabTrailT = [];
        var fabAnim = null;

        var gravity = 0.15;
        var friction = 0.995;
        var bounceDamp = 0.65;
        var restThreshold = 0.08;
        var idleDriftSpeed = 0.25;

        function initFabPos() {
            var rect = fab.getBoundingClientRect();
            fabX = rect.left;
            fabY = rect.top;
        }

        function applyFabPos() {
            fab.style.left = fabX + "px";
            fab.style.top = fabY + "px";
            fab.style.bottom = "auto";
            fab.style.right = "auto";
        }

        function physicsTick() {
            if (!isFloating || fab.classList.contains("hidden") || fabDragging) {
                fabAnim = requestAnimationFrame(physicsTick);
                return;
            }

            fabVX *= friction;
            fabVY *= friction;
            fabVY += gravity;

            fabX += fabVX;
            fabY += fabVY;

            var maxX = window.innerWidth - fabSize;
            var maxY = window.innerHeight - fabSize;

            if (fabY >= maxY) {
                fabY = maxY;
                fabVY = -Math.abs(fabVY) * bounceDamp;
                fabVX *= 0.98;
                if (Math.abs(fabVY) < 1.5) {
                    fabVY = 0;
                    if (Math.abs(fabVX) < restThreshold) {
                        fabVX = (Math.random() > 0.5 ? 1 : -1) * idleDriftSpeed;
                        fabVY = -(1 + Math.random() * 2);
                    }
                }
            }
            if (fabY <= 0) {
                fabY = 0;
                fabVY = Math.abs(fabVY) * bounceDamp;
            }
            if (fabX <= 0) {
                fabX = 0;
                fabVX = Math.abs(fabVX) * bounceDamp;
            }
            if (fabX >= maxX) {
                fabX = maxX;
                fabVX = -Math.abs(fabVX) * bounceDamp;
            }

            applyFabPos();
            fabAnim = requestAnimationFrame(physicsTick);
        }

        function startFloat() {
            isFloating = true;
            fab.classList.add("floating");
            floatToggle.classList.add("active");
            floatToggle.textContent = "Float";
            localStorage.setItem(floatKey, "true");
            initFabPos();
            fabVX = (Math.random() - 0.5) * 3;
            fabVY = -(2 + Math.random() * 3);
            if (!fabAnim) physicsTick();
        }

        function stopFloat() {
            isFloating = false;
            fab.classList.remove("floating");
            floatToggle.classList.remove("active");
            floatToggle.textContent = "Stick";
            localStorage.setItem(floatKey, "false");
            if (fabAnim) { cancelAnimationFrame(fabAnim); fabAnim = null; }
            fab.style.left = "";
            fab.style.top = "";
            fab.style.bottom = defaultBottom + "px";
            fab.style.right = defaultRight + "px";
        }

        function fabStartDrag(cx, cy) {
            if (!isFloating) return;
            fabDragging = true;
            fabClicked = true;
            var rect = fab.getBoundingClientRect();
            fabDragOffX = cx - rect.left;
            fabDragOffY = cy - rect.top;
            fabVX = 0;
            fabVY = 0;
            fabTrailX = [cx]; fabTrailY = [cy]; fabTrailT = [Date.now()];
            fab.style.cursor = "grabbing";
        }

        function fabMoveDrag(cx, cy) {
            if (!fabDragging) return;
            fabClicked = false;
            fabX = cx - fabDragOffX;
            fabY = cy - fabDragOffY;
            fabX = Math.max(0, Math.min(fabX, window.innerWidth - fabSize));
            fabY = Math.max(0, Math.min(fabY, window.innerHeight - fabSize));
            applyFabPos();
            var now = Date.now();
            fabTrailX.push(cx); fabTrailY.push(cy); fabTrailT.push(now);
            if (fabTrailX.length > 6) {
                fabTrailX.shift(); fabTrailY.shift(); fabTrailT.shift();
            }
        }

        function fabEndDrag() {
            if (!fabDragging) return;
            fabDragging = false;
            fab.style.cursor = "";
            var now = Date.now();
            var throwVX = 0, throwVY = 0;
            if (fabTrailX.length >= 2) {
                var idx = 0;
                for (var k = fabTrailT.length - 1; k >= 0; k--) {
                    if (now - fabTrailT[k] > 120) break;
                    idx = k;
                }
                var dt = (now - fabTrailT[idx]) || 1;
                throwVX = (fabTrailX[fabTrailX.length - 1] - fabTrailX[idx]) / dt * 16;
                throwVY = (fabTrailY[fabTrailY.length - 1] - fabTrailY[idx]) / dt * 16;
                var maxThrow = 30;
                throwVX = Math.max(-maxThrow, Math.min(maxThrow, throwVX));
                throwVY = Math.max(-maxThrow, Math.min(maxThrow, throwVY));
            }
            fabVX = throwVX;
            fabVY = throwVY;
        }

        fab.addEventListener("mousedown", function(e) {
            if (!isFloating) return;
            e.preventDefault();
            fabStartDrag(e.clientX, e.clientY);
        });
        document.addEventListener("mousemove", function(e) {
            if (fabDragging) { e.preventDefault(); fabMoveDrag(e.clientX, e.clientY); }
        });
        document.addEventListener("mouseup", function() {
            if (fabDragging) fabEndDrag();
        });

        fab.addEventListener("touchstart", function(e) {
            if (!isFloating) return;
            var t = e.touches[0];
            fabStartDrag(t.clientX, t.clientY);
        }, {passive: true});
        document.addEventListener("touchmove", function(e) {
            if (fabDragging) { var t = e.touches[0]; fabMoveDrag(t.clientX, t.clientY); }
        }, {passive: true});
        document.addEventListener("touchend", function() {
            if (fabDragging) fabEndDrag();
        });

        if (isFloating) {
            fab.classList.add("floating");
            setTimeout(function() {
                initFabPos();
                fabVX = (Math.random() - 0.5) * 2;
                fabVY = -(1 + Math.random() * 2);
                physicsTick();
            }, 600);
        } else {
            floatToggle.classList.remove("active");
            floatToggle.textContent = "Stick";
        }

        floatToggle.addEventListener("click", function(e) {
            e.preventDefault();
            if (isFloating) { stopFloat(); } else { startFloat(); }
        });

        var saved = localStorage.getItem(storageKey);
        if (saved) editor.innerHTML = saved;

        function updateCharCount() {
            var t = editor.innerText || "";
            var len = t.replace(/\n$/,"").length;
            charCount.textContent = len + " character" + (len !== 1 ? "s" : "");
        }
        updateCharCount();

        function saveContent() {
            localStorage.setItem(storageKey, editor.innerHTML);
            updateCharCount();
        }

        editor.addEventListener("input", saveContent);

        fab.addEventListener("click", function(e){
            if (isFloating && !fabClicked) return;
            fab.classList.add("hidden");
            win.classList.add("open");
            var pos = localStorage.getItem(posKey);
            if (pos) {
                try {
                    var p = JSON.parse(pos);
                    win.style.bottom = "auto";
                    win.style.right = "auto";
                    win.style.left = p.left + "px";
                    win.style.top = p.top + "px";
                } catch(e2) {}
            }
            editor.focus();
        });

        function closeNotepad() {
            win.classList.remove("open");
            fab.classList.remove("hidden");
            win.style.bottom = defaultBottom + "px";
            win.style.right = defaultRight + "px";
            win.style.left = "";
            win.style.top = "";
            if (isFloating) { initFabFloat(); }
        }

        minBtn.addEventListener("click", closeNotepad);

        clearBtn.addEventListener("click", function(){
            if (confirm("Clear all notes?")) {
                editor.innerHTML = "";
                saveContent();
            }
        });

        header.addEventListener("mousedown", function(e){
            if (e.target.tagName === "BUTTON") return;
            isDragging = true;
            var rect = win.getBoundingClientRect();
            dragX = e.clientX - rect.left;
            dragY = e.clientY - rect.top;
            e.preventDefault();
        });

        document.addEventListener("mousemove", function(e){
            if (!isDragging) return;
            var nx = e.clientX - dragX;
            var ny = e.clientY - dragY;
            nx = Math.max(0, Math.min(nx, window.innerWidth - 100));
            ny = Math.max(0, Math.min(ny, window.innerHeight - 50));
            win.style.left = nx + "px";
            win.style.top = ny + "px";
            win.style.bottom = "auto";
            win.style.right = "auto";
            localStorage.setItem(posKey, JSON.stringify({left: nx, top: ny}));
        });

        document.addEventListener("mouseup", function(){
            isDragging = false;
        });

        header.addEventListener("touchstart", function(e){
            if (e.target.tagName === "BUTTON") return;
            isDragging = true;
            var rect = win.getBoundingClientRect();
            var t = e.touches[0];
            dragX = t.clientX - rect.left;
            dragY = t.clientY - rect.top;
        }, {passive: true});

        document.addEventListener("touchmove", function(e){
            if (!isDragging) return;
            var t = e.touches[0];
            var nx = t.clientX - dragX;
            var ny = t.clientY - dragY;
            nx = Math.max(0, Math.min(nx, window.innerWidth - 100));
            ny = Math.max(0, Math.min(ny, window.innerHeight - 50));
            win.style.left = nx + "px";
            win.style.top = ny + "px";
            win.style.bottom = "auto";
            win.style.right = "auto";
            localStorage.setItem(posKey, JSON.stringify({left: nx, top: ny}));
        }, {passive: true});

        document.addEventListener("touchend", function(){
            isDragging = false;
        });

        var toolbarBtns = document.querySelectorAll(".notepad-toolbar button[data-cmd]");
        toolbarBtns.forEach(function(btn){
            btn.addEventListener("mousedown", function(e){
                e.preventDefault();
            });
            btn.addEventListener("click", function(){
                var cmd = this.getAttribute("data-cmd");
                document.execCommand(cmd, false, null);
                editor.focus();
                saveContent();
            });
        });

        fontSel.addEventListener("change", function(){
            document.execCommand("fontSize", false, this.value);
            editor.focus();
            saveContent();
        });

        colorPick.addEventListener("input", function(){
            document.execCommand("foreColor", false, this.value);
            editor.focus();
            saveContent();
        });

        hlPick.addEventListener("input", function(){
            document.execCommand("hiliteColor", false, this.value);
            editor.focus();
            saveContent();
        });

        downloadBtn.addEventListener("click", function(){
            var text = editor.innerText || "";
            var blob = new Blob([text], {type: "text/plain"});
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "openhuman-notes.txt";
            a.click();
            URL.revokeObjectURL(a.href);
        });

        document.addEventListener("keydown", function(e){
            if (e.key === "Escape" && win.classList.contains("open")) {
                closeNotepad();
            }
        });
    })();
    </script>

    <script>
    (function(){
        var canvas = document.getElementById("bgCanvas");
        if (!canvas) return;
        var ctx = canvas.getContext("2d");
        var W, H, particles = [], mouseX = -1000, mouseY = -1000;
        var PARTICLE_COUNT = 80;
        var CONNECTION_DIST = 160;
        var MOUSE_DIST = 200;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener("resize", resize);

        document.addEventListener("mousemove", function(e) {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        function Particle() {
            this.x = Math.random() * W;
            this.y = Math.random() * H;
            this.z = Math.random() * 1;
            this.vx = (Math.random() - 0.5) * 0.4;
            this.vy = (Math.random() - 0.5) * 0.4;
            this.vz = (Math.random() - 0.5) * 0.005;
            this.baseSize = 1.5 + Math.random() * 2;
            this.hue = Math.random() > 0.5 ? 264 : 187;
        }

        Particle.prototype.update = function() {
            this.x += this.vx;
            this.y += this.vy;
            this.z += this.vz;
            if (this.z < 0.1) { this.z = 0.1; this.vz = Math.abs(this.vz); }
            if (this.z > 1) { this.z = 1; this.vz = -Math.abs(this.vz); }
            if (this.x < 0) { this.x = 0; this.vx *= -1; }
            if (this.x > W) { this.x = W; this.vx *= -1; }
            if (this.y < 0) { this.y = 0; this.vy *= -1; }
            if (this.y > H) { this.y = H; this.vy *= -1; }
            var dx = mouseX - this.x, dy = mouseY - this.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < MOUSE_DIST) {
                var force = (MOUSE_DIST - dist) / MOUSE_DIST * 0.02;
                this.vx -= dx * force;
                this.vy -= dy * force;
            }
            var speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
            if (speed > 1.5) { this.vx *= 0.98; this.vy *= 0.98; }
        };

        Particle.prototype.draw = function() {
            var s = this.baseSize * (0.5 + this.z * 0.8);
            var alpha = 0.2 + this.z * 0.6;
            ctx.beginPath();
            ctx.arc(this.x, this.y, s, 0, Math.PI * 2);
            if (this.hue === 264) {
                ctx.fillStyle = "rgba(37, 99, 235, " + alpha + ")";
            } else {
                ctx.fillStyle = "rgba(6, 182, 212, " + alpha + ")";
            }
            ctx.fill();
            if (s > 2) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, s * 3, 0, Math.PI * 2);
                ctx.fillStyle = (this.hue === 264)
                    ? "rgba(37, 99, 235, " + (alpha * 0.08) + ")"
                    : "rgba(6, 182, 212, " + (alpha * 0.08) + ")";
                ctx.fill();
            }
        };

        for (var i = 0; i < PARTICLE_COUNT; i++) {
            particles.push(new Particle());
        }

        function drawConnections() {
            for (var i = 0; i < particles.length; i++) {
                for (var j = i + 1; j < particles.length; j++) {
                    var a = particles[i], b = particles[j];
                    var dx = a.x - b.x, dy = a.y - b.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < CONNECTION_DIST) {
                        var alpha = (1 - dist / CONNECTION_DIST) * 0.15 * Math.min(a.z, b.z);
                        var grad = ctx.createLinearGradient(a.x, a.y, b.x, b.y);
                        grad.addColorStop(0, "rgba(37, 99, 235, " + alpha + ")");
                        grad.addColorStop(1, "rgba(6, 182, 212, " + alpha + ")");
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y);
                        ctx.lineTo(b.x, b.y);
                        ctx.strokeStyle = grad;
                        ctx.lineWidth = 0.5 + Math.min(a.z, b.z) * 0.8;
                        ctx.stroke();
                    }
                }
            }
        }

        function drawMouseConnections() {
            if (mouseX < 0) return;
            for (var i = 0; i < particles.length; i++) {
                var p = particles[i];
                var dx = mouseX - p.x, dy = mouseY - p.y;
                var dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < MOUSE_DIST) {
                    var alpha = (1 - dist / MOUSE_DIST) * 0.25;
                    ctx.beginPath();
                    ctx.moveTo(mouseX, mouseY);
                    ctx.lineTo(p.x, p.y);
                    ctx.strokeStyle = "rgba(96, 165, 250, " + alpha + ")";
                    ctx.lineWidth = 0.8;
                    ctx.stroke();
                }
            }
        }

        function animate() {
            ctx.clearRect(0, 0, W, H);
            for (var i = 0; i < particles.length; i++) {
                particles[i].update();
            }
            drawConnections();
            drawMouseConnections();
            for (var i = 0; i < particles.length; i++) {
                particles[i].draw();
            }
            requestAnimationFrame(animate);
        }
        animate();
    })();

            // ---- Analytics ----
            var chartInstances = {};
            function loadAnalytics() {
                apiFetch("/api/analytics")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        document.getElementById("statTotalCalls").textContent = data.total_calls;
                        document.getElementById("statSuccessRate").textContent = data.success_rate + "%";
                        document.getElementById("statTransferRate").textContent = data.transfer_rate + "%";
                        document.getElementById("statVoicemailRate").textContent = data.voicemail_rate + "%";
                        document.getElementById("statAvgRing").textContent = data.avg_ring_duration + "s";

                        renderChart("chartAMD", "doughnut", {
                            labels: Object.keys(data.amd_accuracy),
                            datasets: [{
                                data: Object.values(data.amd_accuracy),
                                backgroundColor: ["#2563EB", "#06B6D4", "#F59E0B", "#EF4444", "#8B5CF6", "#6B7280"]
                            }]
                        });

                        var hours = Object.keys(data.hourly_distribution).sort(function(a,b){return parseInt(a)-parseInt(b);});
                        var hourLabels = hours.map(function(h){var hr=parseInt(h);return hr===0?"12am":hr<12?hr+"am":hr===12?"12pm":(hr-12)+"pm";});
                        renderChart("chartHourly", "bar", {
                            labels: hourLabels,
                            datasets: [{
                                label: "Total Calls",
                                data: hours.map(function(h){return data.hourly_distribution[h];}),
                                backgroundColor: "rgba(37, 99, 235, 0.6)",
                                borderColor: "#2563EB",
                                borderWidth: 1
                            },{
                                label: "Successful",
                                data: hours.map(function(h){return (data.hourly_success||{})[h]||0;}),
                                backgroundColor: "rgba(16, 185, 129, 0.6)",
                                borderColor: "#10B981",
                                borderWidth: 1
                            }]
                        });

                        var days = Object.keys(data.daily_distribution).sort();
                        renderChart("chartDaily", "line", {
                            labels: days.map(function(d){return d.substring(5);}),
                            datasets: [{
                                label: "Total",
                                data: days.map(function(d){return data.daily_distribution[d].total;}),
                                borderColor: "#2563EB",
                                backgroundColor: "rgba(37,99,235,0.1)",
                                fill: true,
                                tension: 0.3
                            },{
                                label: "Successful",
                                data: days.map(function(d){return data.daily_distribution[d].success;}),
                                borderColor: "#10B981",
                                backgroundColor: "rgba(16,185,129,0.1)",
                                fill: true,
                                tension: 0.3
                            }]
                        });

                        var hangupKeys = Object.keys(data.hangup_causes);
                        renderChart("chartHangup", "doughnut", {
                            labels: hangupKeys.map(function(k){return k.replace(/_/g," ");}),
                            datasets: [{
                                data: hangupKeys.map(function(k){return data.hangup_causes[k];}),
                                backgroundColor: ["#2563EB","#06B6D4","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899","#6B7280","#14B8A6","#F97316"]
                            }]
                        });
                    }).catch(function(e){ if(e.message==="auth")return; });
            }

            function renderChart(canvasId, type, data) {
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                var ctx = document.getElementById(canvasId);
                if (!ctx) return;
                var isDark = document.documentElement.getAttribute("data-theme") !== "light";
                var textColor = isDark ? "#94A3B8" : "#64748B";
                var gridColor = isDark ? "rgba(255,255,255,0.06)" : "rgba(0,0,0,0.08)";
                var opts = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: textColor, font: { size: 11 } } }
                    }
                };
                if (type === "bar" || type === "line") {
                    opts.scales = {
                        x: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor }, beginAtZero: true }
                    };
                }
                chartInstances[canvasId] = new Chart(ctx, { type: type, data: data, options: opts });
            }

            // ---- DNC List ----
            function loadDNC() {
                apiFetch("/api/dnc")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var list = data.dnc || [];
                        var container = document.getElementById("dncListContainer");
                        var countEl = document.getElementById("dncCount");
                        countEl.textContent = list.length + " number" + (list.length !== 1 ? "s" : "") + " blocked";
                        if (list.length === 0) {
                            container.innerHTML = '<div class="dnc-empty">No numbers on DNC list</div>';
                            return;
                        }
                        var html = '<div class="dnc-table-wrap"><table class="dnc-table"><thead><tr><th>Number</th><th>Reason</th><th>Added</th><th></th></tr></thead><tbody>';
                        list.forEach(function(entry) {
                            var addedAt = "-";
                            if (entry.added_at) {
                                try { var d = new Date(entry.added_at); addedAt = d.toLocaleDateString(undefined, {month:"short",day:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit",minute:"2-digit"}); } catch(e){}
                            }
                            html += '<tr><td class="td-mono">' + (entry.number||"").replace(/&/g,"&amp;").replace(/</g,"&lt;") + '</td>';
                            html += '<td>' + (entry.reason||"manual") + '</td>';
                            html += '<td>' + addedAt + '</td>';
                            html += '<td><button type="button" class="btn-dnc-remove" onclick="removeDNC(\'' + (entry.number||"").replace(/'/g,"\\'") + '\')">Remove</button></td></tr>';
                        });
                        html += '</tbody></table></div>';
                        container.innerHTML = html;
                    }).catch(function(e){ if(e.message==="auth")return; });
            }

            function addDNC() {
                var input = document.getElementById("dncNumberInput");
                var number = input.value.trim();
                if (!number) return;
                apiFetch("/api/dnc", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({number: number, reason: "manual"})
                }).then(function(r) { return r.json(); })
                  .then(function(data) {
                    input.value = "";
                    loadDNC();
                }).catch(function(e){ if(e.message==="auth")return; });
            }

            function removeDNC(number) {
                apiFetch("/api/dnc", {
                    method: "DELETE",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({number: number})
                }).then(function(r) { return r.json(); })
                  .then(function() { loadDNC(); })
                  .catch(function(e){ if(e.message==="auth")return; });
            }

            // ---- Campaign Scheduling ----
            function loadSchedules() {
                apiFetch("/api/schedules")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var list = data.schedules || [];
                        var container = document.getElementById("scheduleListContainer");
                        var active = list.filter(function(s){ return s.status === "pending"; });
                        var past = list.filter(function(s){ return s.status !== "pending"; });
                        if (list.length === 0) {
                            container.innerHTML = '<div class="schedule-empty">No scheduled campaigns</div>';
                            return;
                        }
                        var html = '';
                        active.forEach(function(s) {
                            var schedTime = "-";
                            try { var d = new Date(s.scheduled_time); schedTime = d.toLocaleDateString(undefined, {month:"short",day:"numeric",year:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit",minute:"2-digit"}); } catch(e){}
                            html += '<div class="schedule-item schedule-pending">';
                            html += '<div class="schedule-item-header"><span class="schedule-badge badge-pending">Pending</span><span class="schedule-time">' + schedTime + '</span></div>';
                            html += '<div class="schedule-item-detail">' + (s.total_numbers||s.numbers.length) + ' numbers &bull; Transfer to ' + (s.transfer_number||"-") + '</div>';
                            html += '<button type="button" class="btn-schedule-cancel" onclick="cancelSchedule(\'' + s.id + '\')">Cancel</button>';
                            html += '</div>';
                        });
                        past.slice(-5).reverse().forEach(function(s) {
                            var schedTime = "-";
                            try { var d = new Date(s.scheduled_time); schedTime = d.toLocaleDateString(undefined, {month:"short",day:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit",minute:"2-digit"}); } catch(e){}
                            var badgeCls = s.status === "executed" ? "badge-executed" : "badge-cancelled";
                            var badgeText = s.status === "executed" ? "Executed" : "Cancelled";
                            html += '<div class="schedule-item schedule-past">';
                            html += '<div class="schedule-item-header"><span class="schedule-badge ' + badgeCls + '">' + badgeText + '</span><span class="schedule-time">' + schedTime + '</span></div>';
                            html += '<div class="schedule-item-detail">' + (s.total_numbers||0) + ' numbers</div>';
                            html += '</div>';
                        });
                        container.innerHTML = html;
                    }).catch(function(e){ if(e.message==="auth")return; });
            }

            function createSchedule() {
                var timeInput = document.getElementById("scheduleTime");
                var transferInput = document.getElementById("scheduleTransfer");
                var numbersInput = document.getElementById("scheduleNumbers");
                if (!timeInput.value || !transferInput.value.trim() || !numbersInput.value.trim()) {
                    alert("Please fill in all fields: time, transfer number, and phone numbers.");
                    return;
                }
                var localDate = new Date(timeInput.value);
                var utcISO = localDate.toISOString().replace("Z","").split(".")[0];
                apiFetch("/api/schedules", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        scheduled_time: utcISO,
                        transfer_number: transferInput.value.trim(),
                        numbers: numbersInput.value.trim(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC"
                    })
                }).then(function(r) { return r.json(); })
                  .then(function(data) {
                    if (data.error) { alert(data.error); return; }
                    timeInput.value = "";
                    numbersInput.value = "";
                    loadSchedules();
                }).catch(function(e){ if(e.message==="auth")return; });
            }

            function cancelSchedule(id) {
                apiFetch("/api/schedules/" + id + "/cancel", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function() { loadSchedules(); })
                    .catch(function(e){ if(e.message==="auth")return; });
            }

            // ---- Webhook Status Monitor ----
            var batteryAnimFrame = null;
            var currentBatteryLevel = 0;
            var targetBatteryLevel = 0;

            function animateBattery() {
                if (Math.abs(currentBatteryLevel - targetBatteryLevel) > 0.5) {
                    currentBatteryLevel += (targetBatteryLevel - currentBatteryLevel) * 0.04;
                    updateBatteryVisual(Math.round(currentBatteryLevel));
                    batteryAnimFrame = requestAnimationFrame(animateBattery);
                } else {
                    currentBatteryLevel = targetBatteryLevel;
                    updateBatteryVisual(targetBatteryLevel);
                }
            }

            function updateBatteryVisual(pct) {
                var fill = document.getElementById("batteryFill");
                var percentEl = document.getElementById("batteryPercent");
                var glow = document.getElementById("batteryGlow");
                var bolt = document.getElementById("batteryBolt");
                var label = document.getElementById("batteryLabel");
                var hero = document.getElementById("webhookBatteryHero");
                if (!fill) return;

                fill.style.height = pct + "%";
                percentEl.textContent = Math.round(pct) + "%";

                var color, glowColor, statusText;
                if (pct >= 80) {
                    color = "#30D158";
                    glowColor = "rgba(48, 209, 88, 0.4)";
                    statusText = "Fully Charged";
                    hero.className = "battery-hero battery-charging";
                    bolt.style.display = "flex";
                } else if (pct >= 20) {
                    color = "#FFD60A";
                    glowColor = "rgba(255, 214, 10, 0.3)";
                    statusText = "Warning";
                    hero.className = "battery-hero";
                    bolt.style.display = "none";
                } else {
                    color = "#FF453A";
                    glowColor = "rgba(255, 69, 58, 0.3)";
                    statusText = "No Data";
                    hero.className = "battery-hero battery-low";
                    bolt.style.display = "none";
                }

                fill.style.background = "linear-gradient(0deg, " + color + " 0%, " + color + "cc 100%)";
                glow.style.boxShadow = "0 0 30px " + glowColor + ", 0 0 60px " + glowColor;
                label.textContent = statusText;
                label.style.color = color;
            }

            function loadWebhookStatus() {
                apiFetch("/api/webhook-status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        document.getElementById("webhookTotal").textContent = data.total_received;
                        document.getElementById("webhookLastTime").textContent = data.last_received_ago || "Never";
                        document.getElementById("webhookLastEvent").textContent = (data.last_event_type || "-").replace("call.", "");

                        if (data.health === "healthy") {
                            targetBatteryLevel = 100;
                        } else if (data.health === "warning") {
                            targetBatteryLevel = 40;
                        } else {
                            targetBatteryLevel = 0;
                        }
                        if (batteryAnimFrame) cancelAnimationFrame(batteryAnimFrame);
                        batteryAnimFrame = requestAnimationFrame(animateBattery);

                        var evtHtml = "";
                        var evtKeys = Object.keys(data.events_by_type || {}).sort(function(a,b){ return (data.events_by_type[b]||0) - (data.events_by_type[a]||0); });
                        evtKeys.forEach(function(k) {
                            evtHtml += '<div class="webhook-event-pill"><span class="webhook-event-name">' + k.replace("call.","") + '</span><span class="webhook-event-count">' + data.events_by_type[k] + '</span></div>';
                        });
                        document.getElementById("webhookEventTypes").innerHTML = evtHtml || '<div class="webhook-empty">No events yet</div>';

                        var recentHtml = "";
                        (data.recent_events || []).slice(-15).reverse().forEach(function(evt) {
                            var t = "-";
                            try { var d = new Date(evt.time); t = d.toLocaleTimeString(undefined, {hour:"2-digit",minute:"2-digit",second:"2-digit"}); } catch(e){}
                            var cls = evt.success ? "evt-success" : "evt-error";
                            recentHtml += '<div class="webhook-recent-item ' + cls + '"><span class="webhook-recent-time">' + t + '</span><span class="webhook-recent-event">' + (evt.event||"").replace("call.","") + '</span>';
                            if (evt.call_id) recentHtml += '<span class="webhook-recent-callid">' + evt.call_id + '</span>';
                            recentHtml += '</div>';
                        });
                        document.getElementById("webhookRecentEvents").innerHTML = recentHtml || '<div class="webhook-empty">No recent events</div>';

                        var errors = data.errors || [];
                        var errTitle = document.getElementById("webhookErrorsTitle");
                        if (errors.length > 0) {
                            errTitle.style.display = "";
                            var errHtml = "";
                            errors.slice(-5).reverse().forEach(function(err) {
                                var t = "-";
                                try { var d = new Date(err.time); t = d.toLocaleTimeString(undefined, {hour:"2-digit",minute:"2-digit"}); } catch(e){}
                                errHtml += '<div class="webhook-error-item"><span class="webhook-error-time">' + t + '</span><span class="webhook-error-msg">' + (err.error||"").replace(/&/g,"&amp;").replace(/</g,"&lt;") + '</span></div>';
                            });
                            document.getElementById("webhookErrors").innerHTML = errHtml;
                        } else {
                            errTitle.style.display = "none";
                            document.getElementById("webhookErrors").innerHTML = "";
                        }
                    }).catch(function(e){ if(e.message==="auth")return; });
            }

            // ---- Campaign Templates ----
            function loadTemplates() {
                apiFetch("/api/templates")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var list = data.templates || [];
                        var container = document.getElementById("templateListContainer");
                        if (list.length === 0) {
                            container.innerHTML = '<div class="template-empty">No saved templates</div>';
                            return;
                        }
                        var html = "";
                        list.forEach(function(t) {
                            var created = "-";
                            try { var d = new Date(t.created_at); created = d.toLocaleDateString(undefined, {month:"short",day:"numeric"}); } catch(e){}
                            html += '<div class="template-item">';
                            html += '<div class="template-item-header"><span class="template-name">' + (t.name||"Untitled").replace(/&/g,"&amp;").replace(/</g,"&lt;") + '</span><span class="template-date">' + created + '</span></div>';
                            html += '<div class="template-item-detail">';
                            html += '<span>Mode: ' + (t.dial_mode||"sequential") + '</span>';
                            if (t.transfer_number) html += ' &bull; <span>Transfer: ' + t.transfer_number + '</span>';
                            if (t.dial_mode === "simultaneous") html += ' &bull; <span>Batch: ' + (t.batch_size||5) + '</span>';
                            else html += ' &bull; <span>Delay: ' + (t.dial_delay||2) + 'min</span>';
                            html += '</div>';
                            html += '<div class="template-actions">';
                            html += '<button type="button" class="btn-template-load" onclick=\'loadTemplate(' + JSON.stringify(t) + ')\'>Load</button>';
                            html += '<button type="button" class="btn-template-delete" onclick="deleteTemplate(\'' + t.id + '\')">Delete</button>';
                            html += '</div></div>';
                        });
                        container.innerHTML = html;
                    }).catch(function(e){ if(e.message==="auth")return; });
            }

            function saveTemplate() {
                var nameInput = document.getElementById("templateName");
                var name = nameInput.value.trim();
                if (!name) { alert("Please enter a template name."); return; }
                var transferEl = document.getElementById("transferNumber");
                var modeEl = document.getElementById("dialModeInput");
                var batchEl = document.getElementById("batchSize");
                var delayEl = document.getElementById("dialDelay");
                apiFetch("/api/templates", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        name: name,
                        transfer_number: transferEl ? transferEl.value : "",
                        dial_mode: modeEl ? modeEl.value : "sequential",
                        batch_size: batchEl ? parseInt(batchEl.value) : 5,
                        dial_delay: delayEl ? parseInt(delayEl.value) : 2,
                    })
                }).then(function(r) { return r.json(); })
                  .then(function(data) {
                    if (data.error) { alert(data.error); return; }
                    nameInput.value = "";
                    loadTemplates();
                }).catch(function(e){ if(e.message==="auth")return; });
            }

            function loadTemplate(t) {
                var transferEl = document.getElementById("transferNumber");
                var modeEl = document.getElementById("dialModeInput");
                var batchEl = document.getElementById("batchSize");
                var delayEl = document.getElementById("dialDelay");
                var modeSeq = document.getElementById("modeSeq");
                var modeSimul = document.getElementById("modeSimul");
                var batchWrap = document.getElementById("batchSizeWrap");
                var delayWrap = document.getElementById("dialDelayWrap");
                var descEl = document.getElementById("dialModeDesc");

                if (transferEl && t.transfer_number) transferEl.value = t.transfer_number;
                if (modeEl) modeEl.value = t.dial_mode || "sequential";
                if (batchEl) batchEl.value = t.batch_size || 5;
                if (delayEl) delayEl.value = t.dial_delay || 2;

                if (t.dial_mode === "simultaneous") {
                    if (modeSeq) modeSeq.classList.remove("active");
                    if (modeSimul) modeSimul.classList.add("active");
                    if (batchWrap) batchWrap.style.display = "";
                    if (delayWrap) delayWrap.style.display = "none";
                    if (descEl) descEl.textContent = "Multiple calls fired simultaneously in batches.";
                } else {
                    if (modeSeq) modeSeq.classList.add("active");
                    if (modeSimul) modeSimul.classList.remove("active");
                    if (batchWrap) batchWrap.style.display = "none";
                    if (delayWrap) delayWrap.style.display = "";
                    if (descEl) descEl.textContent = "Calls are placed one at a time with a configurable delay between each call.";
                }

                alert("Template '" + t.name + "' loaded! Settings have been applied to the campaign form.");
            }

            function deleteTemplate(id) {
                apiFetch("/api/templates/" + id, { method: "DELETE" })
                    .then(function(r) { return r.json(); })
                    .then(function() { loadTemplates(); })
                    .catch(function(e){ if(e.message==="auth")return; });
            }

            // ---- Number Validation ----
            function validateNumbers() {
                var input = document.getElementById("validateNumbersInput");
                var text = input.value.trim();
                if (!text) { alert("Please paste phone numbers to validate."); return; }
                apiFetch("/api/validate-numbers", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({numbers: text})
                }).then(function(r) { return r.json(); })
                  .then(function(data) {
                    var resultsDiv = document.getElementById("validationResults");
                    var summaryDiv = document.getElementById("validationSummary");
                    var detailsDiv = document.getElementById("validationDetails");
                    resultsDiv.style.display = "";

                    var summaryHtml = '<div class="validation-stats">';
                    summaryHtml += '<div class="val-stat"><span class="val-stat-num val-good">' + data.total_valid + '</span><span class="val-stat-label">Valid</span></div>';
                    summaryHtml += '<div class="val-stat"><span class="val-stat-num val-bad">' + data.total_invalid + '</span><span class="val-stat-label">Invalid</span></div>';
                    summaryHtml += '<div class="val-stat"><span class="val-stat-num val-dup">' + data.duplicates_removed + '</span><span class="val-stat-label">Duplicates</span></div>';
                    summaryHtml += '<div class="val-stat"><span class="val-stat-num val-dnc">' + data.dnc_blocked + '</span><span class="val-stat-label">DNC Blocked</span></div>';
                    summaryHtml += '</div>';
                    summaryDiv.innerHTML = summaryHtml;

                    var detailHtml = "";
                    if (data.invalid && data.invalid.length > 0) {
                        detailHtml += '<div class="validation-section-title">Invalid Numbers</div>';
                        detailHtml += '<div class="validation-invalid-list">';
                        data.invalid.forEach(function(item) {
                            detailHtml += '<div class="val-invalid-item"><span class="val-invalid-num">' + (item.number||"").replace(/&/g,"&amp;").replace(/</g,"&lt;") + '</span><span class="val-invalid-reason">' + (item.reason||"") + '</span></div>';
                        });
                        detailHtml += '</div>';
                    }
                    if (data.valid && data.valid.length > 0) {
                        detailHtml += '<div class="validation-section-title">Valid Numbers (' + data.valid.length + ')</div>';
                        detailHtml += '<button type="button" class="btn-copy-valid" onclick="copyValidNumbers()">Copy Valid Numbers</button>';
                        detailHtml += '<div class="validation-valid-list" id="validNumbersList">';
                        data.valid.forEach(function(n) {
                            detailHtml += '<div class="val-valid-item">' + n + '</div>';
                        });
                        detailHtml += '</div>';
                    }
                    detailsDiv.innerHTML = detailHtml;
                }).catch(function(e){ if(e.message==="auth")return; });
            }

            function copyValidNumbers() {
                var items = document.querySelectorAll("#validNumbersList .val-valid-item");
                var text = "";
                items.forEach(function(el) { text += el.textContent + "\n"; });
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text.trim());
                    alert("Valid numbers copied to clipboard!");
                }
            }

    </script>
</body>
</html>
