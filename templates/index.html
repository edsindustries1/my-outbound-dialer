<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Human</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        (function(){var t=localStorage.getItem("vb_theme");if(t)document.documentElement.setAttribute("data-theme",t);})();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-glow"></div>
        <div class="splash-logo-wrap">
            <div class="splash-icon">
                <div class="splash-ring-outer"></div>
                <div class="splash-ring-inner"></div>
                <div class="splash-text-logo">Open Human</div>
            </div>
            <div class="splash-subtitle">Intelligent Communication at Scale</div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- MAIN APP -->
    <div id="app">
        <canvas id="bgCanvas"></canvas>
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        <div class="bg-glow bg-glow-3"></div>

        <!-- ===== SIDEBAR ===== -->
        <div class="gads-sidebar" id="gadsSidebar">
            <div class="gads-sidebar-logo" onclick="navigateTo('dashboard')" style="cursor:pointer;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gads-primary)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <span class="gads-logo-text">Open Human</span>
            </div>
            <nav class="gads-sidebar-nav">
                <a class="gads-nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span>Dashboard</span>
                </a>
                <a class="gads-nav-item" data-page="campaigns" onclick="navigateTo('campaigns')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    <span>Campaigns</span>
                </a>
                <a class="gads-nav-item" data-page="voicemails" onclick="navigateTo('voicemails')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    <span>Voicemails</span>
                </a>
                <a class="gads-nav-item" data-page="contacts" onclick="navigateTo('contacts')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                    <span>Contacts</span>
                </a>
                <a class="gads-nav-item" data-page="livecalls" onclick="navigateTo('livecalls')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                    <span>Live Calls</span>
                </a>
                <a class="gads-nav-item" data-page="reports" onclick="navigateTo('reports')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    <span>Reports</span>
                </a>
                <a class="gads-nav-item" data-page="settings" onclick="navigateTo('settings')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    <span>Settings</span>
                </a>
            </nav>
            <div class="gads-sidebar-footer">
                <button class="gads-collapse-btn" id="sidebarCollapseBtn" onclick="toggleSidebar()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    <span>Collapse</span>
                </button>
            </div>
        </div>

        <!-- ===== MAIN CONTENT ===== -->
        <div class="gads-main" id="gadsMain">
            <!-- TOP BAR -->
            <div class="gads-topbar">
                <h1 class="gads-page-title" id="gadsPageTitle">Dashboard</h1>
                <div class="gads-topbar-right">
                    <span class="gads-status-indicator"><span class="gads-status-dot"></span> Active</span>
                    <button type="button" class="gads-topbar-btn" id="fullscreenToggle" title="Toggle fullscreen">
                        <svg class="icon-expand" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                        <svg class="icon-shrink" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                    </button>
                    <button type="button" class="gads-topbar-btn" id="themeToggle" title="Toggle theme">
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    </button>
                    <div class="gads-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                </div>
            </div>

            <!-- ===== CONTENT PAGES ===== -->
            <div class="gads-content">

                <!-- ==================== PAGE: DASHBOARD ==================== -->
                <div class="gads-page" id="page-dashboard">
                    <div class="gads-kpi-row">
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-blue"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72"/></svg></div>
                            <div class="gads-kpi-label">TODAY'S CALLS</div>
                            <div class="gads-kpi-value" id="qsTotalCalls">0</div>
                        </div>
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-green"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                            <div class="gads-kpi-label">CONNECTED</div>
                            <div class="gads-kpi-value" id="dashConnected">0</div>
                        </div>
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-purple"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/></svg></div>
                            <div class="gads-kpi-label">VOICEMAILS</div>
                            <div class="gads-kpi-value" id="qsVoicemails">0</div>
                        </div>
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-orange"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
                            <div class="gads-kpi-label">HOT LEADS</div>
                            <div class="gads-kpi-value" id="qsHotLeads">0</div>
                        </div>
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-teal"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                            <div class="gads-kpi-label">SUCCESS RATE</div>
                            <div class="gads-kpi-value" id="qsSuccessRate">0%</div>
                        </div>
                        <div class="gads-kpi-card">
                            <div class="gads-kpi-icon gads-kpi-status"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                            <div class="gads-kpi-label">CAMPAIGN</div>
                            <div class="gads-kpi-value gads-kpi-small" id="dashCampaignStatus">Idle</div>
                        </div>
                    </div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3>Recent Activity</h3>
                            <a class="gads-link" onclick="navigateTo('livecalls')">View All &rarr;</a>
                        </div>
                        <div class="gads-table-wrap">
                            <table class="gads-table">
                                <thead><tr><th>Time</th><th>Number</th><th>Status</th><th>Ring</th><th>AMD</th><th>Transfer</th><th>VM</th><th>Transcript</th></tr></thead>
                                <tbody id="dashRecentBody"><tr><td colspan="8" class="gads-empty">No recent calls</td></tr></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="gads-quick-actions">
                        <button class="gads-btn gads-btn-primary" onclick="navigateTo('campaigns'); setTimeout(function(){ openWizard(); }, 100);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New Campaign
                        </button>
                        <button class="gads-btn gads-btn-outline" onclick="navigateTo('settings')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3"/></svg>
                            Test Call
                        </button>
                        <button class="gads-btn gads-btn-outline" onclick="navigateTo('reports')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            View Reports
                        </button>
                    </div>
                </div>

                <!-- ==================== PAGE: CAMPAIGNS ==================== -->
                <div class="gads-page" id="page-campaigns" style="display:none">
                    <div class="gads-page-header">
                        <h2>Campaigns</h2>
                        <button class="gads-btn gads-btn-primary" onclick="openWizard()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New Campaign
                        </button>
                    </div>

                    <div class="gads-card">
                        <div class="gads-card-header"><h3>Campaign Status</h3></div>
                        <div class="status-bar stagger-1" id="campaignStatus">
                            <span class="dot dot-inactive"></span> No active campaign
                        </div>
                        <div class="campaign-progress-wrap" id="campaignProgressWrap" style="display:none;">
                            <div class="campaign-progress-info">
                                <span id="progressLabel">Dialed: 0 / 0</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="campaign-progress-bar">
                                <div class="campaign-progress-fill" id="progressFill" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="gads-campaign-stats">
                            <div class="gads-campaign-stat">
                                <div class="gads-campaign-stat-value" id="qsTotalCallsMon">0</div>
                                <div class="gads-campaign-stat-label">Total Calls</div>
                            </div>
                            <div class="gads-campaign-stat">
                                <div class="gads-campaign-stat-value" id="qsHotLeadsMon">0</div>
                                <div class="gads-campaign-stat-label">Hot Leads</div>
                            </div>
                            <div class="gads-campaign-stat">
                                <div class="gads-campaign-stat-value" id="qsVoicemailsMon">0</div>
                                <div class="gads-campaign-stat-label">Voicemails</div>
                            </div>
                            <div class="gads-campaign-stat">
                                <div class="gads-campaign-stat-value" id="qsSuccessRateMon">0%</div>
                                <div class="gads-campaign-stat-label">Success Rate</div>
                            </div>
                        </div>
                        <div class="gads-campaign-actions">
                            <button type="button" class="gads-btn gads-btn-danger" id="monitorStopBtn" onclick="document.getElementById('stopBtn').click()" disabled>Stop Campaign</button>
                        </div>
                    </div>

                    <div class="wiz-campaign-complete" id="wizCampaignComplete" style="display:none;">
                        <div class="wiz-complete-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#1e8e3e" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                        <h3>Campaign Complete!</h3>
                        <button type="button" class="gads-btn gads-btn-primary" onclick="navigateTo('dashboard')" style="margin-top:16px;">Back to Dashboard</button>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header"><h3>Campaign History</h3></div>
                        <div class="gads-table-wrap">
                            <table class="gads-table" id="historyTable">
                                <thead><tr><th>Date</th><th>Total Calls</th><th>Hot Leads</th><th>Voicemails</th><th>Failed</th><th>Success Rate</th></tr></thead>
                                <tbody id="historyBody"><tr><td colspan="6" class="gads-empty">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ===== WIZARD OVERLAY ===== -->
                <div class="gads-wizard-overlay" id="wizardOverlay" style="display:none;">
                    <div class="gads-wizard-panel">
                        <div class="gads-wizard-header">
                            <h2>Create New Campaign</h2>
                            <button class="gads-wizard-close" onclick="closeWizard()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>

                        <div class="wiz-stepper">
                            <div class="wiz-step wiz-step-active" data-step="1" id="wizStep1Ind"><div class="wiz-step-num">1</div><div class="wiz-step-label">Type</div></div>
                            <div class="wiz-step-line"></div>
                            <div class="wiz-step" data-step="2" id="wizStep2Ind"><div class="wiz-step-num">2</div><div class="wiz-step-label">Contacts</div></div>
                            <div class="wiz-step-line"></div>
                            <div class="wiz-step" data-step="3" id="wizStep3Ind"><div class="wiz-step-num">3</div><div class="wiz-step-label">Voicemail</div></div>
                            <div class="wiz-step-line"></div>
                            <div class="wiz-step" data-step="4" id="wizStep4Ind"><div class="wiz-step-num">4</div><div class="wiz-step-label">Settings</div></div>
                            <div class="wiz-step-line"></div>
                            <div class="wiz-step" data-step="5" id="wizStep5Ind"><div class="wiz-step-num">5</div><div class="wiz-step-label">Review</div></div>
                        </div>

                        <form id="campaignForm">
                            <!-- Step 1: Campaign Type -->
                            <div class="wiz-step-content" id="wizContent1">
                                <h2 class="wiz-step-title">Choose Campaign Type</h2>
                                <div class="wiz-type-cards">
                                    <div class="wiz-type-card wiz-type-selected" id="wizTypeOutbound" onclick="wizSelectType('outbound')">
                                        <div class="wiz-type-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></div>
                                        <div class="wiz-type-name">Outbound Campaign</div>
                                        <div class="wiz-type-desc">Automatically dial contacts, detect answering machines, drop voicemails, and transfer live-answered calls.</div>
                                        <div class="wiz-type-check"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Data Source -->
                            <div class="wiz-step-content" id="wizContent2" style="display:none;">
                                <h2 class="wiz-step-title">Add Phone Numbers</h2>
                                <div class="wiz-source-tabs">
                                    <button type="button" class="wiz-source-tab active" onclick="wizSwitchSource('csv')">Upload CSV</button>
                                    <button type="button" class="wiz-source-tab" onclick="wizSwitchSource('paste')">Paste Numbers</button>
                                </div>
                                <div id="wizSourceCSV">
                                    <div class="drop-zone" id="csvDropZone">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                        <span>Drag &amp; drop CSV here or <label for="csvFile" class="drop-zone-browse">browse</label></span>
                                        <input type="file" name="csv_file" id="csvFile" accept=".csv,.txt" style="display:none;">
                                        <div class="drop-zone-filename" id="csvFileName"></div>
                                    </div>
                                </div>
                                <div id="wizSourcePaste" style="display:none;">
                                    <label>Paste phone numbers (one per line)</label>
                                    <textarea name="numbers" id="numbersInput" rows="6" placeholder="+15551234567&#10;+15559876543"></textarea>
                                </div>
                                <div class="wiz-number-count" id="wizNumberCount"></div>
                            </div>

                            <!-- Step 3: Voicemail -->
                            <div class="wiz-step-content" id="wizContent3" style="display:none;">
                                <h2 class="wiz-step-title">Configure Voicemail</h2>
                                <div class="wiz-vm-tabs">
                                    <button type="button" class="wiz-vm-tab active" onclick="wizSwitchVmType('standard')">Standard Voicemail</button>
                                    <button type="button" class="wiz-vm-tab" onclick="wizSwitchVmType('personalized')">Personalized (AI)</button>
                                </div>
                                <div id="wizVmStandard">
                                    <p class="wiz-vm-desc">Same voicemail audio for all contacts. Upload a file, paste a URL, or use your saved default.</p>
                                    <div class="drop-zone" id="audioDropZone">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                        <span>Drag &amp; drop audio here or <label for="audioFile" class="drop-zone-browse">browse</label></span>
                                        <input type="file" name="audio_file" id="audioFile" accept=".mp3,.wav" style="display:none;">
                                        <div class="drop-zone-filename" id="audioFileName"></div>
                                    </div>
                                    <label>Or provide a public audio URL</label>
                                    <input type="text" name="audio_url" id="audioUrl" placeholder="https://example.com/voicemail.mp3">
                                    <p class="wiz-vm-hint">Leave empty to use your saved default voicemail URL.</p>
                                </div>
                                <div id="wizVmPersonalized" style="display:none;">
                                    <p class="wiz-vm-desc">AI-generated unique voicemail for each contact. Configure in the Voicemails page first, then come back here.</p>
                                    <div class="wiz-pvm-status" id="wizPvmStatus">
                                        <span>Checking personalized voicemails...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Settings -->
                            <div class="wiz-step-content" id="wizContent4" style="display:none;">
                                <h2 class="wiz-step-title">Campaign Settings</h2>
                                <div class="wiz-settings-group">
                                    <label>Transfer Number <span style="font-size:11px;color:var(--gads-text-secondary);">(required)</span></label>
                                    <p class="wiz-settings-hint">If a human answers, transfer the call to this number.</p>
                                    <div class="transfer-row">
                                        <div class="transfer-input-wrap">
                                            <input type="text" name="transfer_number" id="transferNumber" class="gads-input" placeholder="+15551112222" maxlength="16" required>
                                        </div>
                                        <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" id="saveTransferBtn">Save</button>
                                    </div>
                                    <div class="saved-indicator" id="savedIndicator">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                                        Saved
                                    </div>
                                </div>
                                <div class="wiz-settings-group">
                                    <label>Dial Mode</label>
                                    <div class="dial-mode-toggle">
                                        <button type="button" class="dial-mode-btn active" data-mode="sequential" id="modeSeq">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                            Sequential
                                        </button>
                                        <button type="button" class="dial-mode-btn" data-mode="simultaneous" id="modeSimul">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                                            Simultaneous
                                        </button>
                                    </div>
                                    <input type="hidden" name="dial_mode" id="dialModeInput" value="sequential">
                                    <div class="batch-size-wrap" id="dialDelayWrap">
                                        <label>Delay between calls</label>
                                        <div class="batch-size-row">
                                            <input type="number" name="dial_delay" id="dialDelay" class="gads-input gads-input-sm" value="2" min="1" max="10">
                                            <span class="batch-hint">1&ndash;10 minutes</span>
                                        </div>
                                    </div>
                                    <div class="batch-size-wrap" id="batchSizeWrap" style="display:none;">
                                        <label>Calls per batch</label>
                                        <div class="batch-size-row">
                                            <input type="number" name="batch_size" id="batchSize" class="gads-input gads-input-sm" value="5" min="2" max="50">
                                            <span class="batch-hint">2&ndash;50 calls at once</span>
                                        </div>
                                    </div>
                                    <div class="dial-mode-desc" id="dialModeDesc">Calls are placed one at a time with a configurable delay between each call.</div>
                                </div>
                            </div>

                            <!-- Step 5: Review & Launch -->
                            <div class="wiz-step-content" id="wizContent5" style="display:none;">
                                <h2 class="wiz-step-title">Review &amp; Launch</h2>
                                <div class="wiz-review-cards">
                                    <div class="wiz-review-card"><div class="wiz-review-label">Campaign Type</div><div class="wiz-review-value" id="wizReviewType">Outbound Campaign</div></div>
                                    <div class="wiz-review-card"><div class="wiz-review-label">Phone Numbers</div><div class="wiz-review-value" id="wizReviewNumbers">0 numbers</div></div>
                                    <div class="wiz-review-card"><div class="wiz-review-label">Voicemail</div><div class="wiz-review-value" id="wizReviewVm">Standard</div></div>
                                    <div class="wiz-review-card"><div class="wiz-review-label">Transfer Number</div><div class="wiz-review-value" id="wizReviewTransfer">-</div></div>
                                    <div class="wiz-review-card"><div class="wiz-review-label">Dial Mode</div><div class="wiz-review-value" id="wizReviewMode">Sequential</div></div>
                                </div>
                                <div class="wiz-launch-wrap">
                                    <button type="submit" class="gads-btn gads-btn-primary gads-btn-lg" id="startBtn">
                                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                        Launch Campaign
                                    </button>
                                </div>
                            </div>

                            <button type="button" class="gads-btn gads-btn-danger" id="stopBtn" style="display:none;" disabled>Stop Campaign</button>
                        </form>

                        <div class="wiz-nav">
                            <button type="button" class="gads-btn gads-btn-outline" id="wizBackBtn" onclick="wizardBack()" style="display:none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                                Back
                            </button>
                            <button type="button" class="gads-btn gads-btn-primary" id="wizNextBtn" onclick="wizardNext()">
                                Next
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAGE: VOICEMAILS ==================== -->
                <div class="gads-page" id="page-voicemails" style="display:none">
                    <div class="gads-page-header">
                        <h2>Voicemail Library</h2>
                    </div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg> Voicemail Settings</h3>
                        </div>
                        <label>Voicemail Audio URL</label>
                        <div class="gads-input-row">
                            <input type="text" id="vmUrlInput" class="gads-input" placeholder="https://example.com/voicemail.mp3 or .wav">
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" id="saveVmBtn">Save</button>
                        </div>
                        <div class="vm-preview" id="vmPreview" style="display:none;">
                            <label>Audio Preview</label>
                            <audio id="vmAudioPlayer" controls preload="metadata" style="width:100%;margin-top:8px;"></audio>
                            <div class="vm-duration" id="vmDuration" style="margin-top:4px;font-size:12px;color:var(--gads-text-secondary);"></div>
                        </div>
                        <div id="vmSaveResult" style="margin-top:8px;font-size:13px;"></div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Personalized Voicemail (AI)</h3>
                        </div>

                        <div class="pvm-section">
                            <div class="pvm-section-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload Customer CSV</div>
                            <p class="pvm-hint">Columns: <code>First name</code>, <code>Last name</code>, <code>email</code>, <code>phone</code>, <code>address</code>, <code>amount</code>, <code>date</code></p>
                            <div class="pvm-upload-area">
                                <input type="file" id="pvmCsvFile" accept=".csv,.txt" style="display:none" onchange="pvmParseCSV()">
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="document.getElementById('pvmCsvFile').click()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    Upload CSV
                                </button>
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="pvmDownloadSample()" title="Download sample CSV">Sample CSV</button>
                                <span class="pvm-file-name" id="pvmFileName">No file selected</span>
                            </div>
                            <div id="pvmCsvResult" style="display:none;">
                                <div class="pvm-csv-stats" id="pvmCsvStats"></div>
                                <div class="pvm-csv-preview" id="pvmCsvPreview"></div>
                            </div>
                        </div>

                        <div class="pvm-section">
                            <div class="pvm-section-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Voicemail Script</div>
                            <p class="pvm-hint">Click tags to insert placeholders into your script.</p>
                            <div class="pvm-placeholders" id="pvmPlaceholders">
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('first_name')">{first_name}</span>
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('last_name')">{last_name}</span>
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('amount')">{amount}</span>
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('date')">{date}</span>
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('email')">{email}</span>
                                <span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder('address')">{address}</span>
                            </div>
                            <textarea id="pvmTemplate" class="gads-textarea" rows="6" oninput="pvmUpdateCharCount()" placeholder="Hi {first_name}, this is a friendly reminder about your account..."></textarea>
                            <div class="pvm-script-meta">
                                <span id="pvmCharCount">0 characters</span>
                                <span id="pvmEstDuration">~0s audio</span>
                            </div>
                            <div class="pvm-preview-actions">
                                <div class="pvm-contact-selector" id="pvmContactSelector" style="display:none;">
                                    <label class="pvm-small-label">Preview as:</label>
                                    <select id="pvmPreviewContact" class="gads-select" style="flex:1;"></select>
                                </div>
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="pvmPreview()" style="margin-top:4px;">Preview Text</button>
                            </div>
                            <div id="pvmPreviewResult" class="pvm-preview-box" style="display:none;"></div>
                        </div>

                        <div class="pvm-section">
                            <div class="pvm-section-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Select Voice</div>
                            <div class="pvm-voice-row">
                                <select id="pvmVoiceSelect" class="gads-select"><option value="">Loading voices...</option></select>
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="pvmLoadVoices()" title="Refresh voices"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg></button>
                            </div>
                        </div>

                        <div class="pvm-section">
                            <div class="pvm-section-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-6M6 20V10M18 20V4"/></svg> Voice Controls</div>
                            <div class="pvm-voice-controls">
                                <div class="pvm-slider-group">
                                    <div class="pvm-slider-header"><label>TTS Model</label></div>
                                    <select id="pvmModel" class="gads-select">
                                        <option value="eleven_multilingual_v2">Multilingual v2 (Best quality)</option>
                                        <option value="eleven_turbo_v2_5" selected>Turbo v2.5 (Fast + natural)</option>
                                        <option value="eleven_flash_v2_5">Flash v2.5 (Ultra-fast)</option>
                                        <option value="eleven_english_v1">English v1 (Classic)</option>
                                    </select>
                                </div>
                                <div class="pvm-slider-group"><div class="pvm-slider-header"><label>Stability</label><span class="pvm-slider-value" id="pvmStabilityVal">0.35</span></div><input type="range" id="pvmStability" min="0" max="100" value="35" class="pvm-slider" oninput="pvmUpdateSlider('Stability')"><div class="pvm-slider-labels"><span>Variable</span><span>Stable</span></div></div>
                                <div class="pvm-slider-group"><div class="pvm-slider-header"><label>Similarity</label><span class="pvm-slider-value" id="pvmSimilarityVal">0.80</span></div><input type="range" id="pvmSimilarity" min="0" max="100" value="80" class="pvm-slider" oninput="pvmUpdateSlider('Similarity')"><div class="pvm-slider-labels"><span>Low</span><span>High</span></div></div>
                                <div class="pvm-slider-group"><div class="pvm-slider-header"><label>Style</label><span class="pvm-slider-value" id="pvmStyleVal">0.15</span></div><input type="range" id="pvmStyle" min="0" max="100" value="15" class="pvm-slider" oninput="pvmUpdateSlider('Style')"><div class="pvm-slider-labels"><span>None</span><span>Expressive</span></div></div>
                                <div class="pvm-slider-group"><div class="pvm-slider-header"><label>Speed</label><span class="pvm-slider-value" id="pvmSpeedVal">0.82</span></div><input type="range" id="pvmSpeed" min="70" max="120" value="82" class="pvm-slider" oninput="pvmUpdateSlider('Speed')"><div class="pvm-slider-labels"><span>Slower</span><span>Faster</span></div></div>
                                <div class="pvm-toggles-compact">
                                    <div class="pvm-toggle-row"><label class="pvm-toggle-label"><input type="checkbox" id="pvmHumanize" checked><span class="pvm-toggle-switch"></span> Natural Speech</label></div>
                                    <div class="pvm-toggle-row"><label class="pvm-toggle-label"><input type="checkbox" id="pvmSpeakerBoost" checked><span class="pvm-toggle-switch"></span> Speaker Boost</label></div>
                                </div>
                            </div>
                        </div>

                        <div class="pvm-section" id="pvmLivePreviewSection" style="display:none;">
                            <div class="pvm-section-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Live Voice Preview</div>
                            <p class="pvm-hint">Hear how it sounds for a specific contact before generating all.</p>
                            <div class="pvm-live-preview-row">
                                <select id="pvmLivePreviewContact" class="gads-select" style="flex:1;"></select>
                                <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" id="pvmLivePreviewBtn" onclick="pvmLivePreview()">Generate Preview</button>
                            </div>
                            <div id="pvmLivePreviewStatus" class="pvm-live-status" style="display:none;">
                                <svg class="pvm-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                                <span>Generating voice preview...</span>
                            </div>
                            <div id="pvmLivePreviewPlayer" style="display:none;">
                                <div class="pvm-audio-player-wrap"><audio id="pvmPreviewAudio" controls style="width:100%;border-radius:8px;"></audio></div>
                                <div class="pvm-preview-script-text" id="pvmPreviewScriptText"></div>
                            </div>
                        </div>

                        <div class="pvm-section pvm-actions-section">
                            <div class="pvm-cost-estimate" id="pvmCostEstimate" style="display:none;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                                <span id="pvmCostText">Estimated cost: ~$0.00</span>
                            </div>
                            <button type="button" class="gads-btn gads-btn-primary" id="pvmGenerateBtn" onclick="pvmGenerate()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Generate All Personalized Voicemails</button>
                            <div id="pvmProgress" style="display:none;"><div class="pvm-progress-bar"><div class="pvm-progress-fill" id="pvmProgressFill"></div></div><div class="pvm-progress-text" id="pvmProgressText">Generating... 0/0</div></div>
                            <div id="pvmErrors" class="pvm-errors" style="display:none;"></div>
                        </div>

                        <div class="pvm-section" id="pvmStep4" style="display:none;">
                            <div class="pvm-section-label pvm-ready-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Ready to Dial</div>
                            <div class="pvm-ready-stats" id="pvmReadyStats"></div>
                            <div class="pvm-ready-actions">
                                <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="pvmLoadToDialer()">Load Numbers into Dialer</button>
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="pvmClearAll()">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAGE: CONTACTS ==================== -->
                <div class="gads-page" id="page-contacts" style="display:none">
                    <div class="gads-page-header"><h2>Contacts &amp; Lists</h2></div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Do Not Call List</h3>
                        </div>
                        <div class="gads-input-row">
                            <input type="text" id="dncNumberInput" class="gads-input" placeholder="+15551112222" maxlength="16">
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="addDNC()">Add to DNC</button>
                        </div>
                        <div class="dnc-count" id="dncCount" style="margin:12px 0;font-size:13px;color:var(--gads-text-secondary);">0 numbers blocked</div>
                        <div class="dnc-list-container" id="dncListContainer">
                            <div class="dnc-empty">No numbers on DNC list</div>
                        </div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Number Validation</h3>
                        </div>
                        <label>Paste phone numbers to validate (one per line)</label>
                        <textarea id="validateNumbersInput" class="gads-textarea" rows="5" placeholder="+15551112222&#10;+15553334444&#10;invalid-number"></textarea>
                        <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="validateNumbers()" style="margin-top:8px;">Validate Numbers</button>
                        <div id="validationResults" style="display:none;margin-top:12px;">
                            <div class="validation-summary" id="validationSummary"></div>
                            <div id="validationDetails"></div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAGE: LIVE CALLS ==================== -->
                <div class="gads-page" id="page-livecalls" style="display:none">
                    <div class="gads-page-header"><h2>Live Calls</h2></div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3>Call Log</h3>
                            <div class="gads-card-actions">
                                <span id="callCount" class="gads-badge">0 calls</span>
                                <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" id="clearLogsBtn" title="Clear all call logs">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="gads-filter-row">
                            <label class="gads-filter-label">Filter:</label>
                            <select id="statusFilter" class="gads-select gads-select-sm">
                                <option value="all">All Calls</option>
                                <option value="success">Successful</option>
                                <option value="failed">Failed</option>
                                <option value="issues">Warnings</option>
                                <option value="progress">In Progress</option>
                            </select>
                        </div>
                        <div class="gads-table-wrap">
                            <table class="gads-table" id="callTable">
                                <thead><tr><th>Date/Time</th><th>Destination</th><th>Caller ID</th><th>Status Description</th><th>Ring</th><th>Machine?</th><th>Transferred</th><th>Voicemail</th><th>Transcript</th></tr></thead>
                                <tbody id="callBody"><tr><td colspan="9" class="gads-empty">No calls yet</td></tr></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header"><h3>Download Report</h3></div>
                        <div class="download-filters">
                            <div class="download-preset-row">
                                <button type="button" class="download-preset active" data-range="all">All Time</button>
                                <button type="button" class="download-preset" data-range="today">Today</button>
                                <button type="button" class="download-preset" data-range="week">This Week</button>
                                <button type="button" class="download-preset" data-range="month">This Month</button>
                                <button type="button" class="download-preset" data-range="custom">Custom</button>
                            </div>
                            <div class="download-custom-row" id="customDateRow" style="display:none;">
                                <div class="date-field"><label>From</label><input type="datetime-local" id="reportStart" class="gads-input"></div>
                                <div class="date-field"><label>To</label><input type="datetime-local" id="reportEnd" class="gads-input"></div>
                            </div>
                        </div>
                        <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" id="downloadReportBtn" style="margin-top:12px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Download CSV
                        </button>
                    </div>
                </div>

                <!-- ==================== PAGE: REPORTS ==================== -->
                <div class="gads-page" id="page-reports" style="display:none">
                    <div class="gads-page-header"><h2>Reports</h2></div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Call Analytics</h3>
                            <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="loadAnalytics()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                                Refresh
                            </button>
                        </div>
                        <div id="analyticsContent">
                            <div class="analytics-stats-grid">
                                <div class="analytics-stat-card"><div class="analytics-stat-value" id="statTotalCalls">0</div><div class="analytics-stat-label">Total Calls</div></div>
                                <div class="analytics-stat-card stat-success"><div class="analytics-stat-value" id="statSuccessRate">0%</div><div class="analytics-stat-label">Success Rate</div></div>
                                <div class="analytics-stat-card stat-transfer"><div class="analytics-stat-value" id="statTransferRate">0%</div><div class="analytics-stat-label">Transfer Rate</div></div>
                                <div class="analytics-stat-card stat-voicemail"><div class="analytics-stat-value" id="statVoicemailRate">0%</div><div class="analytics-stat-label">Voicemail Rate</div></div>
                                <div class="analytics-stat-card"><div class="analytics-stat-value" id="statAvgRing">0s</div><div class="analytics-stat-label">Avg Ring Time</div></div>
                            </div>
                            <div class="analytics-charts-grid">
                                <div class="analytics-chart-card"><div class="analytics-chart-title">AMD Detection Results</div><canvas id="chartAMD" height="200"></canvas></div>
                                <div class="analytics-chart-card"><div class="analytics-chart-title">Best Times to Call</div><canvas id="chartHourly" height="200"></canvas></div>
                                <div class="analytics-chart-card"><div class="analytics-chart-title">Daily Call Volume</div><canvas id="chartDaily" height="200"></canvas></div>
                                <div class="analytics-chart-card"><div class="analytics-chart-title">Hangup Causes</div><canvas id="chartHangup" height="200"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg> Daily Email Reports</h3>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                                <div id="gmailStatusDot" style="width:10px;height:10px;border-radius:50%;background:#94A3B8;flex-shrink:0;"></div>
                                <span id="gmailStatusText" style="font-size:12px;color:var(--gads-text-secondary);">Checking Gmail connection...</span>
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                                <label style="font-size:13px;font-weight:600;">Enable Daily Reports</label>
                                <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;">
                                    <input type="checkbox" id="reportEnabled" style="opacity:0;width:0;height:0;" onchange="saveReportSettings()">
                                    <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--gads-border);border-radius:12px;transition:.3s;"></span>
                                    <span id="reportToggleKnob" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;pointer-events:none;"></span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:14px;">
                            <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Recipient Email</label>
                            <input type="email" id="reportEmail" class="gads-input" placeholder="your@email.com" onchange="saveReportSettings()">
                        </div>
                        <div style="margin-bottom:14px;">
                            <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Send Time (UTC, 24h format)</label>
                            <input type="time" id="reportSendTime" class="gads-input" value="08:00" style="width:140px;" onchange="saveReportSettings()">
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="sendTestReport()" id="testReportBtn">Send Test Report</button>
                            <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="checkGmailStatus()">Check Connection</button>
                        </div>
                        <div id="reportMessage" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:12px;"></div>
                        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--gads-border);">
                            <div style="font-size:11px;color:var(--gads-text-secondary);"><span id="reportLastSent">Last sent: Never</span></div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAGE: SETTINGS ==================== -->
                <div class="gads-page" id="page-settings" style="display:none">
                    <div class="gads-page-header"><h2>Settings</h2></div>

                    <div class="gads-card">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3"/></svg> Test Dialer</h3>
                        </div>
                        <label>Enter a phone number to test and a transfer number for human-answered calls.</label>
                        <div class="gads-input-row" style="margin-top:8px;">
                            <input type="text" id="testNumber" class="gads-input" placeholder="Number to call: +15551234567" maxlength="16">
                            <input type="text" id="testTransferNumber" class="gads-input" placeholder="Transfer to: +15559876543" maxlength="16">
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" id="testCallBtn">Start Test Call</button>
                        </div>
                        <div class="test-results-box" id="testResultsBox" style="display:none;margin-top:12px;">
                            <div class="test-results-title" style="font-weight:600;font-size:13px;margin-bottom:4px;">Test Results</div>
                            <div id="testResult" class="test-result-status">Status: Idle</div>
                        </div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Webhook Monitor</h3>
                            <button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="loadWebhookStatus()">Refresh</button>
                        </div>
                        <div class="battery-hero" id="webhookBatteryHero">
                            <div class="battery-container">
                                <div class="battery-body">
                                    <div class="battery-fill" id="batteryFill"><div class="battery-wave"></div><div class="battery-wave battery-wave-2"></div></div>
                                    <div class="battery-shimmer"></div>
                                    <div class="battery-bolt" id="batteryBolt"><svg viewBox="0 0 24 24" width="28" height="28" fill="none"><path d="M13 2L4.5 12.5H12L11 22L19.5 11.5H12L13 2Z" fill="currentColor"/></svg></div>
                                    <div class="battery-percent" id="batteryPercent">0%</div>
                                </div>
                                <div class="battery-tip"></div>
                                <div class="battery-glow" id="batteryGlow"></div>
                            </div>
                            <div class="battery-label" id="batteryLabel">Checking...</div>
                        </div>
                        <div class="webhook-status-grid">
                            <div class="webhook-stat"><div class="webhook-stat-label">Total Received</div><div class="webhook-stat-value" id="webhookTotal">0</div></div>
                            <div class="webhook-stat"><div class="webhook-stat-label">Last Received</div><div class="webhook-stat-value" id="webhookLastTime">Never</div></div>
                            <div class="webhook-stat"><div class="webhook-stat-label">Last Event</div><div class="webhook-stat-value" id="webhookLastEvent">-</div></div>
                        </div>
                        <div class="webhook-section-title">Events by Type</div>
                        <div id="webhookEventTypes" class="webhook-events-grid"></div>
                        <div class="webhook-section-title">Recent Events</div>
                        <div id="webhookRecentEvents" class="webhook-recent-list"></div>
                        <div class="webhook-section-title" id="webhookErrorsTitle" style="display:none;">Errors</div>
                        <div id="webhookErrors" class="webhook-errors-list"></div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Campaign Templates</h3>
                        </div>
                        <div class="gads-input-row" style="margin-bottom:12px;">
                            <input type="text" id="templateName" class="gads-input" placeholder="My Campaign Template" maxlength="50">
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="saveTemplate()">Save Template</button>
                        </div>
                        <div id="templateListContainer"><div class="template-empty" style="font-size:13px;color:var(--gads-text-secondary);">No saved templates</div></div>
                    </div>

                    <div class="gads-card" style="margin-top:20px;">
                        <div class="gads-card-header">
                            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Schedule Campaign</h3>
                        </div>
                        <div class="schedule-form">
                            <label>Date &amp; Time (your local time)</label>
                            <input type="datetime-local" id="scheduleTime" class="gads-input" style="margin-bottom:8px;">
                            <label>Transfer Number</label>
                            <input type="text" id="scheduleTransfer" class="gads-input" placeholder="+15551112222" maxlength="16" style="margin-bottom:8px;">
                            <label>Phone Numbers (one per line)</label>
                            <textarea id="scheduleNumbers" class="gads-textarea" rows="4" placeholder="+15551112222&#10;+15553334444"></textarea>
                            <button type="button" class="gads-btn gads-btn-primary gads-btn-sm" onclick="createSchedule()" style="margin-top:8px;">Schedule Campaign</button>
                        </div>
                        <div style="font-weight:600;font-size:13px;margin-top:16px;margin-bottom:8px;">Scheduled Campaigns</div>
                        <div id="scheduleListContainer">
                            <div class="schedule-empty" style="font-size:13px;color:var(--gads-text-secondary);">No scheduled campaigns</div>
                        </div>
                    </div>
                </div>

            </div><!-- end gads-content -->
        </div><!-- end gads-main -->

        <!-- Hidden elements for backward compat with existing JS -->
        <div id="viewDashboard" style="display:none"></div>
        <div id="viewWizard" style="display:none"></div>
        <div id="viewMonitor" style="display:none"></div>
        <div id="dashPanelWrap" style="display:none">
            <div class="wiz-dash-section" id="panelVmSettings" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelTestDialer" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelAnalytics" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelDNC" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelSchedule" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelWebhook" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelTemplates" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelValidation" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelPVM" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelEmailReports" style="display:none;"></div>
            <div class="wiz-dash-section" id="panelCampaignHistory" style="display:none;"></div>
        </div>
    </div>

    <!-- ===== NAVIGATION / VIEW SWITCHING SCRIPT ===== -->
    <script>
        var _gadsCurrentPage = 'dashboard';
        var _gadsPageTitles = {
            dashboard: 'Dashboard',
            campaigns: 'Campaigns',
            voicemails: 'Voicemails',
            contacts: 'Contacts & Lists',
            livecalls: 'Live Calls',
            reports: 'Reports',
            settings: 'Settings'
        };

        function navigateTo(page) {
            _gadsCurrentPage = page;
            var pages = document.querySelectorAll('.gads-page');
            pages.forEach(function(p) { p.style.display = 'none'; });
            var target = document.getElementById('page-' + page);
            if (target) target.style.display = '';

            var navItems = document.querySelectorAll('.gads-nav-item');
            navItems.forEach(function(item) {
                item.classList.toggle('active', item.getAttribute('data-page') === page);
            });

            var title = document.getElementById('gadsPageTitle');
            if (title) title.textContent = _gadsPageTitles[page] || page;

            if (page === 'reports') {
                if (typeof loadAnalytics === 'function') loadAnalytics();
                if (typeof loadCampaignHistory === 'function') loadCampaignHistory();
                if (typeof loadReportSettings === 'function') loadReportSettings();
                if (typeof checkGmailStatus === 'function') checkGmailStatus();
            }
            if (page === 'contacts') {
                if (typeof loadDNC === 'function') loadDNC();
            }
            if (page === 'settings') {
                if (typeof loadSchedules === 'function') loadSchedules();
                if (typeof loadTemplates === 'function') loadTemplates();
                if (typeof loadWebhookStatus === 'function') loadWebhookStatus();
            }
            if (page === 'voicemails') {
                if (typeof loadVmSettings === 'function') loadVmSettings();
                if (typeof pvmInit === 'function') pvmInit();
            }
            if (page === 'campaigns') {
                if (typeof loadCampaignHistory === 'function') loadCampaignHistory();
            }
            if (page === 'livecalls') {
                if (typeof pollStatus === 'function') pollStatus();
            }

            window.scrollTo(0, 0);
            window.location.hash = page;
        }

        function openWizard() {
            document.getElementById('wizardOverlay').style.display = '';
        }

        function closeWizard() {
            document.getElementById('wizardOverlay').style.display = 'none';
        }

        function toggleSidebar() {
            var sidebar = document.getElementById('gadsSidebar');
            var main = document.getElementById('gadsMain');
            sidebar.classList.toggle('gads-sidebar-collapsed');
            main.classList.toggle('gads-main-expanded');
        }

        window.addEventListener('hashchange', function() {
            var hash = window.location.hash.replace('#', '');
            if (hash && _gadsPageTitles[hash]) {
                navigateTo(hash);
            }
        });

        window.addEventListener('load', function() {
            var hash = window.location.hash.replace('#', '');
            if (hash && _gadsPageTitles[hash]) {
                navigateTo(hash);
            }
        });
    </script>

    <!-- ===== MAIN APPLICATION SCRIPT (preserved from original) ===== -->
    <script>
        window.apiFetch = function(url, opts) {
                var defaults = { credentials: "include", headers: {} };
                var merged = Object.assign({}, defaults, opts || {});
                if (!merged.body || !(merged.body instanceof FormData)) {
                    merged.headers["X-Requested-With"] = "XMLHttpRequest";
                } else {
                    var h = new Headers(merged.headers || {});
                    h.set("X-Requested-With", "XMLHttpRequest");
                    merged.headers = h;
                }
                return fetch(url, merged).then(function(r) {
                    if (r.status === 401) {
                        window.location.href = "/login";
                        throw new Error("auth");
                    }
                    return r;
                });
            };

            // ---- Splash Screen ----
            setTimeout(function() {
                document.getElementById("splash").classList.add("hide");
                document.getElementById("app").classList.add("show");
            }, 2900);

            // ---- Hot Lead Sound ----
            function playHotLeadSound() {
                try {
                    var ctx = new (window.AudioContext || window.webkitAudioContext)();
                    var osc1 = ctx.createOscillator();
                    var gain1 = ctx.createGain();
                    osc1.type = "sine";
                    osc1.frequency.value = 880;
                    gain1.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                    osc1.connect(gain1);
                    gain1.connect(ctx.destination);
                    osc1.start(ctx.currentTime);
                    osc1.stop(ctx.currentTime + 0.15);
                    var osc2 = ctx.createOscillator();
                    var gain2 = ctx.createGain();
                    osc2.type = "sine";
                    osc2.frequency.value = 1100;
                    gain2.gain.setValueAtTime(0.3, ctx.currentTime + 0.18);
                    gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.33);
                    osc2.connect(gain2);
                    gain2.connect(ctx.destination);
                    osc2.start(ctx.currentTime + 0.18);
                    osc2.stop(ctx.currentTime + 0.33);
                } catch(e) {}
            }

            // ---- Animated Counter ----
            function animateCounter(el, targetVal, duration) {
                if (!el) return;
                var isPercent = typeof targetVal === "string" && targetVal.includes("%");
                var target = parseFloat(targetVal) || 0;
                var current = parseFloat(el.textContent) || 0;
                if (current === target) return;
                var start = performance.now();
                duration = duration || 600;
                function step(now) {
                    var progress = Math.min((now - start) / duration, 1);
                    var eased = 1 - Math.pow(1 - progress, 3);
                    var val = Math.round(current + (target - current) * eased);
                    el.textContent = val + (isPercent ? "%" : "");
                    if (progress < 1) requestAnimationFrame(step);
                }
                requestAnimationFrame(step);
            }

            // ---- Toast Notifications ----
            function showToast(message, type) {
                type = type || "info";
                var container = document.getElementById("toastContainer");
                var toast = document.createElement("div");
                toast.className = "toast toast-" + type;
                var icons = {success: "&#10003;", error: "&#10007;", info: "&#9432;", warning: "&#9888;"};
                toast.innerHTML = '<span class="toast-icon">' + (icons[type] || icons.info) + '</span><span class="toast-msg">' + message + '</span>';
                container.appendChild(toast);
                requestAnimationFrame(function(){ toast.classList.add("toast-show"); });
                setTimeout(function(){
                    toast.classList.remove("toast-show");
                    toast.classList.add("toast-hide");
                    setTimeout(function(){ toast.remove(); }, 400);
                }, 3500);
            }

            // ---- Campaign History ----
            function loadCampaignHistory() {
                fetch("/api/campaign_history", {credentials:"include", headers:{"X-Requested-With":"XMLHttpRequest"}})
                    .then(function(r){ return r.json(); })
                    .then(function(data){
                        var body = document.getElementById("historyBody");
                        if (!data || data.length === 0) {
                            body.innerHTML = '<tr><td colspan="6" class="gads-empty">No campaign history yet</td></tr>';
                            return;
                        }
                        var html = "";
                        data.forEach(function(d){
                            var rateColor = d.success_rate >= 50 ? "green" : d.success_rate >= 25 ? "yellow" : "red";
                            html += '<tr>';
                            html += '<td>' + d.date + '</td>';
                            html += '<td>' + d.total + '</td>';
                            html += '<td style="color:#1e8e3e">' + d.transferred + '</td>';
                            html += '<td style="color:#1a73e8">' + d.voicemail + '</td>';
                            html += '<td style="color:#d93025">' + d.failed + '</td>';
                            html += '<td><span class="badge badge-' + rateColor + '">' + d.success_rate + '%</span></td>';
                            html += '</tr>';
                        });
                        body.innerHTML = html;
                    });
            }

            // ---- View Switching (redirects to new navigation) ----
            var currentView = "dashboard";
            function showView(view) {
                currentView = view;
                if (view === "dashboard") {
                    closeWizard();
                    navigateTo("dashboard");
                } else if (view === "wizard") {
                    navigateTo("campaigns");
                    openWizard();
                    wizardGoToStep(1);
                } else if (view === "monitor") {
                    closeWizard();
                    navigateTo("livecalls");
                    pollStatus();
                }
                window.scrollTo(0, 0);
            }

            // ---- Dashboard Panel Toggle (redirects to pages) ----
            var currentDashPanel = null;
            function showDashPanel(panelId) {
                var panelPageMap = {
                    panelVmSettings: 'voicemails',
                    panelTestDialer: 'settings',
                    panelAnalytics: 'reports',
                    panelDNC: 'contacts',
                    panelSchedule: 'settings',
                    panelWebhook: 'settings',
                    panelTemplates: 'settings',
                    panelValidation: 'contacts',
                    panelPVM: 'voicemails',
                    panelEmailReports: 'reports',
                    panelCampaignHistory: 'reports'
                };
                var targetPage = panelPageMap[panelId] || 'dashboard';
                navigateTo(targetPage);
                currentDashPanel = panelId;
            }

            function closeDashPanel() {
                currentDashPanel = null;
            }

            // ---- Wizard State ----
            var wizCurrentStep = 1;
            var wizTotalSteps = 5;
            var wizSelectedType = "outbound";
            var wizVmType = "standard";

            function wizardGoToStep(step) {
                wizCurrentStep = step;
                for (var i = 1; i <= wizTotalSteps; i++) {
                    var content = document.getElementById("wizContent" + i);
                    if (content) content.style.display = i === step ? "" : "none";

                    var ind = document.getElementById("wizStep" + i + "Ind");
                    if (ind) {
                        ind.classList.remove("wiz-step-active", "wiz-step-completed");
                        if (i === step) ind.classList.add("wiz-step-active");
                        else if (i < step) ind.classList.add("wiz-step-completed");
                    }
                }
                document.getElementById("wizBackBtn").style.display = step > 1 ? "" : "none";
                document.getElementById("wizNextBtn").style.display = step < wizTotalSteps ? "" : "none";

                if (step === 5) wizPopulateReview();
                if (step === 3 && wizVmType === "personalized") wizCheckPvm();
            }

            function wizardNext() {
                if (wizCurrentStep === 2) {
                    var csvFile = document.getElementById("csvFile");
                    var numbersInput = document.getElementById("numbersInput");
                    var hasCsv = csvFile && csvFile.files && csvFile.files.length > 0;
                    var hasNumbers = numbersInput && numbersInput.value.trim().length > 0;
                    if (!hasCsv && !hasNumbers) {
                        showToast("Please upload a CSV or paste phone numbers", "warning");
                        return;
                    }
                }
                if (wizCurrentStep === 4) {
                    var tf = document.getElementById("transferNumber");
                    if (!tf || !tf.value.trim()) {
                        showToast("Please enter a transfer number", "warning");
                        return;
                    }
                }
                if (wizCurrentStep < wizTotalSteps) {
                    wizardGoToStep(wizCurrentStep + 1);
                }
            }

            function wizardBack() {
                if (wizCurrentStep > 1) {
                    wizardGoToStep(wizCurrentStep - 1);
                }
            }

            function wizSelectType(type) {
                wizSelectedType = type;
            }

            function wizSwitchSource(mode) {
                var tabs = document.querySelectorAll(".wiz-source-tab");
                tabs.forEach(function(t) { t.classList.remove("active"); });
                if (mode === "csv") {
                    tabs[0].classList.add("active");
                    document.getElementById("wizSourceCSV").style.display = "";
                    document.getElementById("wizSourcePaste").style.display = "none";
                } else {
                    tabs[1].classList.add("active");
                    document.getElementById("wizSourceCSV").style.display = "none";
                    document.getElementById("wizSourcePaste").style.display = "";
                }
            }

            function wizSwitchVmType(type) {
                wizVmType = type;
                var tabs = document.querySelectorAll(".wiz-vm-tab");
                tabs.forEach(function(t) { t.classList.remove("active"); });
                if (type === "standard") {
                    tabs[0].classList.add("active");
                    document.getElementById("wizVmStandard").style.display = "";
                    document.getElementById("wizVmPersonalized").style.display = "none";
                } else {
                    tabs[1].classList.add("active");
                    document.getElementById("wizVmStandard").style.display = "none";
                    document.getElementById("wizVmPersonalized").style.display = "";
                    wizCheckPvm();
                }
            }

            function wizCheckPvm() {
                var statusEl = document.getElementById("wizPvmStatus");
                apiFetch("/api/pvm/audio-map")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.count > 0) {
                            statusEl.innerHTML = '<span style="color:var(--gads-success);">&#10003; ' + data.count + ' personalized voicemails ready. Numbers will be auto-loaded at launch.</span>';
                        } else {
                            statusEl.innerHTML = '<span style="color:var(--gads-text-secondary);">No personalized voicemails generated yet. Go to Voicemails page to create them.</span>';
                        }
                    }).catch(function() {
                        statusEl.innerHTML = '<span style="color:var(--gads-error);">Could not check PVM status.</span>';
                    });
            }

            function wizPopulateReview() {
                document.getElementById("wizReviewType").textContent = "Outbound Campaign";
                var csvFile = document.getElementById("csvFile");
                var numbersInput = document.getElementById("numbersInput");
                var count = 0;
                if (csvFile && csvFile.files && csvFile.files.length > 0) {
                    count = "CSV: " + csvFile.files[0].name;
                } else if (numbersInput && numbersInput.value.trim()) {
                    count = numbersInput.value.trim().split(/[\n,]+/).filter(function(n) { return n.trim(); }).length + " numbers";
                }
                document.getElementById("wizReviewNumbers").textContent = count || "0 numbers";
                var audioFile = document.getElementById("audioFile");
                var audioUrl = document.getElementById("audioUrl");
                var vmText = wizVmType === "personalized" ? "Personalized (AI)" : "Standard";
                if (wizVmType === "standard") {
                    if (audioFile && audioFile.files && audioFile.files.length > 0) vmText += " - " + audioFile.files[0].name;
                    else if (audioUrl && audioUrl.value.trim()) vmText += " - URL";
                    else vmText += " - Saved default";
                }
                document.getElementById("wizReviewVm").textContent = vmText;
                var tf = document.getElementById("transferNumber");
                document.getElementById("wizReviewTransfer").textContent = tf ? tf.value : "-";
                var mode = document.getElementById("dialModeInput").value;
                var modeText = mode === "simultaneous" ? "Simultaneous (batch: " + document.getElementById("batchSize").value + ")" : "Sequential (delay: " + document.getElementById("dialDelay").value + " min)";
                document.getElementById("wizReviewMode").textContent = modeText;
            }

            function wizUpdateNumberCount() {
                var csvFile = document.getElementById("csvFile");
                var numbersInput = document.getElementById("numbersInput");
                var el = document.getElementById("wizNumberCount");
                if (csvFile && csvFile.files && csvFile.files.length > 0) {
                    el.textContent = "File selected: " + csvFile.files[0].name;
                } else if (numbersInput && numbersInput.value.trim()) {
                    var count = numbersInput.value.trim().split(/[\n,]+/).filter(function(n) { return n.trim(); }).length;
                    el.textContent = count + " number" + (count !== 1 ? "s" : "") + " detected";
                } else {
                    el.textContent = "";
                }
            }

            // ---- Theme Toggle ----
            var themeToggle = document.getElementById("themeToggle");
            function getCurrentTheme() {
                return document.documentElement.getAttribute("data-theme") || "light";
            }
            themeToggle.addEventListener("click", function() {
                var next = getCurrentTheme() === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("vb_theme", next);
            });

            // ---- Fullscreen Toggle ----
            var fsBtn = document.getElementById("fullscreenToggle");
            fsBtn.addEventListener("click", function() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    var el = document.documentElement;
                    if (el.requestFullscreen) el.requestFullscreen();
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                }
            });
            function onFsChange() {
                document.body.classList.toggle("is-fullscreen", !!(document.fullscreenElement || document.webkitFullscreenElement));
            }
            document.addEventListener("fullscreenchange", onFsChange);
            document.addEventListener("webkitfullscreenchange", onFsChange);

            // ---- Ripple Effect ----
            document.addEventListener("click", function(e) {
                var btn = e.target.closest(".gads-btn, .gads-nav-item");
                if (!btn || btn.disabled) return;
                var rect = btn.getBoundingClientRect();
                var ripple = document.createElement("span");
                ripple.className = "ripple";
                var size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + "px";
                ripple.style.left = (e.clientX - rect.left - size / 2) + "px";
                ripple.style.top = (e.clientY - rect.top - size / 2) + "px";
                btn.style.position = "relative";
                btn.style.overflow = "hidden";
                btn.appendChild(ripple);
                setTimeout(function() { ripple.remove(); }, 500);
            });

            // ---- Elements ----
            var form = document.getElementById("campaignForm");
            var startBtn = document.getElementById("startBtn");
            var stopBtn = document.getElementById("stopBtn");
            var callBody = document.getElementById("callBody");
            var callCount = document.getElementById("callCount");
            var statusFilter = document.getElementById("statusFilter");
            statusFilter.addEventListener("change", function() { pollStatus(); });
            var campaignStatus = document.getElementById("campaignStatus");
            var testCallBtn = document.getElementById("testCallBtn");
            var testNumber = document.getElementById("testNumber");
            var testResult = document.getElementById("testResult");
            var testResultsBox = document.getElementById("testResultsBox");
            var transferNumber = document.getElementById("transferNumber");
            var saveTransferBtn = document.getElementById("saveTransferBtn");
            var savedIndicator = document.getElementById("savedIndicator");
            var clearLogsBtn = document.getElementById("clearLogsBtn");

            // ---- Voicemail Settings ----
            var vmUrlInput = document.getElementById("vmUrlInput");
            var saveVmBtn = document.getElementById("saveVmBtn");
            var vmPreview = document.getElementById("vmPreview");
            var vmAudioPlayer = document.getElementById("vmAudioPlayer");
            var vmDuration = document.getElementById("vmDuration");
            var vmSaveResult = document.getElementById("vmSaveResult");

            function loadVmSettings() {
                apiFetch("/api/voicemail_settings")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.voicemail_url) {
                            vmUrlInput.value = data.voicemail_url;
                            showVmPreview(data.voicemail_url);
                        }
                    })
                    .catch(function() {});
            }

            function showVmPreview(url) {
                if (!url) { vmPreview.style.display = "none"; return; }
                vmAudioPlayer.src = url;
                vmPreview.style.display = "";
                vmAudioPlayer.addEventListener("loadedmetadata", function() {
                    var dur = Math.round(vmAudioPlayer.duration);
                    vmDuration.textContent = "Duration: " + dur + " seconds";
                });
                vmAudioPlayer.addEventListener("error", function() {
                    vmDuration.textContent = "Could not load audio preview";
                });
            }

            saveVmBtn.addEventListener("click", function() {
                var url = vmUrlInput.value.trim();
                if (!url) { alert("Enter a voicemail URL"); return; }
                saveVmBtn.disabled = true;
                saveVmBtn.textContent = "Saving...";
                apiFetch("/api/voicemail_settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ voicemail_url: url })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    if (data.error) {
                        vmSaveResult.innerHTML = '<span style="color:var(--gads-error);">' + data.error + '</span>';
                    } else {
                        vmSaveResult.innerHTML = '<span style="color:var(--gads-success);">Voicemail URL saved</span>';
                        showVmPreview(url);
                        setTimeout(function() { vmSaveResult.textContent = ""; }, 3000);
                    }
                })
                .catch(function(e) {
                    if (e.message === "auth") return;
                    saveVmBtn.disabled = false;
                    saveVmBtn.textContent = "Save";
                    vmSaveResult.innerHTML = '<span style="color:var(--gads-error);">Failed to save</span>';
                });
            });

            // ---- Saved Transfer Number ----
            (function() {
                var saved = localStorage.getItem("vb_transfer");
                if (saved) transferNumber.value = saved;
            })();
            saveTransferBtn.addEventListener("click", function() {
                var val = transferNumber.value.trim();
                if (val) {
                    localStorage.setItem("vb_transfer", val);
                    savedIndicator.classList.add("show");
                    setTimeout(function() { savedIndicator.classList.remove("show"); }, 2000);
                }
            });

            // ---- Dial Mode Toggle ----
            var modeSeq = document.getElementById("modeSeq");
            var modeSimul = document.getElementById("modeSimul");
            var dialModeInput = document.getElementById("dialModeInput");
            var batchSizeWrap = document.getElementById("batchSizeWrap");
            var dialDelayWrap = document.getElementById("dialDelayWrap");
            var dialModeDesc = document.getElementById("dialModeDesc");

            function setDialMode(mode) {
                dialModeInput.value = mode;
                if (mode === "simultaneous") {
                    modeSeq.classList.remove("active");
                    modeSimul.classList.add("active");
                    batchSizeWrap.style.display = "";
                    dialDelayWrap.style.display = "none";
                    dialModeDesc.textContent = "Multiple calls are fired at the same time in batches for faster dialing.";
                } else {
                    modeSimul.classList.remove("active");
                    modeSeq.classList.add("active");
                    batchSizeWrap.style.display = "none";
                    dialDelayWrap.style.display = "";
                    dialModeDesc.textContent = "Calls are placed one at a time with a configurable delay between each call.";
                }
            }

            modeSeq.addEventListener("click", function() { setDialMode("sequential"); });
            modeSimul.addEventListener("click", function() { setDialMode("simultaneous"); });

            // ---- Download Report ----
            var downloadBtn = document.getElementById("downloadReportBtn");
            var customDateRow = document.getElementById("customDateRow");
            var reportStart = document.getElementById("reportStart");
            var reportEnd = document.getElementById("reportEnd");
            var presetBtns = document.querySelectorAll(".download-preset");
            var selectedRange = "all";

            presetBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    presetBtns.forEach(function(b) { b.classList.remove("active"); });
                    btn.classList.add("active");
                    selectedRange = btn.getAttribute("data-range");
                    customDateRow.style.display = selectedRange === "custom" ? "" : "none";
                });
            });

            function getDateRange() {
                var now = new Date();
                var start = "", end = "";
                if (selectedRange === "today") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "week") {
                    var d = new Date(now);
                    d.setDate(d.getDate() - d.getDay());
                    start = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0") + "T00:00:00";
                } else if (selectedRange === "month") {
                    start = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-01T00:00:00";
                } else if (selectedRange === "custom") {
                    start = reportStart.value ? reportStart.value + ":00" : "";
                    end = reportEnd.value ? reportEnd.value + ":59" : "";
                }
                return { start: start, end: end };
            }

            downloadBtn.addEventListener("click", function() {
                var range = getDateRange();
                var params = new URLSearchParams();
                if (range.start) params.set("start", range.start);
                if (range.end) params.set("end", range.end);
                var url = "/download_report" + (params.toString() ? "?" + params.toString() : "");
                window.location.href = url;
            });

            // ---- Clear Call Logs ----
            clearLogsBtn.addEventListener("click", function() {
                if (!confirm("Clear all call logs?")) return;
                clearLogsBtn.disabled = true;
                apiFetch("/clear_logs", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        clearLogsBtn.disabled = false;
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        callBody.innerHTML = '<tr><td colspan="9" class="gads-empty">No calls yet</td></tr>';
                        callCount.textContent = "0 calls";
                        showToast("Call logs cleared", "info");
                    })
                    .catch(function(e) {
                        clearLogsBtn.disabled = false;
                        if (e.message !== "auth") alert("Failed to clear logs");
                    });
            });

            // ---- Test Call ----
            var _testCallId = null;
            var _testCallNumber = null;
            var _testCallActive = false;

            function updateTestStatus(msg, color) {
                testResult.innerHTML = '<span style="color:' + (color || 'var(--gads-text-secondary)') + ';">' + msg + '</span>';
            }

            function trackTestCallStatus() {
                if (!_testCallActive) return;
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.calls || !_testCallActive) return;
                        var found = null;
                        for (var i = 0; i < data.calls.length; i++) {
                            var c = data.calls[i];
                            if (_testCallId && c.call_id && c.call_id.indexOf(_testCallId.substring(0, 12)) === 0) {
                                found = c;
                                break;
                            }
                            if (!found && c.number === _testCallNumber && c.is_live) {
                                found = c;
                            }
                        }
                        if (!found) return;
                        var desc = found.status_description || found.status;
                        var colorMap = { green: "var(--gads-success)", red: "var(--gads-error)", yellow: "#F59E0B", blue: "var(--gads-primary)" };
                        var col = colorMap[found.status_color] || "var(--gads-text-secondary)";
                        updateTestStatus(desc, col);
                        var doneStatuses = ["voicemail_complete","transferred","hangup","transfer_failed","human_no_transfer","no_answer"];
                        if (doneStatuses.indexOf(found.status) !== -1) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            if (found.voicemail_dropped) {
                                updateTestStatus("Voicemail dropped! Check your phone to hear the message.", "var(--gads-success)");
                            } else if (found.transferred) {
                                updateTestStatus("Human detected! In a real campaign, this would transfer to your destination number.", "var(--gads-success)");
                            }
                        } else {
                            setTimeout(trackTestCallStatus, 1000);
                        }
                    })
                    .catch(function() {
                        if (_testCallActive) setTimeout(trackTestCallStatus, 2000);
                    });
            }

            testCallBtn.addEventListener("click", function() {
                var number = testNumber.value.trim();
                if (!number) { alert("Enter a phone number"); return; }
                var transferNum = document.getElementById("testTransferNumber").value.trim();
                if (!transferNum) { alert("Enter a transfer number for human-answered calls"); return; }
                testCallBtn.disabled = true;
                testCallBtn.textContent = "Calling...";
                testResultsBox.style.display = "";
                updateTestStatus("Dialing...", "var(--gads-primary)");
                _testCallNumber = number;
                _testCallId = null;
                _testCallActive = true;
                var formData = new FormData();
                formData.append("test_number", number);
                formData.append("transfer_number", transferNum);
                apiFetch("/test_call", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            _testCallActive = false;
                            testCallBtn.disabled = false;
                            testCallBtn.textContent = "Start Test Call";
                            updateTestStatus(data.error, "var(--gads-error)");
                        } else {
                            _testCallId = data.call_control_id || null;
                            updateTestStatus("Ringing...", "var(--gads-primary)");
                            pollStatus();
                            setTimeout(trackTestCallStatus, 1500);
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        _testCallActive = false;
                        testCallBtn.disabled = false;
                        testCallBtn.textContent = "Start Test Call";
                        updateTestStatus("Request failed", "var(--gads-error)");
                    });
            });

            // ---- Start Campaign ----
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                if (wizVmType === "personalized") {
                    apiFetch("/api/pvm/audio-map")
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            var phones = Object.keys(data.audio_map || {});
                            if (phones.length > 0) {
                                var numbersField = document.getElementById("numbersInput");
                                if (numbersField) numbersField.value = phones.join("\n");
                            }
                            doStartCampaign();
                        }).catch(function() { doStartCampaign(); });
                } else {
                    doStartCampaign();
                }
            });

            function doStartCampaign() {
                var formData = new FormData(form);
                startBtn.disabled = true;
                startBtn.textContent = "Starting...";
                apiFetch("/start", { method: "POST", body: formData })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                            startBtn.disabled = false;
                            startBtn.textContent = "Launch Campaign";
                        } else {
                            stopBtn.disabled = false;
                            document.getElementById("monitorStopBtn").disabled = false;
                            startBtn.textContent = "Campaign Running...";
                            showToast("Campaign started!", "success");
                            showView("monitor");
                            pollStatus();
                        }
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                        alert("Failed to start campaign");
                        startBtn.disabled = false;
                        startBtn.textContent = "Launch Campaign";
                    });
            }

            // ---- Stop Campaign ----
            stopBtn.addEventListener("click", function() {
                apiFetch("/stop", { method: "POST" })
                    .then(function(r) { return r.json(); })
                    .then(function() {
                        stopBtn.disabled = true;
                        document.getElementById("monitorStopBtn").disabled = true;
                        startBtn.disabled = false;
                        startBtn.textContent = "Launch Campaign";
                        showToast("Campaign stopped", "info");
                    });
            });

            // ---- Status Helpers ----
            function getStatusClass(status) {
                switch(status) {
                    case "transferred":
                    case "voicemail_complete": return "status-success";
                    case "voicemail_playing":
                    case "test_call_ringing":
                    case "ringing":
                    case "answered":
                    case "human_detected": return "status-active";
                    case "machine_detected": return "status-warning";
                    case "hangup": return "status-neutral";
                    case "initiated": return "status-pending";
                    case "no_answer":
                    case "transfer_failed":
                    case "human_no_transfer": return "status-error";
                    default: return "";
                }
            }

            function formatStatus(s) {
                if (s === "initiated") return "Dialing...";
                if (s === "test_call_ringing") return "Ringing";
                if (s === "human_no_transfer") return "Human (No Transfer #)";
                if (s === "transfer_failed") return "Transfer Failed";
                return s.replace(/_/g, " ").replace(/\b\w/g, function(l) { return l.toUpperCase(); });
            }

            function formatRing(secs) {
                if (secs === null || secs === undefined) return "-";
                if (secs < 60) return secs + "s";
                return Math.floor(secs / 60) + "m " + (secs % 60) + "s";
            }

            function maskNumber(n) {
                if (!n || n.length < 5) return n || "-";
                return n;
            }

            // ---- Polling ----
            var pollInterval = 2000;
            var pollTimer = null;
            var isActive = false;
            var prevActiveState = false;
            var prevVmCount = 0;
            var initialPollDone = false;

            function pollStatus() {
                apiFetch("/status")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        var bar = document.getElementById("campaignStatus");
                        var wasActive = isActive;
                        isActive = data.active;

                        if (!initialPollDone) {
                            initialPollDone = true;
                            if (data.active) {
                                navigateTo("livecalls");
                            }
                        }

                        if (data.active && data.transfer_paused) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign paused &mdash; live transfer in progress';
                        } else if (data.active) {
                            bar.className = "status-bar stagger-1 active";
                            bar.innerHTML = '<span class="dot dot-active"></span> Campaign active &mdash; ' + data.total + ' numbers';
                        } else if (data.stop_requested) {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-stopping"></span> Campaign stopping...';
                        } else {
                            bar.className = "status-bar stagger-1";
                            bar.innerHTML = '<span class="dot dot-inactive"></span> No active campaign';
                            if (data.calls && data.calls.length > 0) {
                                startBtn.disabled = false;
                                startBtn.textContent = "Launch Campaign";
                                stopBtn.disabled = true;
                                document.getElementById("monitorStopBtn").disabled = true;
                            }
                        }

                        // Update dashboard campaign status
                        var dashStatus = document.getElementById("dashCampaignStatus");
                        if (dashStatus) {
                            dashStatus.textContent = data.active ? "Active" : "Idle";
                            dashStatus.style.color = data.active ? "var(--gads-success)" : "";
                        }

                        var progressWrap = document.getElementById("campaignProgressWrap");
                        if (data.active && data.total > 0) {
                            progressWrap.style.display = "";
                            var percent = Math.round((data.dialed_count / data.total) * 100);
                            document.getElementById("progressLabel").textContent = "Dialed: " + data.dialed_count + " / " + data.total;
                            document.getElementById("progressPercent").textContent = percent + "%";
                            document.getElementById("progressFill").style.width = percent + "%";
                        } else {
                            progressWrap.style.display = "none";
                        }

                        var hasLiveCalls = false;
                        var calls = data.calls || [];
                        var count = calls.length;
                        callCount.textContent = count + " call" + (count !== 1 ? "s" : "");

                        var totalCalls = calls.length;
                        var hotLeads = calls.filter(function(c){ return c.transferred; }).length;
                        var voicemails = calls.filter(function(c){ return c.voicemail_dropped; }).length;
                        var successRate = totalCalls > 0 ? Math.round(((hotLeads + voicemails) / totalCalls) * 100) : 0;
                        animateCounter(document.getElementById("qsTotalCalls"), totalCalls);
                        animateCounter(document.getElementById("qsHotLeads"), hotLeads);
                        animateCounter(document.getElementById("qsVoicemails"), voicemails);
                        animateCounter(document.getElementById("qsSuccessRate"), successRate + "%");
                        animateCounter(document.getElementById("qsTotalCallsMon"), totalCalls);
                        animateCounter(document.getElementById("qsHotLeadsMon"), hotLeads);
                        animateCounter(document.getElementById("qsVoicemailsMon"), voicemails);
                        animateCounter(document.getElementById("qsSuccessRateMon"), successRate + "%");

                        // Update dashboard connected count
                        var connected = calls.filter(function(c){ return c.transferred || c.status === "human_detected" || c.status === "answered"; }).length;
                        animateCounter(document.getElementById("dashConnected"), connected);

                        var newVmCount = voicemails;
                        if (newVmCount > prevVmCount && prevVmCount > 0) {
                            showToast("Voicemail dropped", "success");
                        }
                        prevVmCount = newVmCount;

                        if (prevActiveState && !data.active && !data.stop_requested) {
                            showToast("Campaign complete!", "success");
                            document.getElementById("wizCampaignComplete").style.display = "";
                        }
                        prevActiveState = data.active;

                        var filterVal = statusFilter.value;

                        if (data.calls && data.calls.length > 0) {
                            var filtered = data.calls.filter(function(c) {
                                if (filterVal === "all") return true;
                                var col = c.status_color || "";
                                if (filterVal === "success") return col === "green";
                                if (filterVal === "failed") return col === "red";
                                if (filterVal === "issues") return col === "yellow";
                                if (filterVal === "progress") return col === "blue";
                                return true;
                            });

                            var liveStatuses = ["initiated","ringing","test_call_ringing","answered","human_detected","machine_detected","voicemail_playing","transferred","connected"];

                            var html = "";
                            filtered.forEach(function(c, idx) {
                                var isLive = liveStatuses.indexOf(c.status) !== -1;
                                if (isLive) hasLiveCalls = true;
                                var tsDisplay = "-";
                                if (c.timestamp) {
                                    try {
                                        var d = new Date(c.timestamp);
                                        if (!isNaN(d.getTime())) {
                                            tsDisplay = d.toLocaleDateString(undefined, {month:"short", day:"numeric"}) + " " + d.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
                                        }
                                    } catch(e) {}
                                }
                                var descText = c.status_description || formatStatus(c.status);
                                var colorCls = "status-" + (c.status_color || "blue");

                                var rowCls = isLive ? "call-row-live" : "";
                                html += '<tr class="' + rowCls + '">';
                                html += '<td class="td-ts">' + tsDisplay + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.number) + "</td>";
                                html += '<td class="td-mono">' + maskNumber(c.from_number) + "</td>";
                                html += '<td><span class="status-desc-badge ' + colorCls + '">' + descText;
                                if (isLive) html += ' <span class="live-pulse"></span>';
                                html += "</span></td>";
                                html += "<td>" + formatRing(c.ring_duration) + "</td>";
                                html += "<td>" + (c.machine_detected === null ? "-" : (c.machine_detected ? "Yes" : "No")) + "</td>";
                                html += "<td>" + (c.transferred ? "Yes" : "-") + "</td>";
                                html += "<td>" + (c.voicemail_dropped ? "Yes" : "-") + "</td>";

                                var hasTranscript = c.transcript && c.transcript.length > 0;
                                var trId = "tr_" + idx;
                                if (isLive) {
                                    if (hasTranscript) {
                                        html += '<td><span class="transcript-live-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> LIVE</span></td>';
                                    } else {
                                        html += '<td><span class="transcript-waiting"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/></svg> Listening...</span></td>';
                                    }
                                } else if (hasTranscript) {
                                    html += '<td><button type="button" class="btn-transcript" onclick="toggleTranscript(\'' + trId + '\')">';
                                    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>';
                                    html += ' View</button></td>';
                                } else {
                                    html += "<td>-</td>";
                                }
                                html += '</tr>';

                                if (isLive) {
                                    html += '<tr class="transcript-row transcript-row-live" id="' + trId + '" style="display:table-row;"><td colspan="9"><div class="transcript-box transcript-box-live">';
                                    html += '<div class="transcript-header-live"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg> Live Transcription <span class="live-dot"></span></div>';
                                    if (hasTranscript) {
                                        c.transcript.forEach(function(t) {
                                            var speaker = t.track === "outbound" ? "Agent" : "Caller";
                                            var cls = t.track === "outbound" ? "transcript-outbound" : "transcript-inbound";
                                            var safeText = (t.text || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
                                            html += '<div class="transcript-line ' + cls + '"><strong>' + speaker + ':</strong> ' + safeText + '</div>';
                                        });
                                    } else {
                                        html += '<div class="transcript-empty">Waiting for speech...</div>';
                                    }
                                    html += '</div></td></tr>';
                                } else if (hasTranscript) {
                                    html += '<tr class="transcript-row" id="' + trId + '" style="display:none;"><td colspan="9"><div class="transcript-box">';
                                    c.transcript.forEach(function(t) {
                                        var speaker = t.track === "outbound" ? "Agent" : "Caller";
                                        var cls = t.track === "outbound" ? "transcript-outbound" : "transcript-inbound";
                                        var safeText = (t.text || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
                                        html += '<div class="transcript-line ' + cls + '"><strong>' + speaker + ':</strong> ' + safeText + '</div>';
                                    });
                                    html += '</div></td></tr>';
                                }
                            });
                            if (filtered.length > 0) {
                                callBody.innerHTML = html;
                            } else {
                                callBody.innerHTML = '<tr><td colspan="9" class="gads-empty">No matching calls</td></tr>';
                            }
                        } else if (count === 0) {
                            callBody.innerHTML = '<tr><td colspan="9" class="gads-empty">No calls yet</td></tr>';
                        }

                        // Update dashboard recent activity (mirror last 20 rows)
                        var dashRecent = document.getElementById("dashRecentBody");
                        if (dashRecent && data.calls && data.calls.length > 0) {
                            var recentHtml = "";
                            var recentCalls = data.calls.slice(0, 20);
                            recentCalls.forEach(function(c) {
                                var tsDisplay = "-";
                                if (c.timestamp) {
                                    try {
                                        var d = new Date(c.timestamp);
                                        if (!isNaN(d.getTime())) {
                                            tsDisplay = d.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
                                        }
                                    } catch(e) {}
                                }
                                var descText = c.status_description || formatStatus(c.status);
                                var colorCls = "status-" + (c.status_color || "blue");
                                recentHtml += '<tr>';
                                recentHtml += '<td>' + tsDisplay + '</td>';
                                recentHtml += '<td class="td-mono">' + maskNumber(c.number) + '</td>';
                                recentHtml += '<td><span class="status-desc-badge ' + colorCls + '">' + descText + '</span></td>';
                                recentHtml += '<td>' + formatRing(c.ring_duration) + '</td>';
                                recentHtml += '<td>' + (c.machine_detected === null ? '-' : (c.machine_detected ? 'Yes' : 'No')) + '</td>';
                                recentHtml += '<td>' + (c.transferred ? 'Yes' : '-') + '</td>';
                                recentHtml += '<td>' + (c.voicemail_dropped ? 'Yes' : '-') + '</td>';
                                recentHtml += '<td>-</td>';
                                recentHtml += '</tr>';
                            });
                            dashRecent.innerHTML = recentHtml;
                        }

                        if (typeof iphoneUpdateDialer === "function") {
                            iphoneUpdateDialer(data.calls || []);
                        }

                        adjustPollSpeed(data.active || hasLiveCalls);
                    })
                    .catch(function(e) {
                        if (e.message === "auth") return;
                    });
            }

            window.toggleTranscript = function(id) {
                var row = document.getElementById(id);
                if (row) {
                    row.style.display = row.style.display === "none" ? "table-row" : "none";
                }
            };

            function adjustPollSpeed(fast) {
                var newInterval = fast ? 1000 : 3000;
                if (newInterval !== pollInterval) {
                    pollInterval = newInterval;
                    clearInterval(pollTimer);
                    pollTimer = setInterval(pollStatus, pollInterval);
                }
            }

            pollTimer = setInterval(pollStatus, pollInterval);
            pollStatus();

            // Wire up number count tracking
            document.getElementById("csvFile").addEventListener("change", function() { wizUpdateNumberCount(); });
            document.getElementById("numbersInput").addEventListener("input", function() { wizUpdateNumberCount(); });
    </script>

    <!-- iPHONE DIALER WIDGET -->
    <div class="iphone-3d-wrapper" id="iphoneDialer">
        <div class="iphone-3d-body" id="iphone3dBody">
            <div class="iphone-front">
                <div class="iphone-side-btn iphone-vol-up"></div>
                <div class="iphone-side-btn iphone-vol-down"></div>
                <div class="iphone-side-btn iphone-silent-switch"></div>
                <div class="iphone-side-btn iphone-power-btn"></div>
                <div class="iphone-frame">
                    <div class="iphone-notch-area">
                        <div class="iphone-dynamic-island" id="iphoneDynIsland">
                            <div class="iphone-di-dot"></div>
                            <div class="iphone-di-dot iphone-di-cam"></div>
                        </div>
                        <div class="iphone-status-bar">
                            <span class="iphone-time" id="iphoneTime">9:41</span>
                            <div class="iphone-status-icons">
                                <span class="iphone-signal">&#9679;&#9679;&#9679;&#9679;</span>
                                <span class="iphone-wifi">&#9681;</span>
                                <span class="iphone-battery-icon">&#9608;</span>
                            </div>
                        </div>
                    </div>
                    <div class="iphone-screen" id="iphoneScreen">
                        <div class="iphone-idle-screen" id="iphoneIdleScreen">
                            <div class="iphone-idle-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#06B6D4" stroke-width="1.5"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                            </div>
                            <div class="iphone-idle-text">Live Dialer</div>
                            <div class="iphone-idle-sub">Waiting for active calls...</div>
                        </div>
                        <div class="iphone-call-screen" id="iphoneCallScreen" style="display:none;">
                            <div class="iphone-call-label" id="iphoneCallLabel">calling...</div>
                            <div class="iphone-call-number" id="iphoneCallNumber">+1 (555) 123-4567</div>
                            <div class="iphone-call-timer" id="iphoneCallTimer">00:00</div>
                            <div class="iphone-call-status-badge" id="iphoneCallBadge">
                                <span class="iphone-call-pulse"></span>
                                <span id="iphoneCallStatusText">Ringing</span>
                            </div>
                            <div class="iphone-call-amd" id="iphoneCallAmd" style="display:none;">
                                <span id="iphoneAmdIcon">&#9679;</span>
                                <span id="iphoneAmdText">Detecting...</span>
                            </div>
                            <div class="iphone-call-transcript" id="iphoneCallTranscript" style="display:none;">
                                <div class="iphone-transcript-label">Live Transcript</div>
                                <div class="iphone-transcript-content" id="iphoneTranscriptContent"></div>
                            </div>
                            <div class="iphone-call-actions">
                                <div class="iphone-action-btn"><div class="iphone-action-icon">&#128264;</div><span>mute</span></div>
                                <div class="iphone-action-btn"><div class="iphone-action-icon">&#9881;</div><span>keypad</span></div>
                                <div class="iphone-action-btn"><div class="iphone-action-icon">&#128266;</div><span>speaker</span></div>
                            </div>
                        </div>
                        <div class="iphone-hotlead-screen" id="iphoneHotLeadScreen" style="display:none;">
                            <div class="hotlead-caller-name">Hot Lead</div>
                            <div class="hotlead-caller-location" id="hotleadNumber"></div>
                            <div class="hotlead-mid-actions">
                                <div class="hotlead-action-btn">
                                    <div class="hotlead-action-icon hotlead-remind"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
                                    <span>Remind Me</span>
                                </div>
                                <div class="hotlead-action-btn">
                                    <div class="hotlead-action-icon hotlead-message"><svg width="18" height="18" viewBox="0 0 24 24" fill="#fff"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
                                    <span>Message</span>
                                </div>
                            </div>
                            <div class="hotlead-slide-wrapper">
                                <div class="hotlead-slide-track">
                                    <div class="hotlead-slide-thumb">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#30D158" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 014.11 4.18 2 2 0 016.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L10.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                                    </div>
                                    <span class="hotlead-slide-text">slide to <span class="hotlead-slide-green">answer</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="iphone-call-log" id="iphoneCallLog">
                            <div class="iphone-log-title">Recent Activity</div>
                            <div class="iphone-log-entries" id="iphoneLogEntries"></div>
                        </div>
                        <div class="iphone-home-bar"></div>
                    </div>
                </div>
            </div>
            <div class="iphone-back" id="iphoneBack">
                <div class="iphone-side-btn iphone-vol-up"></div>
                <div class="iphone-side-btn iphone-vol-down"></div>
                <div class="iphone-side-btn iphone-silent-switch"></div>
                <div class="iphone-side-btn iphone-power-btn"></div>
                <div class="iphone-back-surface">
                    <div class="iphone-camera-module">
                        <div class="iphone-camera-lens iphone-lens-1"></div>
                        <div class="iphone-camera-lens iphone-lens-2"></div>
                        <div class="iphone-camera-lens iphone-lens-3"></div>
                        <div class="iphone-camera-flash"></div>
                        <div class="iphone-camera-lidar"></div>
                    </div>
                    <div class="iphone-apple-logo">&#63743;</div>
                    <div class="iphone-back-text">iPhone</div>
                </div>
            </div>
        </div>
        <div class="iphone-drag-handle" id="iphoneDragHandle">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
        </div>
        <button class="iphone-minimize-btn" id="iphoneMinBtn" onclick="iphoneToggleMinimize()" title="Minimize">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <div class="iphone-resting-shadow"></div>
    </div>

    <!-- POWERED BY BADGE -->
    <div class="oh-powered-badge">
        <span class="oh-powered-text">Powered by</span>
        <span class="oh-powered-brand">Open Human</span>
        <span class="oh-powered-pulse"></span>
    </div>

    <!-- FLOATING IPHONE BALL -->
    <button class="iphone-fab" id="iphoneFab" title="Open Live Dialer">&#63743;</button>

    <!-- FLOATING NOTEPAD -->
    <button class="notepad-fab" id="notepadFab" title="Open Notepad">N</button>
    <div class="notepad-window" id="notepadWindow">
        <div class="notepad-header" id="notepadHeader">
            <div class="notepad-header-left">
                <div class="notepad-header-logo">N</div>
                <span class="notepad-header-title">Notepad</span>
            </div>
            <div class="notepad-header-actions">
                <button class="notepad-float-toggle active" id="notepadFloatToggle" title="Toggle float/stick">Float</button>
                <button id="notepadClear" title="Clear All">&#128465;</button>
                <button id="notepadMin" title="Minimize">&minus;</button>
            </div>
        </div>
        <div class="notepad-toolbar" id="notepadToolbar">
            <button data-cmd="bold" title="Bold"><b>B</b></button>
            <button data-cmd="italic" title="Italic"><i>I</i></button>
            <button data-cmd="underline" title="Underline"><u>U</u></button>
            <button data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
            <div class="sep"></div>
            <select id="npFontSize" title="Font Size">
                <option value="1">Small</option>
                <option value="3" selected>Normal</option>
                <option value="5">Large</option>
                <option value="7">Huge</option>
            </select>
            <div class="sep"></div>
            <input type="color" id="npTextColor" value="#06B6D4" title="Text Color">
            <input type="color" id="npHighlight" value="#FFFF00" title="Highlight Color">
            <button data-cmd="removeFormat" title="Remove Formatting">&#10006;</button>
            <div class="sep"></div>
            <button data-cmd="insertUnorderedList" title="Bullet List">&#8226;</button>
            <button data-cmd="insertOrderedList" title="Numbered List">1.</button>
            <div class="sep"></div>
            <button data-cmd="justifyLeft" title="Align Left">&#8676;</button>
            <button data-cmd="justifyCenter" title="Align Center">&#8596;</button>
            <button data-cmd="justifyRight" title="Align Right">&#8677;</button>
        </div>
        <div class="notepad-body">
            <div class="notepad-editor" id="notepadEditor" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="notepad-footer">
            <span id="notepadCharCount">0 characters</span>
            <button id="notepadDownload" title="Download as text file">Download</button>
        </div>
    </div>

    <!-- NOTEPAD + PHYSICS SCRIPT (preserved exactly) -->
    <script>
    (function(){
        var fab = document.getElementById("notepadFab");
        var win = document.getElementById("notepadWindow");
        var header = document.getElementById("notepadHeader");
        var editor = document.getElementById("notepadEditor");
        var minBtn = document.getElementById("notepadMin");
        var clearBtn = document.getElementById("notepadClear");
        var charCount = document.getElementById("notepadCharCount");
        var downloadBtn = document.getElementById("notepadDownload");
        var floatToggle = document.getElementById("notepadFloatToggle");
        var fontSel = document.getElementById("npFontSize");
        var colorPick = document.getElementById("npTextColor");
        var hlPick = document.getElementById("npHighlight");
        var storageKey = "vb_notepad_content";
        var posKey = "vb_notepad_pos";
        var floatKey = "vb_notepad_float";
        var defaultBottom = 28, defaultRight = 28;
        var isDragging = false, dragX = 0, dragY = 0;
        var isFloating = localStorage.getItem(floatKey) !== "false";
        var fabSize = 56;
        var fabDragging = false, fabClicked = false;
        var fabX, fabY, fabVX = 0, fabVY = 0;
        var fabDragOffX = 0, fabDragOffY = 0;
        var fabLastMX = 0, fabLastMY = 0, fabLastTime = 0;
        var fabTrailX = [], fabTrailY = [], fabTrailT = [];
        var fabAnim = null;
        var gravity = 0.15;
        var friction = 0.995;
        var bounceDamp = 0.65;
        var restThreshold = 0.08;
        var idleDriftSpeed = 0.25;
        var iFab = document.getElementById("iphoneFab");
        var iFabSize = 56;
        var iFabX = 0, iFabY = 0, iFabVX = 0, iFabVY = 0;
        var iFabDragging = false, iFabClicked = false;
        var iFabDragOffX = 0, iFabDragOffY = 0;
        var iFabTrailX = [], iFabTrailY = [], iFabTrailT = [];
        var iFabActive = false;
        function initFabPos(){var rect=fab.getBoundingClientRect();fabX=rect.left;fabY=rect.top;}
        function applyFabPos(){fab.style.left=fabX+"px";fab.style.top=fabY+"px";fab.style.bottom="auto";fab.style.right="auto";}
        function initIFabPos(){var rect=iFab.getBoundingClientRect();iFabX=rect.left;iFabY=rect.top;}
        function applyIFabPos(){iFab.style.left=iFabX+"px";iFab.style.top=iFabY+"px";iFab.style.bottom="auto";iFab.style.right="auto";}
        function ballWallBounce(bx,by,bvx,bvy,sz){var maxX=window.innerWidth-sz;var maxY=window.innerHeight-sz;if(by>=maxY){by=maxY;bvy=-Math.abs(bvy)*bounceDamp;bvx*=0.98;if(Math.abs(bvy)<1.5){bvy=0;if(Math.abs(bvx)<restThreshold){bvx=(Math.random()>0.5?1:-1)*idleDriftSpeed;bvy=-(1+Math.random()*2);}}}if(by<=0){by=0;bvy=Math.abs(bvy)*bounceDamp;}if(bx<=0){bx=0;bvx=Math.abs(bvx)*bounceDamp;}if(bx>=maxX){bx=maxX;bvx=-Math.abs(bvx)*bounceDamp;}return{x:bx,y:by,vx:bvx,vy:bvy};}
        function collideBalls(){if(!iFabActive||!isFloating)return;if(fab.classList.contains("hidden"))return;var r1=fabSize/2,r2=iFabSize/2;var cx1=fabX+r1,cy1=fabY+r1;var cx2=iFabX+r2,cy2=iFabY+r2;var dx=cx2-cx1,dy=cy2-cy1;var dist=Math.sqrt(dx*dx+dy*dy);var minDist=r1+r2;if(dist<minDist&&dist>0.01){var nx=dx/dist,ny=dy/dist;var overlap=minDist-dist;fabX-=nx*overlap*0.5;fabY-=ny*overlap*0.5;iFabX+=nx*overlap*0.5;iFabY+=ny*overlap*0.5;var dvx=fabVX-iFabVX,dvy=fabVY-iFabVY;var dvDotN=dvx*nx+dvy*ny;if(dvDotN<0){var restitution=0.85;var impulse=-(1+restitution)*dvDotN*0.5;fabVX+=impulse*nx;fabVY+=impulse*ny;iFabVX-=impulse*nx;iFabVY-=impulse*ny;fabVX+=(Math.random()-0.5)*0.3;fabVY+=(Math.random()-0.5)*0.3;iFabVX+=(Math.random()-0.5)*0.3;iFabVY+=(Math.random()-0.5)*0.3;}}}
        function physicsTick(){if(!isFloating||fab.classList.contains("hidden")||fabDragging){}else{fabVX*=friction;fabVY*=friction;fabVY+=gravity;fabX+=fabVX;fabY+=fabVY;var nw=ballWallBounce(fabX,fabY,fabVX,fabVY,fabSize);fabX=nw.x;fabY=nw.y;fabVX=nw.vx;fabVY=nw.vy;applyFabPos();}if(iFabActive&&!iFabDragging){iFabVX*=friction;iFabVY*=friction;iFabVY+=gravity;iFabX+=iFabVX;iFabY+=iFabVY;var iw=ballWallBounce(iFabX,iFabY,iFabVX,iFabVY,iFabSize);iFabX=iw.x;iFabY=iw.y;iFabVX=iw.vx;iFabVY=iw.vy;applyIFabPos();}collideBalls();fabAnim=requestAnimationFrame(physicsTick);}
        function startFloat(){isFloating=true;fab.classList.add("floating");floatToggle.classList.add("active");floatToggle.textContent="Float";localStorage.setItem(floatKey,"true");initFabPos();fabVX=(Math.random()-0.5)*3;fabVY=-(2+Math.random()*3);if(!fabAnim)physicsTick();}
        function stopFloat(){isFloating=false;fab.classList.remove("floating");floatToggle.classList.remove("active");floatToggle.textContent="Stick";localStorage.setItem(floatKey,"false");if(fabAnim){cancelAnimationFrame(fabAnim);fabAnim=null;}fab.style.left="";fab.style.top="";fab.style.bottom=defaultBottom+"px";fab.style.right=defaultRight+"px";}
        function fabStartDrag(cx,cy){if(!isFloating)return;fabDragging=true;fabClicked=true;var rect=fab.getBoundingClientRect();fabDragOffX=cx-rect.left;fabDragOffY=cy-rect.top;fabVX=0;fabVY=0;fabTrailX=[cx];fabTrailY=[cy];fabTrailT=[Date.now()];fab.style.cursor="grabbing";}
        function fabMoveDrag(cx,cy){if(!fabDragging)return;fabClicked=false;fabX=cx-fabDragOffX;fabY=cy-fabDragOffY;fabX=Math.max(0,Math.min(fabX,window.innerWidth-fabSize));fabY=Math.max(0,Math.min(fabY,window.innerHeight-fabSize));applyFabPos();var now=Date.now();fabTrailX.push(cx);fabTrailY.push(cy);fabTrailT.push(now);if(fabTrailX.length>6){fabTrailX.shift();fabTrailY.shift();fabTrailT.shift();}}
        function fabEndDrag(){if(!fabDragging)return;fabDragging=false;fab.style.cursor="";var now=Date.now();var throwVX=0,throwVY=0;if(fabTrailX.length>=2){var idx=0;for(var k=fabTrailT.length-1;k>=0;k--){if(now-fabTrailT[k]>120)break;idx=k;}var dt=(now-fabTrailT[idx])||1;throwVX=(fabTrailX[fabTrailX.length-1]-fabTrailX[idx])/dt*16;throwVY=(fabTrailY[fabTrailY.length-1]-fabTrailY[idx])/dt*16;var maxThrow=30;throwVX=Math.max(-maxThrow,Math.min(maxThrow,throwVX));throwVY=Math.max(-maxThrow,Math.min(maxThrow,throwVY));}fabVX=throwVX;fabVY=throwVY;}
        fab.addEventListener("mousedown",function(e){if(!isFloating)return;e.preventDefault();fabStartDrag(e.clientX,e.clientY);});
        document.addEventListener("mousemove",function(e){if(fabDragging){e.preventDefault();fabMoveDrag(e.clientX,e.clientY);}});
        document.addEventListener("mouseup",function(){if(fabDragging)fabEndDrag();});
        fab.addEventListener("touchstart",function(e){if(!isFloating)return;var t=e.touches[0];fabStartDrag(t.clientX,t.clientY);},{passive:true});
        document.addEventListener("touchmove",function(e){if(fabDragging){var t=e.touches[0];fabMoveDrag(t.clientX,t.clientY);}},{passive:true});
        document.addEventListener("touchend",function(){if(fabDragging)fabEndDrag();});
        function iFabStartDrag(cx,cy){iFabDragging=true;iFabClicked=true;var rect=iFab.getBoundingClientRect();iFabDragOffX=cx-rect.left;iFabDragOffY=cy-rect.top;iFabVX=0;iFabVY=0;iFabTrailX=[cx];iFabTrailY=[cy];iFabTrailT=[Date.now()];iFab.style.cursor="grabbing";}
        function iFabMoveDrag(cx,cy){if(!iFabDragging)return;iFabClicked=false;iFabX=cx-iFabDragOffX;iFabY=cy-iFabDragOffY;iFabX=Math.max(0,Math.min(iFabX,window.innerWidth-iFabSize));iFabY=Math.max(0,Math.min(iFabY,window.innerHeight-iFabSize));applyIFabPos();var now=Date.now();iFabTrailX.push(cx);iFabTrailY.push(cy);iFabTrailT.push(now);if(iFabTrailX.length>6){iFabTrailX.shift();iFabTrailY.shift();iFabTrailT.shift();}}
        function iFabEndDrag(){if(!iFabDragging)return;iFabDragging=false;iFab.style.cursor="";var now=Date.now();var tvx=0,tvy=0;if(iFabTrailX.length>=2){var idx=0;for(var k=iFabTrailT.length-1;k>=0;k--){if(now-iFabTrailT[k]>120)break;idx=k;}var dt=(now-iFabTrailT[idx])||1;tvx=(iFabTrailX[iFabTrailX.length-1]-iFabTrailX[idx])/dt*16;tvy=(iFabTrailY[iFabTrailY.length-1]-iFabTrailY[idx])/dt*16;var mx=30;tvx=Math.max(-mx,Math.min(mx,tvx));tvy=Math.max(-mx,Math.min(mx,tvy));}iFabVX=tvx;iFabVY=tvy;}
        iFab.addEventListener("mousedown",function(e){if(!iFabActive)return;e.preventDefault();iFabStartDrag(e.clientX,e.clientY);});
        document.addEventListener("mousemove",function(e){if(iFabDragging){e.preventDefault();iFabMoveDrag(e.clientX,e.clientY);}});
        document.addEventListener("mouseup",function(){if(iFabDragging)iFabEndDrag();});
        iFab.addEventListener("touchstart",function(e){if(!iFabActive)return;var t=e.touches[0];iFabStartDrag(t.clientX,t.clientY);},{passive:true});
        document.addEventListener("touchmove",function(e){if(iFabDragging){var t=e.touches[0];iFabMoveDrag(t.clientX,t.clientY);}},{passive:true});
        document.addEventListener("touchend",function(){if(iFabDragging)iFabEndDrag();});
        iFab.addEventListener("click",function(e){if(!iFabActive)return;if(!iFabClicked)return;e.stopPropagation();if(typeof iphoneToggleMinimize==="function"){iphoneToggleMinimize();}});
        window.ballsStartIphone=function(){iFabActive=true;iFab.classList.add("floating");setTimeout(function(){initIFabPos();iFabVX=(Math.random()-0.5)*4;iFabVY=-(3+Math.random()*4);},50);};
        window.ballsStopIphone=function(){iFabActive=false;iFabVX=0;iFabVY=0;iFab.style.left="";iFab.style.top="";iFab.style.bottom="";iFab.style.right="";};
        function initFabFloat(){initFabPos();fabVX=(Math.random()-0.5)*2;fabVY=-(1+Math.random()*2);}
        if(isFloating){fab.classList.add("floating");setTimeout(function(){initFabPos();fabVX=(Math.random()-0.5)*2;fabVY=-(1+Math.random()*2);physicsTick();},600);}else{floatToggle.classList.remove("active");floatToggle.textContent="Stick";}
        floatToggle.addEventListener("click",function(e){e.preventDefault();if(isFloating){stopFloat();}else{startFloat();}});
        var saved=localStorage.getItem(storageKey);if(saved)editor.innerHTML=saved;
        function updateCharCount(){var t=editor.innerText||"";var len=t.replace(/\n$/,"").length;charCount.textContent=len+" character"+(len!==1?"s":"");}
        updateCharCount();
        function saveContent(){localStorage.setItem(storageKey,editor.innerHTML);updateCharCount();}
        editor.addEventListener("input",saveContent);
        fab.addEventListener("click",function(e){if(isFloating&&!fabClicked)return;fab.classList.add("hidden");win.classList.add("open");var pos=localStorage.getItem(posKey);if(pos){try{var p=JSON.parse(pos);win.style.bottom="auto";win.style.right="auto";win.style.left=p.left+"px";win.style.top=p.top+"px";}catch(e2){}}editor.focus();});
        function closeNotepad(){win.classList.remove("open");fab.classList.remove("hidden");win.style.bottom=defaultBottom+"px";win.style.right=defaultRight+"px";win.style.left="";win.style.top="";if(isFloating){initFabFloat();}}
        minBtn.addEventListener("click",closeNotepad);
        clearBtn.addEventListener("click",function(){if(confirm("Clear all notes?")){editor.innerHTML="";saveContent();}});
        header.addEventListener("mousedown",function(e){if(e.target.tagName==="BUTTON")return;isDragging=true;var rect=win.getBoundingClientRect();dragX=e.clientX-rect.left;dragY=e.clientY-rect.top;e.preventDefault();});
        document.addEventListener("mousemove",function(e){if(!isDragging)return;var nx=e.clientX-dragX;var ny=e.clientY-dragY;nx=Math.max(0,Math.min(nx,window.innerWidth-100));ny=Math.max(0,Math.min(ny,window.innerHeight-50));win.style.left=nx+"px";win.style.top=ny+"px";win.style.bottom="auto";win.style.right="auto";localStorage.setItem(posKey,JSON.stringify({left:nx,top:ny}));});
        document.addEventListener("mouseup",function(){isDragging=false;});
        header.addEventListener("touchstart",function(e){if(e.target.tagName==="BUTTON")return;isDragging=true;var rect=win.getBoundingClientRect();var t=e.touches[0];dragX=t.clientX-rect.left;dragY=t.clientY-rect.top;},{passive:true});
        document.addEventListener("touchmove",function(e){if(!isDragging)return;var t=e.touches[0];var nx=t.clientX-dragX;var ny=t.clientY-dragY;nx=Math.max(0,Math.min(nx,window.innerWidth-100));ny=Math.max(0,Math.min(ny,window.innerHeight-50));win.style.left=nx+"px";win.style.top=ny+"px";win.style.bottom="auto";win.style.right="auto";localStorage.setItem(posKey,JSON.stringify({left:nx,top:ny}));},{passive:true});
        document.addEventListener("touchend",function(){isDragging=false;});
        var toolbarBtns=document.querySelectorAll(".notepad-toolbar button[data-cmd]");toolbarBtns.forEach(function(btn){btn.addEventListener("mousedown",function(e){e.preventDefault();});btn.addEventListener("click",function(){var cmd=this.getAttribute("data-cmd");document.execCommand(cmd,false,null);editor.focus();saveContent();});});
        fontSel.addEventListener("change",function(){document.execCommand("fontSize",false,this.value);editor.focus();saveContent();});
        colorPick.addEventListener("input",function(){document.execCommand("foreColor",false,this.value);editor.focus();saveContent();});
        hlPick.addEventListener("input",function(){document.execCommand("hiliteColor",false,this.value);editor.focus();saveContent();});
        downloadBtn.addEventListener("click",function(){var text=editor.innerText||"";var blob=new Blob([text],{type:"text/plain"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="openhuman-notes.txt";a.click();URL.revokeObjectURL(a.href);});
        document.addEventListener("keydown",function(e){if(e.key==="Escape"&&win.classList.contains("open")){closeNotepad();}});
    })();
    </script>

    <!-- BACKGROUND CANVAS SCRIPT (preserved exactly) -->
    <script>
    (function(){
        var canvas = document.getElementById("bgCanvas");
        if (!canvas) return;
        var ctx = canvas.getContext("2d");
        var W, H, particles = [], mouseX = -1000, mouseY = -1000;
        var PARTICLE_COUNT = 80;
        var CONNECTION_DIST = 160;
        var MOUSE_DIST = 200;
        function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
        resize();
        window.addEventListener("resize", resize);
        document.addEventListener("mousemove", function(e) { mouseX = e.clientX; mouseY = e.clientY; });
        function Particle() { this.x = Math.random() * W; this.y = Math.random() * H; this.z = Math.random() * 1; this.vx = (Math.random() - 0.5) * 0.4; this.vy = (Math.random() - 0.5) * 0.4; this.vz = (Math.random() - 0.5) * 0.005; this.baseSize = 1.5 + Math.random() * 2; this.hue = Math.random() > 0.5 ? 264 : 187; }
        Particle.prototype.update = function() { this.x += this.vx; this.y += this.vy; this.z += this.vz; if (this.z < 0.1) { this.z = 0.1; this.vz = Math.abs(this.vz); } if (this.z > 1) { this.z = 1; this.vz = -Math.abs(this.vz); } if (this.x < 0) { this.x = 0; this.vx *= -1; } if (this.x > W) { this.x = W; this.vx *= -1; } if (this.y < 0) { this.y = 0; this.vy *= -1; } if (this.y > H) { this.y = H; this.vy *= -1; } var dx = mouseX - this.x, dy = mouseY - this.y; var dist = Math.sqrt(dx * dx + dy * dy); if (dist < MOUSE_DIST) { var force = (MOUSE_DIST - dist) / MOUSE_DIST * 0.02; this.vx -= dx * force; this.vy -= dy * force; } var speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy); if (speed > 1.5) { this.vx *= 0.98; this.vy *= 0.98; } };
        Particle.prototype.draw = function() { var s = this.baseSize * (0.5 + this.z * 0.8); var alpha = 0.2 + this.z * 0.6; ctx.beginPath(); ctx.arc(this.x, this.y, s, 0, Math.PI * 2); if (this.hue === 264) { ctx.fillStyle = "rgba(37, 99, 235, " + alpha + ")"; } else { ctx.fillStyle = "rgba(6, 182, 212, " + alpha + ")"; } ctx.fill(); if (s > 2) { ctx.beginPath(); ctx.arc(this.x, this.y, s * 3, 0, Math.PI * 2); ctx.fillStyle = (this.hue === 264) ? "rgba(37, 99, 235, " + (alpha * 0.08) + ")" : "rgba(6, 182, 212, " + (alpha * 0.08) + ")"; ctx.fill(); } };
        for (var i = 0; i < PARTICLE_COUNT; i++) { particles.push(new Particle()); }
        function drawConnections() { for (var i = 0; i < particles.length; i++) { for (var j = i + 1; j < particles.length; j++) { var a = particles[i], b = particles[j]; var dx = a.x - b.x, dy = a.y - b.y; var dist = Math.sqrt(dx * dx + dy * dy); if (dist < CONNECTION_DIST) { var alpha = (1 - dist / CONNECTION_DIST) * 0.15 * Math.min(a.z, b.z); var grad = ctx.createLinearGradient(a.x, a.y, b.x, b.y); grad.addColorStop(0, "rgba(37, 99, 235, " + alpha + ")"); grad.addColorStop(1, "rgba(6, 182, 212, " + alpha + ")"); ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.strokeStyle = grad; ctx.lineWidth = 0.5 + Math.min(a.z, b.z) * 0.8; ctx.stroke(); } } } }
        function drawMouseConnections() { if (mouseX < 0) return; for (var i = 0; i < particles.length; i++) { var p = particles[i]; var dx = mouseX - p.x, dy = mouseY - p.y; var dist = Math.sqrt(dx * dx + dy * dy); if (dist < MOUSE_DIST) { var alpha = (1 - dist / MOUSE_DIST) * 0.25; ctx.beginPath(); ctx.moveTo(mouseX, mouseY); ctx.lineTo(p.x, p.y); ctx.strokeStyle = "rgba(96, 165, 250, " + alpha + ")"; ctx.lineWidth = 0.8; ctx.stroke(); } } }
        function animate() { ctx.clearRect(0, 0, W, H); for (var i = 0; i < particles.length; i++) { particles[i].update(); } drawConnections(); drawMouseConnections(); for (var i = 0; i < particles.length; i++) { particles[i].draw(); } requestAnimationFrame(animate); }
        animate();
    })();
    </script>

    <!-- ANALYTICS, DNC, SCHEDULE, WEBHOOK, TEMPLATES, VALIDATION, EMAIL, PVM, IPHONE SCRIPTS (preserved) -->
    <script>
            // ---- Analytics ----
            var chartInstances = {};
            function loadAnalytics() {
                apiFetch("/api/analytics")
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        document.getElementById("statTotalCalls").textContent = data.total_calls;
                        document.getElementById("statSuccessRate").textContent = data.success_rate + "%";
                        document.getElementById("statTransferRate").textContent = data.transfer_rate + "%";
                        document.getElementById("statVoicemailRate").textContent = data.voicemail_rate + "%";
                        document.getElementById("statAvgRing").textContent = data.avg_ring_time + "s";
                        function renderChart(canvasId, type, labels, datasets, options) {
                            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
                            var ctx = document.getElementById(canvasId);
                            if (!ctx) return;
                            var isDark = document.documentElement.getAttribute("data-theme") !== "light";
                            var gridColor = isDark ? "rgba(255,255,255,0.06)" : "rgba(0,0,0,0.06)";
                            var textColor = isDark ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.5)";
                            var defaultOpts = { responsive: true, maintainAspectRatio: true, plugins: { legend: { labels: { color: textColor, font: { size: 11 } } } }, scales: type === "bar" || type === "line" ? { x: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: 10 } } }, y: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: 10 } }, beginAtZero: true } } : undefined };
                            chartInstances[canvasId] = new Chart(ctx, { type: type, data: { labels: labels, datasets: datasets }, options: Object.assign(defaultOpts, options || {}) });
                        }
                        var amd = data.amd_breakdown || {};
                        renderChart("chartAMD", "doughnut", Object.keys(amd), [{ data: Object.values(amd), backgroundColor: ["#1a73e8","#1e8e3e","#d93025","#f9ab00","#7b1fa2"], borderWidth: 0 }], { cutout: "65%" });
                        var hourly = data.hourly_distribution || {};
                        renderChart("chartHourly", "bar", Object.keys(hourly), [{ label: "Calls", data: Object.values(hourly), backgroundColor: "rgba(26,115,232,0.6)", borderRadius: 4 }]);
                        var daily = data.daily_volume || {};
                        renderChart("chartDaily", "line", Object.keys(daily), [{ label: "Calls", data: Object.values(daily), borderColor: "#1a73e8", backgroundColor: "rgba(26,115,232,0.1)", fill: true, tension: 0.4, pointRadius: 3 }]);
                        var hangup = data.hangup_causes || {};
                        renderChart("chartHangup", "doughnut", Object.keys(hangup), [{ data: Object.values(hangup), backgroundColor: ["#d93025","#f9ab00","#1a73e8","#1e8e3e","#7b1fa2","#F97316"], borderWidth: 0 }], { cutout: "65%" });
                    }).catch(function(e) { if (e.message === "auth") return; });
            }

            // ---- DNC List ----
            function loadDNC() {
                apiFetch("/api/dnc").then(function(r){return r.json();}).then(function(data){var list=data.dnc_list||[];var countEl=document.getElementById("dncCount");var container=document.getElementById("dncListContainer");countEl.textContent=list.length+" number"+(list.length!==1?"s":"")+" blocked";if(list.length===0){container.innerHTML='<div class="dnc-empty">No numbers on DNC list</div>';return;}var html="";list.forEach(function(n){html+='<div class="dnc-item"><span class="dnc-number">'+n+'</span><button type="button" class="dnc-remove" onclick="removeDNC(\''+n+'\')" title="Remove">&times;</button></div>';});container.innerHTML=html;}).catch(function(e){if(e.message==="auth")return;});
            }
            function addDNC(){var input=document.getElementById("dncNumberInput");var number=input.value.trim();if(!number){alert("Enter a phone number");return;}apiFetch("/api/dnc",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({number:number})}).then(function(r){return r.json();}).then(function(){input.value="";loadDNC();}).catch(function(e){if(e.message==="auth")return;});}
            function removeDNC(number){apiFetch("/api/dnc",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({number:number})}).then(function(r){return r.json();}).then(function(){loadDNC();}).catch(function(e){if(e.message==="auth")return;});}

            // ---- Campaign Scheduling ----
            function loadSchedules(){apiFetch("/api/schedules").then(function(r){return r.json();}).then(function(data){var list=data.schedules||[];var container=document.getElementById("scheduleListContainer");var active=list.filter(function(s){return s.status==="pending";});var past=list.filter(function(s){return s.status!=="pending";});if(list.length===0){container.innerHTML='<div class="schedule-empty">No scheduled campaigns</div>';return;}var html='';active.forEach(function(s){var schedTime="-";try{var d=new Date(s.scheduled_time);schedTime=d.toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})+" "+d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});}catch(e){}html+='<div class="schedule-item schedule-pending">';html+='<div class="schedule-item-header"><span class="schedule-badge badge-pending">Pending</span><span class="schedule-time">'+schedTime+'</span></div>';html+='<div class="schedule-item-detail">'+(s.total_numbers||s.numbers.length)+' numbers &bull; Transfer to '+(s.transfer_number||"-")+'</div>';html+='<button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="cancelSchedule(\''+s.id+'\')">Cancel</button>';html+='</div>';});past.slice(-5).reverse().forEach(function(s){var schedTime="-";try{var d=new Date(s.scheduled_time);schedTime=d.toLocaleDateString(undefined,{month:"short",day:"numeric"})+" "+d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});}catch(e){}var badgeCls=s.status==="executed"?"badge-executed":"badge-cancelled";var badgeText=s.status==="executed"?"Executed":"Cancelled";html+='<div class="schedule-item schedule-past">';html+='<div class="schedule-item-header"><span class="schedule-badge '+badgeCls+'">'+badgeText+'</span><span class="schedule-time">'+schedTime+'</span></div>';html+='<div class="schedule-item-detail">'+(s.total_numbers||0)+' numbers</div>';html+='</div>';});container.innerHTML=html;}).catch(function(e){if(e.message==="auth")return;});}
            function createSchedule(){var timeInput=document.getElementById("scheduleTime");var transferInput=document.getElementById("scheduleTransfer");var numbersInput=document.getElementById("scheduleNumbers");if(!timeInput.value||!transferInput.value.trim()||!numbersInput.value.trim()){alert("Please fill in all fields.");return;}var localDate=new Date(timeInput.value);var utcISO=localDate.toISOString().replace("Z","").split(".")[0];apiFetch("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({scheduled_time:utcISO,transfer_number:transferInput.value.trim(),numbers:numbersInput.value.trim(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"})}).then(function(r){return r.json();}).then(function(data){if(data.error){alert(data.error);return;}timeInput.value="";numbersInput.value="";loadSchedules();}).catch(function(e){if(e.message==="auth")return;});}
            function cancelSchedule(id){apiFetch("/api/schedules/"+id+"/cancel",{method:"POST"}).then(function(r){return r.json();}).then(function(){loadSchedules();}).catch(function(e){if(e.message==="auth")return;});}

            // ---- Webhook Status Monitor ----
            var batteryAnimFrame=null;var currentBatteryLevel=0;var targetBatteryLevel=0;
            function animateBattery(){if(Math.abs(currentBatteryLevel-targetBatteryLevel)>0.5){currentBatteryLevel+=(targetBatteryLevel-currentBatteryLevel)*0.04;updateBatteryVisual(Math.round(currentBatteryLevel));batteryAnimFrame=requestAnimationFrame(animateBattery);}else{currentBatteryLevel=targetBatteryLevel;updateBatteryVisual(targetBatteryLevel);}}
            function updateBatteryVisual(pct){var fill=document.getElementById("batteryFill");var percentEl=document.getElementById("batteryPercent");var glow=document.getElementById("batteryGlow");var bolt=document.getElementById("batteryBolt");var label=document.getElementById("batteryLabel");var hero=document.getElementById("webhookBatteryHero");if(!fill)return;fill.style.height=pct+"%";percentEl.textContent=Math.round(pct)+"%";var color,glowColor,statusText;if(pct>=80){color="#1e8e3e";glowColor="rgba(30,142,62,0.4)";statusText="Fully Charged";hero.className="battery-hero battery-charging";bolt.style.display="flex";}else if(pct>=20){color="#f9ab00";glowColor="rgba(249,171,0,0.3)";statusText="Warning";hero.className="battery-hero";bolt.style.display="none";}else{color="#d93025";glowColor="rgba(217,48,37,0.3)";statusText="No Data";hero.className="battery-hero battery-low";bolt.style.display="none";}fill.style.background="linear-gradient(0deg, "+color+" 0%, "+color+"cc 100%)";glow.style.boxShadow="0 0 30px "+glowColor+", 0 0 60px "+glowColor;label.textContent=statusText;label.style.color=color;}
            function loadWebhookStatus(){apiFetch("/api/webhook-status").then(function(r){return r.json();}).then(function(data){document.getElementById("webhookTotal").textContent=data.total_received;document.getElementById("webhookLastTime").textContent=data.last_received_ago||"Never";document.getElementById("webhookLastEvent").textContent=(data.last_event_type||"-").replace("call.","");if(data.health==="healthy"){targetBatteryLevel=100;}else if(data.health==="warning"){targetBatteryLevel=40;}else{targetBatteryLevel=0;}if(batteryAnimFrame)cancelAnimationFrame(batteryAnimFrame);batteryAnimFrame=requestAnimationFrame(animateBattery);var evtHtml="";var evtKeys=Object.keys(data.events_by_type||{}).sort(function(a,b){return(data.events_by_type[b]||0)-(data.events_by_type[a]||0);});evtKeys.forEach(function(k){evtHtml+='<div class="webhook-event-pill"><span class="webhook-event-name">'+k.replace("call.","")+'</span><span class="webhook-event-count">'+data.events_by_type[k]+'</span></div>';});document.getElementById("webhookEventTypes").innerHTML=evtHtml||'<div class="webhook-empty">No events yet</div>';var recentHtml="";(data.recent_events||[]).slice(-15).reverse().forEach(function(evt){var t="-";try{var d=new Date(evt.time);t=d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit",second:"2-digit"});}catch(e){}var cls=evt.success?"evt-success":"evt-error";recentHtml+='<div class="webhook-recent-item '+cls+'"><span class="webhook-recent-time">'+t+'</span><span class="webhook-recent-event">'+(evt.event||"").replace("call.","")+'</span>';if(evt.call_id)recentHtml+='<span class="webhook-recent-callid">'+evt.call_id+'</span>';recentHtml+='</div>';});document.getElementById("webhookRecentEvents").innerHTML=recentHtml||'<div class="webhook-empty">No recent events</div>';var errors=data.errors||[];var errTitle=document.getElementById("webhookErrorsTitle");if(errors.length>0){errTitle.style.display="";var errHtml="";errors.slice(-5).reverse().forEach(function(err){var t="-";try{var d=new Date(err.time);t=d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});}catch(e){}errHtml+='<div class="webhook-error-item"><span class="webhook-error-time">'+t+'</span><span class="webhook-error-msg">'+(err.error||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")+'</span></div>';});document.getElementById("webhookErrors").innerHTML=errHtml;}else{errTitle.style.display="none";document.getElementById("webhookErrors").innerHTML="";}}).catch(function(e){if(e.message==="auth")return;});}

            // ---- Campaign Templates ----
            function loadTemplates(){apiFetch("/api/templates").then(function(r){return r.json();}).then(function(data){var list=data.templates||[];var container=document.getElementById("templateListContainer");if(list.length===0){container.innerHTML='<div class="template-empty">No saved templates</div>';return;}var html="";list.forEach(function(t){var created="-";try{var d=new Date(t.created_at);created=d.toLocaleDateString(undefined,{month:"short",day:"numeric"});}catch(e){}html+='<div class="template-item">';html+='<div class="template-item-header"><span class="template-name">'+(t.name||"Untitled").replace(/&/g,"&amp;").replace(/</g,"&lt;")+'</span><span class="template-date">'+created+'</span></div>';html+='<div class="template-item-detail">';html+='<span>Mode: '+(t.dial_mode||"sequential")+'</span>';if(t.transfer_number)html+=' &bull; <span>Transfer: '+t.transfer_number+'</span>';if(t.dial_mode==="simultaneous")html+=' &bull; <span>Batch: '+(t.batch_size||5)+'</span>';else html+=' &bull; <span>Delay: '+(t.dial_delay||2)+'min</span>';html+='</div>';html+='<div class="template-actions">';html+='<button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="loadTemplate(\''+t.id+'\')">Load</button>';html+='<button type="button" class="gads-btn gads-btn-outline gads-btn-sm" onclick="deleteTemplate(\''+t.id+'\')">Delete</button>';html+='</div></div>';});container.innerHTML=html;}).catch(function(e){if(e.message==="auth")return;});}
            function saveTemplate(){var nameInput=document.getElementById("templateName");var name=nameInput.value.trim();if(!name){alert("Enter a template name");return;}var data={name:name,transfer_number:document.getElementById("transferNumber").value,dial_mode:document.getElementById("dialModeInput").value,batch_size:parseInt(document.getElementById("batchSize").value),dial_delay:parseInt(document.getElementById("dialDelay").value)};apiFetch("/api/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then(function(r){return r.json();}).then(function(d){if(d.error){alert(d.error);return;}nameInput.value="";loadTemplates();showToast("Template saved","success");}).catch(function(e){if(e.message==="auth")return;});}
            function loadTemplate(id){apiFetch("/api/templates/"+id).then(function(r){return r.json();}).then(function(t){if(t.transfer_number)document.getElementById("transferNumber").value=t.transfer_number;if(t.dial_mode)setDialMode(t.dial_mode);if(t.batch_size)document.getElementById("batchSize").value=t.batch_size;if(t.dial_delay)document.getElementById("dialDelay").value=t.dial_delay;showToast("Template loaded","success");navigateTo("campaigns");openWizard();wizardGoToStep(4);}).catch(function(e){if(e.message==="auth")return;});}
            function deleteTemplate(id){if(!confirm("Delete this template?"))return;apiFetch("/api/templates/"+id,{method:"DELETE"}).then(function(r){return r.json();}).then(function(){loadTemplates();}).catch(function(e){if(e.message==="auth")return;});}

            // ---- Number Validation ----
            function validateNumbers(){var input=document.getElementById("validateNumbersInput");var numbers=input.value.trim();if(!numbers){alert("Enter phone numbers to validate");return;}apiFetch("/api/validate_numbers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({numbers:numbers})}).then(function(r){return r.json();}).then(function(data){var resultsDiv=document.getElementById("validationResults");var summaryDiv=document.getElementById("validationSummary");var detailsDiv=document.getElementById("validationDetails");resultsDiv.style.display="";var valid=data.results?data.results.filter(function(r){return r.valid;}).length:0;var invalid=data.results?data.results.filter(function(r){return!r.valid;}).length:0;summaryDiv.innerHTML='<span style="color:var(--gads-success);">'+valid+' valid</span> &bull; <span style="color:var(--gads-error);">'+invalid+' invalid</span>';var html="";(data.results||[]).forEach(function(r){var cls=r.valid?"validation-valid":"validation-invalid";html+='<div class="'+cls+'"><span class="validation-number">'+r.number+'</span><span class="validation-status">'+(r.valid?"Valid":"Invalid: "+(r.reason||""))+'</span></div>';});detailsDiv.innerHTML=html;}).catch(function(e){if(e.message==="auth")return;});}

            // ---- Email Reports ----
            function loadReportSettings(){apiFetch("/api/report-settings").then(function(r){return r.json();}).then(function(data){document.getElementById("reportEnabled").checked=!!data.enabled;document.getElementById("reportEmail").value=data.email||"";document.getElementById("reportSendTime").value=data.send_time||"08:00";document.getElementById("reportLastSent").textContent="Last sent: "+(data.last_sent||"Never");var knob=document.getElementById("reportToggleKnob");var bg=knob.previousElementSibling;if(data.enabled){knob.style.transform="translateX(20px)";bg.style.background="var(--gads-primary)";}else{knob.style.transform="";bg.style.background="";}}).catch(function(e){if(e.message==="auth")return;});}
            function saveReportSettings(){var data={enabled:document.getElementById("reportEnabled").checked,email:document.getElementById("reportEmail").value,send_time:document.getElementById("reportSendTime").value};var knob=document.getElementById("reportToggleKnob");var bg=knob.previousElementSibling;if(data.enabled){knob.style.transform="translateX(20px)";bg.style.background="var(--gads-primary)";}else{knob.style.transform="";bg.style.background="";}apiFetch("/api/report-settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then(function(r){return r.json();}).then(function(d){if(d.error){showToast(d.error,"error");}}).catch(function(e){if(e.message==="auth")return;});}
            function sendTestReport(){var btn=document.getElementById("testReportBtn");btn.disabled=true;btn.textContent="Sending...";apiFetch("/api/send-test-report",{method:"POST"}).then(function(r){return r.json();}).then(function(d){btn.disabled=false;btn.textContent="Send Test Report";var msg=document.getElementById("reportMessage");msg.style.display="";if(d.error){msg.style.background="rgba(217,48,37,0.1)";msg.style.color="var(--gads-error)";msg.textContent=d.error;}else{msg.style.background="rgba(30,142,62,0.1)";msg.style.color="var(--gads-success)";msg.textContent=d.message||"Test report sent!";setTimeout(function(){msg.style.display="none";},5000);}}).catch(function(e){btn.disabled=false;btn.textContent="Send Test Report";if(e.message==="auth")return;});}
            function checkGmailStatus(){apiFetch("/api/gmail-status").then(function(r){return r.json();}).then(function(d){var dot=document.getElementById("gmailStatusDot");var txt=document.getElementById("gmailStatusText");if(d.connected){dot.style.background="#1e8e3e";txt.textContent="Gmail connected";}else{dot.style.background="#d93025";txt.textContent=d.message||"Gmail not connected";}}).catch(function(e){if(e.message==="auth")return;});}

            // ---- PVM ----
            var pvmContacts=[];var pvmFields=[];var pvmGenInterval=null;
            function pvmInit(){pvmLoadVoices();}
            function pvmLoadVoices(){apiFetch("/api/pvm/voices").then(function(r){return r.json();}).then(function(data){var sel=document.getElementById("pvmVoiceSelect");var html='';(data.voices||[]).forEach(function(v){html+='<option value="'+v.voice_id+'">'+v.name+(v.category?' ('+v.category+')':'')+'</option>';});sel.innerHTML=html||'<option value="">No voices available</option>';}).catch(function(e){if(e.message==="auth")return;});}
            function pvmParseCSV(){var fileInput=document.getElementById("pvmCsvFile");if(!fileInput.files.length)return;var file=fileInput.files[0];document.getElementById("pvmFileName").textContent=file.name;var formData=new FormData();formData.append("csv_file",file);apiFetch("/api/pvm/parse",{method:"POST",body:formData}).then(function(r){return r.json();}).then(function(data){if(data.error){alert(data.error);return;}pvmContacts=data.contacts||[];pvmFields=data.fields||[];var statsHtml='<div class="pvm-stat-row">';statsHtml+='<div class="pvm-stat"><span class="pvm-stat-num">'+data.total+'</span><span class="pvm-stat-lbl">Contacts</span></div>';statsHtml+='<div class="pvm-stat"><span class="pvm-stat-num">'+pvmFields.length+'</span><span class="pvm-stat-lbl">Fields</span></div>';if(data.errors.length>0){statsHtml+='<div class="pvm-stat pvm-stat-warn"><span class="pvm-stat-num">'+data.errors.length+'</span><span class="pvm-stat-lbl">Warnings</span></div>';}statsHtml+='</div>';document.getElementById("pvmCsvStats").innerHTML=statsHtml;var previewHtml='<table class="pvm-preview-table"><tr>';var showFields=pvmFields.slice(0,7);showFields.forEach(function(f){previewHtml+='<th>'+f+'</th>';});previewHtml+='</tr>';pvmContacts.slice(0,3).forEach(function(c){previewHtml+='<tr>';showFields.forEach(function(f){previewHtml+='<td>'+(c[f]||'-')+'</td>';});previewHtml+='</tr>';});if(pvmContacts.length>3)previewHtml+='<tr><td colspan="'+showFields.length+'" style="text-align:center;opacity:0.6;">... and '+(pvmContacts.length-3)+' more</td></tr>';previewHtml+='</table>';document.getElementById("pvmCsvPreview").innerHTML=previewHtml;document.getElementById("pvmCsvResult").style.display="";var placeholderHtml='';pvmFields.forEach(function(f){placeholderHtml+='<span class="pvm-placeholder-tag" onclick="pvmInsertPlaceholder(\''+f+'\')">{'+ f+'}</span>';});document.getElementById("pvmPlaceholders").innerHTML=placeholderHtml;pvmPopulateContactSelectors();document.getElementById("pvmLivePreviewSection").style.display="";document.getElementById("pvmContactSelector").style.display="";pvmUpdateCostEstimate();}).catch(function(e){if(e.message==="auth")return;alert("Failed to parse CSV");});}
            function pvmPopulateContactSelectors(){var html='';pvmContacts.forEach(function(c,i){var label=(c.first_name||c.name||'')+' '+(c.last_name||'');label=label.trim()||c.phone||('Contact '+(i+1));html+='<option value="'+i+'">'+label+' ('+(c.phone||'')+')</option>';});document.getElementById("pvmPreviewContact").innerHTML=html;document.getElementById("pvmLivePreviewContact").innerHTML=html;}
            function pvmUpdateSlider(name){var slider=document.getElementById("pvm"+name);var valEl=document.getElementById("pvm"+name+"Val");valEl.textContent=(slider.value/100).toFixed(2);}
            function pvmGetVoiceSettings(){return{stability:parseInt(document.getElementById("pvmStability").value)/100,similarity_boost:parseInt(document.getElementById("pvmSimilarity").value)/100,style:parseInt(document.getElementById("pvmStyle").value)/100,speed:parseInt(document.getElementById("pvmSpeed").value)/100,use_speaker_boost:document.getElementById("pvmSpeakerBoost").checked};}
            function pvmGetModelId(){return document.getElementById("pvmModel").value;}
            function pvmGetHumanize(){return document.getElementById("pvmHumanize").checked;}
            function pvmUpdateCharCount(){var text=document.getElementById("pvmTemplate").value;var charCount=text.length;document.getElementById("pvmCharCount").textContent=charCount+" characters";var estSeconds=Math.ceil(charCount/15);document.getElementById("pvmEstDuration").textContent="~"+estSeconds+"s audio";pvmUpdateCostEstimate();}
            function pvmUpdateCostEstimate(){var text=document.getElementById("pvmTemplate").value;var charCount=text.length;var costEl=document.getElementById("pvmCostEstimate");if(pvmContacts.length>0&&charCount>0){var totalChars=charCount*pvmContacts.length;var cost=(totalChars/1000)*0.30;document.getElementById("pvmCostText").textContent="Estimated cost: ~$"+cost.toFixed(2)+" for "+pvmContacts.length+" voicemails ("+totalChars.toLocaleString()+" chars)";costEl.style.display="";}else{costEl.style.display="none";}}
            function pvmDownloadSample(){var csv="First name,Last name,email,phone,address,amount,date\n";csv+="John,Smith,john@example.com,+15551234567,123 Main St,$500.00,2026-01-15\n";csv+="Jane,Doe,jane@example.com,+15559876543,456 Oak Ave,$750.00,2026-02-01\n";csv+="Bob,Johnson,bob@example.com,+15551112222,789 Pine Rd,$1200.00,2026-01-28\n";var blob=new Blob([csv],{type:"text/csv"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="sample_contacts.csv";a.click();URL.revokeObjectURL(url);}
            function pvmLivePreview(){var template=document.getElementById("pvmTemplate").value;var voiceId=document.getElementById("pvmVoiceSelect").value;var contactIdx=parseInt(document.getElementById("pvmLivePreviewContact").value)||0;if(!template){alert("Please write a voicemail script first");return;}if(!voiceId){alert("Please select a voice first");return;}if(pvmContacts.length===0){alert("Please upload a CSV first");return;}var contact=pvmContacts[contactIdx];document.getElementById("pvmLivePreviewBtn").disabled=true;document.getElementById("pvmLivePreviewStatus").style.display="";document.getElementById("pvmLivePreviewPlayer").style.display="none";apiFetch("/api/pvm/preview-audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template:template,contact:contact,voice_id:voiceId,voice_settings:pvmGetVoiceSettings(),humanize:pvmGetHumanize(),model_id:pvmGetModelId()})}).then(function(r){return r.json();}).then(function(data){document.getElementById("pvmLivePreviewBtn").disabled=false;document.getElementById("pvmLivePreviewStatus").style.display="none";if(data.error){alert("Preview failed: "+data.error);return;}var audio=document.getElementById("pvmPreviewAudio");audio.src=data.audio_url;document.getElementById("pvmPreviewScriptText").innerHTML='<strong>Script:</strong> '+(data.script||'').replace(/\n/g,'<br>');document.getElementById("pvmLivePreviewPlayer").style.display="";audio.play();if(typeof showToast==='function')showToast("Voice preview ready!","success");}).catch(function(e){document.getElementById("pvmLivePreviewBtn").disabled=false;document.getElementById("pvmLivePreviewStatus").style.display="none";if(e.message==="auth")return;alert("Failed to generate voice preview");});}
            function pvmInsertPlaceholder(field){var ta=document.getElementById("pvmTemplate");var start=ta.selectionStart;var end=ta.selectionEnd;var text=ta.value;var insert="{"+field+"}";ta.value=text.substring(0,start)+insert+text.substring(end);ta.focus();ta.selectionStart=ta.selectionEnd=start+insert.length;}
            function pvmPreview(){var template=document.getElementById("pvmTemplate").value;if(!template){alert("Please write a template first");return;}if(pvmContacts.length===0){alert("Please upload a CSV first");return;}var contactIdx=parseInt(document.getElementById("pvmPreviewContact").value)||0;var contact=pvmContacts[contactIdx];var contactName=(contact.first_name||contact.name||'')+' '+(contact.last_name||'');contactName=contactName.trim()||'Contact '+(contactIdx+1);apiFetch("/api/pvm/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template:template,contact:contact,humanize:pvmGetHumanize()})}).then(function(r){return r.json();}).then(function(data){var box=document.getElementById("pvmPreviewResult");box.style.display="";box.innerHTML='<strong>Preview for '+contactName+':</strong><p>'+(data.rendered||"").replace(/\n/g,'<br>')+'</p>';}).catch(function(e){if(e.message==="auth")return;});}
            function pvmGenerate(){var template=document.getElementById("pvmTemplate").value;var voiceId=document.getElementById("pvmVoiceSelect").value;if(!template){alert("Please write a template first");return;}if(!voiceId){alert("Please select a voice");return;}if(pvmContacts.length===0){alert("Please upload a CSV first");return;}document.getElementById("pvmGenerateBtn").disabled=true;document.getElementById("pvmProgress").style.display="";document.getElementById("pvmErrors").style.display="none";apiFetch("/api/pvm/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contacts:pvmContacts,template:template,voice_id:voiceId,voice_settings:pvmGetVoiceSettings(),humanize:pvmGetHumanize(),model_id:pvmGetModelId()})}).then(function(r){return r.json();}).then(function(data){if(data.error){alert(data.error);document.getElementById("pvmGenerateBtn").disabled=false;return;}pvmGenInterval=setInterval(pvmPollProgress,2000);}).catch(function(e){if(e.message==="auth")return;document.getElementById("pvmGenerateBtn").disabled=false;alert("Failed to start generation");});}
            function pvmPollProgress(){apiFetch("/api/pvm/status").then(function(r){return r.json();}).then(function(data){var pct=data.total>0?Math.round((data.completed/data.total)*100):0;document.getElementById("pvmProgressFill").style.width=pct+"%";document.getElementById("pvmProgressText").textContent="Generating... "+data.completed+"/"+data.total;if(data.errors&&data.errors.length>0){var errDiv=document.getElementById("pvmErrors");errDiv.style.display="";errDiv.innerHTML='<strong>Errors:</strong><br>'+data.errors.map(function(e){return'<span class="pvm-error-item">'+e+'</span>';}).join('<br>');}if(data.status==="complete"||data.status==="error"){clearInterval(pvmGenInterval);document.getElementById("pvmGenerateBtn").disabled=false;if(data.status==="complete"){document.getElementById("pvmProgressText").textContent="Complete! "+data.completed+"/"+data.total+" voicemails generated";document.getElementById("pvmStep4").style.display="";document.getElementById("pvmReadyStats").innerHTML='<span class="pvm-ready-count">'+data.completed+'</span> personalized voicemails ready to go';}}}).catch(function(){});}
            function pvmLoadToDialer(){apiFetch("/api/pvm/audio-map").then(function(r){return r.json();}).then(function(data){var phones=Object.keys(data.audio_map||{});if(phones.length===0){alert("No personalized voicemails found.");return;}var numbersField=document.getElementById("numbersInput");if(numbersField){numbersField.value=phones.join("\n");}alert(phones.length+" phone numbers loaded into the dialer!");}).catch(function(e){if(e.message==="auth")return;});}
            function pvmClearAll(){if(!confirm("Delete all generated personalized voicemail audio files?"))return;apiFetch("/api/pvm/clear",{method:"POST"}).then(function(r){return r.json();}).then(function(){document.getElementById("pvmStep4").style.display="none";document.getElementById("pvmProgress").style.display="none";document.getElementById("pvmErrors").style.display="none";pvmContacts=[];pvmFields=[];alert("All personalized audio cleared");}).catch(function(e){if(e.message==="auth")return;});}

            // ---- iPhone Live Dialer ----
            var iphoneDragging=false;var iphoneOffX=0,iphoneOffY=0;var iphoneCallTimerInterval=null;var iphoneCallStart=null;var iphoneLogHistory=[];var iphonePrevCallId=null;var iphoneRotating=false;var iphoneRotStartX=0;var iphoneRotCurrentY=0;var iphoneRotVelocity=0;var iphoneRotLastX=0;var iphoneRotLastTime=0;var iphoneRotMomentumId=null;
            (function(){var dialer=document.getElementById("iphoneDialer");var handle=document.getElementById("iphoneDragHandle");var body3d=document.getElementById("iphone3dBody");var backFace=document.getElementById("iphoneBack");if(!handle||!dialer||!body3d)return;function updateIphoneTime(){var now=new Date();var h=now.getHours();var m=now.getMinutes();var el=document.getElementById("iphoneTime");if(el)el.textContent=h+":"+(m<10?"0":"")+m;}updateIphoneTime();setInterval(updateIphoneTime,30000);handle.addEventListener("mousedown",function(e){e.preventDefault();iphoneDragging=true;var rect=dialer.getBoundingClientRect();iphoneOffX=e.clientX-rect.left;iphoneOffY=e.clientY-rect.top;dialer.classList.add("dragging");dialer.style.transition="none";});document.addEventListener("mousemove",function(e){if(iphoneDragging){var x=e.clientX-iphoneOffX;var y=e.clientY-iphoneOffY;var maxX=window.innerWidth-dialer.offsetWidth;var maxY=window.innerHeight-dialer.offsetHeight;x=Math.max(0,Math.min(x,maxX));y=Math.max(0,Math.min(y,maxY));dialer.style.left=x+"px";dialer.style.top=y+"px";dialer.style.right="auto";dialer.style.bottom="auto";}if(iphoneRotating){var now=Date.now();var dx=e.clientX-iphoneRotStartX;iphoneRotVelocity=(e.clientX-iphoneRotLastX)/Math.max(1,now-iphoneRotLastTime);iphoneRotLastX=e.clientX;iphoneRotLastTime=now;iphoneRotCurrentY=dx*0.8;body3d.style.transform="rotateY("+iphoneRotCurrentY+"deg)";}});document.addEventListener("mouseup",function(){if(iphoneDragging){iphoneDragging=false;dialer.classList.remove("dragging");dialer.style.transition="";}if(iphoneRotating){iphoneRotating=false;dialer.classList.remove("rotating");var vel=iphoneRotVelocity*100;var currentAngle=iphoneRotCurrentY+vel;var normalized=((currentAngle%360)+360)%360;var snapAngle=normalized<90||normalized>270?0:180;body3d.style.transition="transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)";body3d.style.transform="rotateY("+snapAngle+"deg)";setTimeout(function(){body3d.style.transition="";body3d.style.transform="";iphoneRotCurrentY=0;},650);}});body3d.addEventListener("mousedown",function(e){if(e.altKey&&!iphoneMinimized){e.preventDefault();e.stopPropagation();iphoneRotating=true;iphoneRotStartX=e.clientX;iphoneRotLastX=e.clientX;iphoneRotLastTime=Date.now();iphoneRotVelocity=0;dialer.classList.add("rotating");body3d.style.transition="none";}});if(backFace){backFace.addEventListener("click",function(e){if(iphoneMinimized){e.stopPropagation();iphoneToggleMinimize();}});}handle.addEventListener("touchstart",function(e){e.preventDefault();iphoneDragging=true;var touch=e.touches[0];var rect=dialer.getBoundingClientRect();iphoneOffX=touch.clientX-rect.left;iphoneOffY=touch.clientY-rect.top;dialer.classList.add("dragging");dialer.style.transition="none";},{passive:false});document.addEventListener("touchmove",function(e){if(!iphoneDragging)return;var touch=e.touches[0];var x=touch.clientX-iphoneOffX;var y=touch.clientY-iphoneOffY;var maxX=window.innerWidth-dialer.offsetWidth;var maxY=window.innerHeight-dialer.offsetHeight;x=Math.max(0,Math.min(x,maxX));y=Math.max(0,Math.min(y,maxY));dialer.style.left=x+"px";dialer.style.top=y+"px";dialer.style.right="auto";dialer.style.bottom="auto";},{passive:false});document.addEventListener("touchend",function(){if(iphoneDragging){iphoneDragging=false;dialer.classList.remove("dragging");dialer.style.transition="";}});})();
            var iphoneMinimized=false;var hotleadShownIds={};var hotleadAutoMinTimer=null;var hotleadAnimating=false;
            function iphoneToggleMinimize(){var dialer=document.getElementById("iphoneDialer");var iFab=document.getElementById("iphoneFab");iphoneMinimized=!iphoneMinimized;if(iphoneMinimized){dialer.classList.remove("hotlead-expand");dialer.style.display="none";iFab.classList.add("visible");if(typeof ballsStartIphone==="function")ballsStartIphone();}else{dialer.style.display="";dialer.classList.remove("hotlead-expand","hotlead-collapse");iFab.classList.remove("visible","floating");if(typeof ballsStopIphone==="function")ballsStopIphone();}}
            function hotleadDismiss(){var dialer=document.getElementById("iphoneDialer");var hlScreen=document.getElementById("iphoneHotLeadScreen");hlScreen.style.display="none";dialer.classList.remove("hotlead-expand");dialer.classList.add("hotlead-collapse");hotleadAnimating=false;if(hotleadAutoMinTimer){clearTimeout(hotleadAutoMinTimer);hotleadAutoMinTimer=null;}setTimeout(function(){dialer.classList.remove("hotlead-collapse");dialer.style.display="none";iphoneMinimized=true;var iFab=document.getElementById("iphoneFab");iFab.classList.add("visible");if(typeof ballsStartIphone==="function")ballsStartIphone();},400);}
            function iphoneUpdateDialer(calls){if(!calls||calls.length===0)return;var liveStatuses=["initiated","ringing","test_call_ringing","answered","human_detected","machine_detected","voicemail_playing","transferred","connected"];var liveCall=null;for(var i=0;i<calls.length;i++){if(liveStatuses.indexOf(calls[i].status)!==-1){liveCall=calls[i];break;}}var idleScreen=document.getElementById("iphoneIdleScreen");var callScreen=document.getElementById("iphoneCallScreen");var hlScreen=document.getElementById("iphoneHotLeadScreen");if(liveCall&&liveCall.transferred&&!hotleadShownIds[liveCall.call_id||liveCall.number]){hotleadShownIds[liveCall.call_id||liveCall.number]=true;callScreen.style.display="none";idleScreen.style.display="none";hlScreen.style.display="";document.getElementById("hotleadNumber").textContent=liveCall.number||"Unknown";var dialer=document.getElementById("iphoneDialer");if(iphoneMinimized){iphoneMinimized=false;dialer.style.display="";var iFab=document.getElementById("iphoneFab");iFab.classList.remove("visible","floating");if(typeof ballsStopIphone==="function")ballsStopIphone();}dialer.classList.remove("hotlead-collapse");dialer.classList.add("hotlead-expand");hotleadAnimating=true;playHotLeadSound();if(hotleadAutoMinTimer)clearTimeout(hotleadAutoMinTimer);hotleadAutoMinTimer=setTimeout(function(){hotleadDismiss();},8000);}else if(liveCall){idleScreen.style.display="none";callScreen.style.display="";hlScreen.style.display="none";document.getElementById("iphoneCallNumber").textContent=liveCall.number||"";var statusText=liveCall.status_description||formatStatus(liveCall.status);document.getElementById("iphoneCallStatusText").textContent=statusText;document.getElementById("iphoneCallLabel").textContent=liveCall.status==="initiated"?"calling...":"on call";var badge=document.getElementById("iphoneCallBadge");var colorMap={green:"#30D158",red:"#FF453A",yellow:"#FFD60A",blue:"#0A84FF"};badge.style.background=colorMap[liveCall.status_color]||"#0A84FF";var amdDiv=document.getElementById("iphoneCallAmd");if(liveCall.machine_detected!==null){amdDiv.style.display="";document.getElementById("iphoneAmdIcon").textContent=liveCall.machine_detected?"&#129302;":"&#128100;";document.getElementById("iphoneAmdText").textContent=liveCall.machine_detected?"Machine Detected":"Human Detected";}else{amdDiv.style.display="none";}var trDiv=document.getElementById("iphoneCallTranscript");if(liveCall.transcript&&liveCall.transcript.length>0){trDiv.style.display="";var trHtml="";liveCall.transcript.slice(-3).forEach(function(t){var speaker=t.track==="outbound"?"Agent":"Caller";trHtml+='<div class="iphone-tr-line"><strong>'+speaker+':</strong> '+((t.text||"").replace(/&/g,"&amp;").replace(/</g,"&lt;"))+'</div>';});document.getElementById("iphoneTranscriptContent").innerHTML=trHtml;}else{trDiv.style.display="none";}if(liveCall.call_id!==iphonePrevCallId){iphonePrevCallId=liveCall.call_id;iphoneCallStart=Date.now();if(iphoneCallTimerInterval)clearInterval(iphoneCallTimerInterval);iphoneCallTimerInterval=setInterval(function(){var elapsed=Math.floor((Date.now()-iphoneCallStart)/1000);var mm=String(Math.floor(elapsed/60)).padStart(2,"0");var ss=String(elapsed%60).padStart(2,"0");document.getElementById("iphoneCallTimer").textContent=mm+":"+ss;},1000);}}else{callScreen.style.display="none";hlScreen.style.display="none";idleScreen.style.display="";if(iphoneCallTimerInterval){clearInterval(iphoneCallTimerInterval);iphoneCallTimerInterval=null;}}var logEntries=document.getElementById("iphoneLogEntries");var recent=calls.slice(0,5);var logHtml="";recent.forEach(function(c){var ts="-";if(c.timestamp){try{var d=new Date(c.timestamp);ts=d.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});}catch(e){}}var icon=c.transferred?"&#128293;":c.voicemail_dropped?"&#128232;":"&#128222;";logHtml+='<div class="iphone-log-entry"><span class="iphone-log-icon">'+icon+'</span><span class="iphone-log-number">'+(c.number||"-")+'</span><span class="iphone-log-time">'+ts+'</span></div>';});logEntries.innerHTML=logHtml;}
    </script>

</body>
</html>
